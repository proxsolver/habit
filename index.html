<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>가족 루틴 트래커</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <!-- 로그인 페이지 -->
        <div id="loginPage" class="login-page">
            <div class="login-form">
                <h1 class="app-title">🌅 루틴 트래커</h1>
                
                <!-- 역할 선택 -->
                <div class="role-selector">
                    <div class="role-btn active" onclick="selectRole('parent')">👨‍👩‍👧‍👦 부모</div>
                    <div class="role-btn" onclick="selectRole('child')">👶 자녀</div>
                </div>

                <!-- 가족 코드 입력 (자녀용) -->
                <div id="familyCodeInput" class="input-group family-code-input">
                    <label for="familyCode">가족 코드</label>
                    <input type="text" id="familyCode" placeholder="가족 코드를 입력하세요">
                </div>

                <!-- Google 로그인 버튼 -->
                <button class="btn google-btn" onclick="signInWithGoogle()">
                    <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google" class="google-icon">
                    Google로 시작하기
                </button>

                <!-- 구분선 -->
                <div class="divider">
                    <span>또는</span>
                </div>

                <!-- 이메일/비밀번호 로그인 (선택사항) -->
                <div class="email-login-section collapsed" id="emailLoginSection">
                    <div class="input-group">
                        <label for="email">이메일</label>
                        <input type="email" id="email" placeholder="your@email.com">
                    </div>
                    <div class="input-group">
                        <label for="password">비밀번호</label>
                        <input type="password" id="password" placeholder="비밀번호 입력">
                    </div>
                    <button class="btn" id="loginBtn" onclick="handleAuth('login')">로그인</button>
                    <button class="btn btn-secondary" onclick="handleAuth('register')">회원가입</button>
                </div>

                <button class="btn-text" onclick="toggleEmailLogin()">이메일로 로그인</button>

                <!-- 가족 코드 표시 (부모용 회원가입 후) -->
                <div id="familyCodeDisplay" class="family-code-display hidden">
                    <div>가족 코드</div>
                    <div class="family-code" id="generatedFamilyCode"></div>
                    <div style="font-size: 12px; margin-top: 10px; color: #666;">
                        자녀에게 이 코드를 알려주세요
                    </div>
                </div>
            </div>
        </div>

        <!-- 메인 앱 -->
        <div id="mainApp" class="main-app">
            <!-- 헤더 -->
            <div class="header">
                <div class="user-info">
                    <span id="userEmail"></span>
                    <span class="user-role" id="userRole"></span>
                    <button class="logout-btn" onclick="logout()">로그아웃</button>
                </div>
                <h1>오늘의 루틴</h1>
                <div id="currentDate"></div>
            </div>

            <!-- 메인 페이지 -->
            <div id="homePage" class="page">
                <!-- 수면 정보 -->
                <div class="sleep-info">
                    <div class="sleep-hours" id="sleepHours">-</div>
                    <div>어젯밤 수면시간</div>
                </div>

                <!-- 오늘의 명언 -->
                <div class="quote" id="dailyQuote">
                    "성공은 매일의 작은 노력들이 쌓여서 만들어진다."
                </div>

                <!-- 루틴 목록 -->
                <div class="routine-list" id="routineList">
                    <!-- 루틴 아이템들이 여기에 동적으로 추가됩니다 -->
                </div>
            </div>

            <!-- 가족 페이지 -->
            <div id="familyPage" class="page family-page">
                <div class="page-title">가족 루틴 현황</div>
                <div id="familyMembers" class="family-members">
                    <!-- 가족 구성원들의 루틴 현황 -->
                </div>
            </div>

            <!-- 관리 페이지 -->
            <div id="managePage" class="page manage-page">
                <div class="page-title">루틴 관리</div>
                <button class="add-routine-btn" onclick="openAddRoutineModal()">+ 새 루틴 추가</button>
                <div id="manageRoutineList">
                    <!-- 관리용 루틴 목록 -->
                </div>
            </div>

            <!-- 하단 네비게이션 -->
            <div class="bottom-nav">
                <div class="nav-item active" onclick="showPage('home')">
                    <i>🏠</i>
                    <span>홈</span>
                </div>
                <div class="nav-item" onclick="showPage('manage')">
                    <i>⚙️</i>
                    <span>관리</span>
                </div>
                <div class="nav-item" onclick="showPage('review')">
                    <i>📊</i>
                    <span>리뷰</span>
                </div>
                <div class="nav-item" onclick="showPage('stats')">
                    <i>📈</i>
                    <span>통계</span>
                </div>
                <div class="nav-item" onclick="showPage('family')">
                    <i>👨‍👩‍👧‍👦</i>
                    <span>가족</span>
                </div>
            </div>
        </div>

        <!-- 루틴 추가 모달 -->
        <div id="addRoutineModal" class="modal">
            <div class="modal-content">
                <button class="close-btn" onclick="closeModal()">&times;</button>
                <div class="modal-header">새 루틴 추가</div>
                
                <div class="form-group">
                    <label for="routineName">루틴 이름</label>
                    <input type="text" id="routineName" placeholder="루틴 이름을 입력하세요">
                </div>

                <div class="form-group">
                    <label for="routineType">루틴 타입</label>
                    <select id="routineType">
                        <option value="yesno">예/아니오</option>
                        <option value="number">숫자 입력</option>
                        <option value="time">시간 입력</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="routineTime">시점</label>
                    <select id="routineTime">
                        <option value="morning">아침</option>
                        <option value="afternoon">점심</option>
                        <option value="evening">저녁</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="routineFreq">주기</label>
                    <select id="routineFreq">
                        <option value="daily">매일</option>
                        <option value="weekday">평일</option>
                        <option value="weekend">주말</option>
                    </select>
                </div>

                <div class="btn-group">
                    <button class="btn btn-cancel" onclick="closeModal()">취소</button>
                    <button class="btn" onclick="addRoutine()">추가</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <!-- 모든 스크립트를 하나로 합치기 -->
    <script>
        // Firebase 설정
        const firebaseConfig = {
            apiKey: "AIzaSyC6bvEaHsxpLtPv5zM99PmgAwOnRXnhkBM",
            authDomain: "habit-dc62a.firebaseapp.com",
            projectId: "habit-dc62a",
            storageBucket: "habit-dc62a.firebasestorage.app",
            messagingSenderId: "668374525477",
            appId: "1:668374525477:web:ecbecd95ec631fb82cc1cc"
        };

        // 전역 변수
        let currentUser = null;
        let userRole = 'parent';
        let familyId = null;
        let routines = [];
        let familyMembers = [];
        let auth, db;

        // 기본 명언들
        const quotes = [
            "성공은 매일의 작은 노력들이 쌓여서 만들어진다.",
            "오늘 하루도 최선을 다하는 하루가 되길.",
            "작은 습관이 큰 변화를 만든다.",
            "꾸준함이 천재를 이긴다.",
            "매일 조금씩 나아지는 것이 중요하다."
        ];

        // Firebase 초기화
        function initializeFirebase() {
            try {
                console.log('🔥 Firebase 초기화 시작...');
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                
                console.log('✅ Firebase 초기화 성공!');
                console.log('🔥 Auth:', auth);
                console.log('🗃️ DB:', db);
                
                // 인증 상태 변경 감지
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        currentUser = user;
                        await loadUserProfile();
                        showMainApp();
                        startRealtimeListeners();
                    } else {
                        currentUser = null;
                        showLoginPage();
                    }
                });
                
                return true;
            } catch (error) {
                console.error('❌ Firebase 초기화 실패:', error);
                return false;
            }
        }

        // 역할 선택
        function selectRole(role) {
            userRole = role;
            document.querySelectorAll('.role-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const familyCodeInput = document.getElementById('familyCodeInput');
            if (role === 'child') {
                familyCodeInput.style.display = 'block';
            } else {
                familyCodeInput.style.display = 'none';
            }
        }

        // Google 로그인
        async function signInWithGoogle() {
            const familyCode = document.getElementById('familyCode').value;
            
            if (userRole === 'child' && !familyCode) {
                showNotification('자녀는 가족 코드를 먼저 입력해주세요.', 'error');
                return;
            }

            if (!auth) {
                showNotification('Firebase가 아직 로드되지 않았습니다. 잠시 후 다시 시도해주세요.', 'error');
                return;
            }

            setLoading(true, 'google');
            
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                provider.addScope('email');
                provider.addScope('profile');
                
                const result = await auth.signInWithPopup(provider);
                const user = result.user;
                
                // 기존 사용자인지 확인
                const userDoc = await db.collection('users').doc(user.uid).get();
                
                if (!userDoc.exists) {
                    // 새 사용자라면 프로필 생성
                    await createUserProfileFromGoogle(user, familyCode);
                    showNotification('Google 계정으로 성공적으로 가입되었습니다! 🎉');
                } else {
                    // 기존 사용자라면 로그인
                    showNotification('Google 계정으로 로그인되었습니다! 👋');
                }
                
            } catch (error) {
                console.error('Google 로그인 오류:', error);
                if (error.code === 'auth/popup-closed-by-user') {
                    showNotification('로그인이 취소되었습니다.', 'error');
                } else if (error.code === 'auth/popup-blocked') {
                    showNotification('팝업이 차단되었습니다. 팝업을 허용해주세요.', 'error');
                } else {
                    showNotification('Google 로그인에 실패했습니다.', 'error');
                }
            } finally {
                setLoading(false, 'google');
            }
        }

        // 이메일 로그인 토글
        function toggleEmailLogin() {
            const section = document.getElementById('emailLoginSection');
            const button = event.target;
            
            if (section.classList.contains('collapsed')) {
                section.classList.remove('collapsed');
                button.textContent = '간편 로그인으로 돌아가기';
            } else {
                section.classList.add('collapsed');
                button.textContent = '이메일로 로그인';
            }
        }

        // 유틸리티 함수들
        function generateFamilyCode() {
            return Math.random().toString(36).substr(2, 8).toUpperCase();
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function setLoading(loading, type = 'email') {
            if (type === 'google') {
                const googleBtn = document.querySelector('.google-btn');
                if (googleBtn) {
                    if (loading) {
                        googleBtn.disabled = true;
                        googleBtn.innerHTML = `
                            <div style="width: 20px; height: 20px; border: 2px solid #f3f3f3; border-top: 2px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                            Google 로그인 중...
                        `;
                    } else {
                        googleBtn.disabled = false;
                        googleBtn.innerHTML = `
                            <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google" class="google-icon">
                            Google로 시작하기
                        `;
                    }
                }
            }
        }

        function showLoginPage() {
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
        }

        function showMainApp() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
        }

        // 현재 날짜 업데이트
        function updateCurrentDate() {
            const today = new Date();
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                weekday: 'long'
            };
            document.getElementById('currentDate').textContent = 
                today.toLocaleDateString('ko-KR', options);
        }

        // 일일 명언 업데이트
        function updateDailyQuote() {
            const today = new Date();
            const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
            const quoteIndex = dayOfYear % quotes.length;
            document.getElementById('dailyQuote').textContent = quotes[quoteIndex];
        }

        // 임시 함수들 (기본 동작을 위해)
        async function createUserProfileFromGoogle(user, familyCode) {
            console.log('프로필 생성:', user.email);
            // 임시로 간단한 프로필 생성
        }

        async function loadUserProfile() {
            console.log('사용자 프로필 로드');
        }

        function startRealtimeListeners() {
            console.log('실시간 리스너 시작');
        }

        // DOM 로드 완료 후 Firebase 초기화
        document.addEventListener('DOMContentLoaded', function() {
            console.log('📄 DOM 로드 완료');
            updateCurrentDate();
            updateDailyQuote();
            
            // Firebase 초기화 시도
            setTimeout(() => {
                if (typeof firebase !== 'undefined') {
                    initializeFirebase();
                } else {
                    console.error('❌ Firebase SDK가 로드되지 않았습니다.');
                    setTimeout(initializeFirebase, 1000);
                }
            }, 100);
        });
    </script>
</body>
</html>