<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ê°€ì¡± ë£¨í‹´ íŠ¸ë˜ì»¤</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --primary-color: #667eea;
            --secondary-color: #4caf50;
            --danger-color: #e74c3c;
            --background-color: #f5f5f5;
            --surface-color: #ffffff;
            --text-color: #333;
            --text-secondary-color: #666;
            --border-color: #e1e4e8;
            --border-radius-lg: 15px;
            --border-radius-md: 10px;
            --shadow-sm: 0 2px 6px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
            --base-font-size: 16px;
            --scale-factor: 1;
            --touch-target-min: 44px;
        }
        html {
            font-size: var(--base-font-size);
            -webkit-text-size-adjust: none;
            text-size-adjust: none;
            scroll-behavior: smooth;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px 0 calc(80px + env(safe-area-inset-bottom)); /* Added top padding */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto;
            padding: 0 20px; /* Adjusted padding for container */
        }
        .touchable {
            min-height: var(--touch-target-min);
            min-width: var(--touch-target-min);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .page { display: none; }
        .page.active { 
            display: block; 
            animation: fadeIn 0.4s ease-out; 
        }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(15px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        .section-card {
            background: var(--surface-color);
            padding: calc(20px * var(--scale-factor));
            margin-bottom: calc(20px * var(--scale-factor));
            border-radius: var(--border-radius-lg);
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        .section-card h2 {
            margin-top: 0;
            color: var(--text-color);
            font-size: calc(1.3rem * var(--scale-factor));
            font-weight: 600;
            margin-bottom: calc(20px * var(--scale-factor));
        }
        .routine-list { 
            display: flex; 
            flex-direction: column; 
            gap: calc(12px * var(--scale-factor)); 
        }
        .routine-item-wrapper {
            position: relative;
            overflow: hidden;
            border-radius: var(--border-radius-md);
        }
        .routine-item-actions {
            position: absolute;
            top: 0;
            right: 0;
            height: 100%;
            display: flex;
            align-items: center;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        .routine-item-wrapper.swiped .routine-item-actions {
            transform: translateX(0);
        }
        .routine-item-wrapper.swiped .routine-item {
            transform: translateX(-140px);
        }
        .swipe-action-btn {
            width: 70px;
            height: 100%;
            border: none;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .swipe-action-btn.skip { background-color: #f39c12; }
        .swipe-action-btn.unskip { background-color: #2ecc71; }
        .routine-item { 
            display: flex; 
            align-items: center; 
            padding: calc(18px * var(--scale-factor));
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            transition: transform 0.3s ease;
            width: 100%;
            box-sizing: border-box;
            min-height: var(--touch-target-min);
            position: relative;
        }
        .routine-item.carry-over {
            background-color: #fffbe6; /* Light yellow */
            border-left: 4px solid #f39c12; /* Amber border */
        }
        .routine-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        .routine-item.completed, .routine-item.skipped { 
            background-color: #f8f9fa;
            opacity: 0.7;
        }
        .routine-item.completed .routine-name, .routine-item.skipped .routine-name {
            text-decoration: line-through;
            color: var(--text-secondary-color);
        }
        .routine-content { 
            flex-grow: 1; 
            margin-right: 1rem; 
            display: flex; 
            flex-direction: column;
            min-width: 0;
        }
        .routine-name { 
            font-weight: 500; 
            font-size: calc(1.05rem * var(--scale-factor));
        }
        .routine-details { 
            font-size: calc(0.8rem * var(--scale-factor)); 
            color: var(--text-secondary-color); 
            margin-top: 5px; 
        }
        .action-button, .checkbox {
            font-size: calc(1.1rem * var(--scale-factor));
            color: var(--primary-color);
            width: var(--touch-target-min);
            height: var(--touch-target-min);
            margin-right: calc(12px * var(--scale-factor));
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
            cursor: pointer;
            flex-shrink: 0;
            border: 2px solid var(--border-color);
            box-sizing: border-box;
        }
        .routine-item.completed .checkbox {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
            font-size: calc(1.4rem * var(--scale-factor));
        }
        .routine-item.completed .checkbox::after {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
        }
        
        .action-button:hover, .checkbox:hover {
            background-color: rgba(102, 126, 234, 0.1);
        }

        .routine-item.completed .action-button {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        .streak-badge {
            position: absolute;
            top: 0;
            left: 0;
            background: var(--primary-gradient);
            color: white;
            font-size: calc(0.7rem * var(--scale-factor));
            font-weight: 600;
            padding: calc(3px * var(--scale-factor)) calc(8px * var(--scale-factor));
            border-bottom-right-radius: var(--border-radius-md);
            border-top-left-radius: var(--border-radius-md);
        }
        .streak-badge i {
            margin-right: 4px;
        }

        .bottom-nav {
            position: fixed; 
            bottom: 0; left: 0; right: 0;
            height: calc(70px * var(--scale-factor) + env(safe-area-inset-bottom));
            display: flex;
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px); 
            -webkit-backdrop-filter: blur(15px);
            border-top: 1px solid var(--border-color);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: max(env(safe-area-inset-left), 8px);
            padding-right: max(env(safe-area-inset-right), 8px);
            z-index: 500;
        }
        .nav-btn {
            flex: 1; 
            display: flex; flex-direction: column;
            justify-content: center; align-items: center; 
            gap: calc(4px * var(--scale-factor));
            background: none; border: none; cursor: pointer;
            color: var(--text-secondary-color); 
            font-size: calc(0.7rem * var(--scale-factor));
            font-weight: 500;
            transition: color 0.3s, border-top-color 0.3s;
            border-top: 3px solid transparent;
            min-height: var(--touch-target-min);
            position: relative;
            padding-top: 3px;
        }
        .nav-btn i {
            font-size: calc(1.5rem * var(--scale-factor));
        }
        .nav-btn:hover {
            color: var(--primary-color);
        }
        .nav-btn.active { 
            color: var(--primary-color); 
            border-top-color: var(--primary-color);
        }
        .form-group { margin-bottom: calc(20px * var(--scale-factor)); }
        .form-group label {
            display: block; margin-bottom: calc(8px * var(--scale-factor));
            font-weight: 500; color: #555;
            font-size: calc(0.95rem * var(--scale-factor));
        }
        .form-group input, 
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: calc(14px * var(--scale-factor)) calc(16px * var(--scale-factor));
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-md);
            font-size: calc(var(--base-font-size) * var(--scale-factor)); 
            transition: border-color 0.3s, background-color 0.3s;
            -webkit-appearance: none;
            appearance: none;
            background-color: #f8f9fa;
            color: var(--text-color);
            min-height: var(--touch-target-min);
            box-sizing: border-box;
            font-family: inherit;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            background-color: var(--surface-color);
        }
        .select-wrapper { position: relative; }
        .select-wrapper::after {
            content: 'â–¼'; position: absolute;
            top: 50%; right: calc(16px * var(--scale-factor));
            transform: translateY(-50%);
            pointer-events: none;
            color: var(--primary-color);
            font-size: calc(12px * var(--scale-factor));
        }
        .submit-btn {
            background: var(--primary-gradient);
            color: white; border: none;
            padding: calc(14px * var(--scale-factor)) calc(28px * var(--scale-factor));
            border-radius: var(--border-radius-md);
            cursor: pointer; 
            font-size: calc(var(--base-font-size) * var(--scale-factor));
            font-weight: 500; width: 100%;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 6px rgba(102, 126, 234, 0.25);
            min-height: var(--touch-target-min);
        }
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(102, 126, 234, 0.35);
        }
        .submit-btn:active { transform: translateY(0); }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Vertically align to top */
            padding-top: 15vh; /* Push down from the top */
            z-index: 900;
            overflow-y: auto; /* Ensure overlay itself can scroll if needed */
        }
        .modal {
            background: var(--surface-color);
            padding: calc(25px * var(--scale-factor));
            border-radius: var(--border-radius-lg);
            width: 90%;
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            animation: fadeIn 0.3s ease;
            display: flex;
            flex-direction: column;
            max-height: 85vh; /* Prevent modal from being taller than the screen */
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.75rem;
            flex-shrink: 0;
        }
        .modal-header h3 { 
            font-size: calc(1.5rem * var(--scale-factor)); 
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary-color);
        }
        .modal-body {
            overflow-y: auto; /* Make modal body scrollable if content overflows */
        }
        .modal-footer {
            margin-top: 1.5rem;
            display: flex;
            justify-content: space-between; /* Align buttons */
            gap: 0.5rem;
            flex-shrink: 0;
        }
        .btn {
            background: var(--primary-gradient);
            color: white; border: none;
            padding: calc(12px * var(--scale-factor)) calc(24px * var(--scale-factor));
            border-radius: var(--border-radius-md);
            cursor: pointer; 
            font-size: calc(15px * var(--scale-factor));
            font-weight: 500;
            transition: opacity 0.2s;
            min-height: var(--touch-target-min);
        }
        .btn-secondary {
            background: #e9ecef;
            color: #333;
        }
        .btn-danger {
            background: var(--danger-color);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(calc(150px * var(--scale-factor)), 1fr));
            gap: calc(15px * var(--scale-factor));
        }
        .stat-card {
            background: var(--surface-color);
            border-radius: var(--border-radius-md);
            padding: calc(15px * var(--scale-factor));
            text-align: center;
            box-shadow: var(--shadow-sm);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        .stat-card .stat-value {
            font-size: calc(1.8rem * var(--scale-factor));
            font-weight: 600;
            color: var(--primary-color);
        }
        .stat-card .stat-title {
            font-size: calc(0.8rem * var(--scale-factor));
            color: var(--text-secondary-color);
            margin-top: 5px;
        }
        .stat-card.sleep {
            grid-column: 1 / -1;
            background: var(--primary-gradient);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: calc(15px * var(--scale-factor));
            text-align: left;
            padding: calc(20px * var(--scale-factor));
        }
        .stat-card.sleep .stat-icon {
            font-size: calc(2.5rem * var(--scale-factor));
            opacity: 0.9;
        }
        .stat-card.sleep .stat-details {
            display: flex;
            flex-direction: column;
        }
        .stat-card.sleep .stat-title {
            font-size: calc(0.9rem * var(--scale-factor));
            opacity: 0.9;
            color: white;
        }
        .stat-card.sleep .stat-value {
            font-size: calc(1.6rem * var(--scale-factor));
            font-weight: 500;
            color: white;
        }
        #repeating-routine-list { 
            display: flex; 
            flex-direction: column; 
            gap: calc(12px * var(--scale-factor)); 
        }
        .repeating-routine-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: calc(18px * var(--scale-factor)); 
            background-color: var(--surface-color); 
            border-radius: var(--border-radius-md); 
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            font-size: calc(1rem * var(--scale-factor));
            min-height: var(--touch-target-min);
        }
        .repeating-routine-item .routine-name-wrapper { 
            display: flex; 
            align-items: center; 
            flex-grow: 1; 
            cursor: pointer;
        }
        .drag-handle { 
            cursor: grab; 
            color: #ccc; 
            margin-right: calc(15px * var(--scale-factor)); 
            font-size: calc(1.2rem * var(--scale-factor));
            padding: calc(8px * var(--scale-factor));
        }
        .time-emoji { 
            margin-right: calc(10px * var(--scale-factor)); 
            font-size: calc(1.2rem * var(--scale-factor)); 
        }
        .switch { 
            position: relative; 
            display: inline-block; 
            width: calc(50px * var(--scale-factor)); 
            height: calc(28px * var(--scale-factor)); 
            flex-shrink: 0;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { 
            position: absolute; cursor: pointer; 
            top: 0; left: 0; right: 0; bottom: 0; 
            background-color: #ccc; 
            transition: .4s; 
        }
        .slider:before { 
            position: absolute; content: ""; 
            height: calc(20px * var(--scale-factor)); 
            width: calc(20px * var(--scale-factor)); 
            left: calc(4px * var(--scale-factor)); 
            bottom: calc(4px * var(--scale-factor)); 
            background-color: white; 
            transition: .4s; 
        }
        input:checked + .slider { background-color: var(--primary-color); }
        input:focus + .slider { box-shadow: 0 0 1px var(--primary-color); }
        input:checked + .slider:before { 
            transform: translateX(calc(22px * var(--scale-factor))); 
        }
        .slider.round { border-radius: calc(28px * var(--scale-factor)); }
        .slider.round:before { border-radius: 50%; }
        #calendar-controls { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: calc(20px * var(--scale-factor)); 
            padding: 0; 
        }
        #calendar-controls h3 { 
            margin: 0; 
            font-size: calc(1.5rem * var(--scale-factor)); 
            font-weight: 600;
        }
        #calendar-controls button { 
            background: none; border: none; 
            font-size: calc(1.5rem * var(--scale-factor)); 
            color: var(--primary-color); 
            cursor: pointer;
            min-width: var(--touch-target-min);
            min-height: var(--touch-target-min);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
        }
        #calendar-controls button:hover {
            background-color: rgba(102, 126, 234, 0.1);
        }
        #calendar-view { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: calc(5px * var(--scale-factor)); 
            text-align: center; 
        }
        .calendar-header { 
            font-weight: 500; 
            padding-bottom: calc(10px * var(--scale-factor)); 
            color: var(--text-secondary-color); 
            font-size: calc(0.9rem * var(--scale-factor));
        }
        .calendar-day { 
            aspect-ratio: 1 / 1; 
            display: flex; 
            flex-direction: column;
            justify-content: center; 
            align-items: center;
            background-color: var(--surface-color); 
            border-radius: var(--border-radius-md); 
            min-height: 0; 
            padding: calc(5px * var(--scale-factor));
            box-shadow: var(--shadow-sm);
            transition: transform 0.2s, box-shadow 0.2s, background-color 0.3s;
            cursor: pointer;
            position: relative;
        }
        .calendar-day:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-md);
        }
        .day-number { font-size: calc(0.8rem * var(--scale-factor)); }
        .day-progress-bar {
            width: 80%;
            height: 6px;
            background-color: rgba(0,0,0,0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 4px;
        }
        .day-progress {
            height: 100%;
            background-color: var(--primary-color);
            transition: width 0.3s ease;
        }
        .calendar-day.other-month {
            opacity: 0.4;
            pointer-events: none;
        }
        .calendar-day.future {
            background-color: var(--surface-color);
            cursor: default;
        }
        .calendar-day.future:hover {
            transform: none;
            box-shadow: var(--shadow-sm);
        }
        .calendar-day.no-routine {
            background-color: #bdc3c7; /* Grey */
        }

        .calendar-day.level-100 { background-color: #667eea; color: white; } /* 100% (íŒŒë‘) */
        .calendar-day.level-80 { background-color: #4caf50; color: white; } /* 80%+ (ì´ˆë¡) */
        .calendar-day.level-1 { background-color: #f39c12; color: white; } /* 1%+ (ë…¸ë‘) */
        .calendar-day.level-0 { background-color: #e74c3c; color: white; } /* 0% (ë¹¨ê°•) */

        .day-emoji {
            font-size: calc(1.2rem * var(--scale-factor));
            position: absolute;
            top: 2px;
            right: 2px;
        }

        .calendar-day.level-100 .day-number,
        .calendar-day.level-80 .day-number,
        .calendar-day.level-1 .day-number,
        .calendar-day.level-0 .day-number {
            color: white;
        }
        .calendar-day.level-100 .day-progress-bar,
        .calendar-day.level-80 .day-progress-bar,
        .calendar-day.level-1 .day-progress-bar,
        .calendar-day.level-0 .day-progress-bar {
            background-color: rgba(255, 255, 255, 0.3);
        }
        .calendar-day.level-100 .day-progress,
        .calendar-day.level-80 .day-progress,
        .calendar-day.level-1 .day-progress,
        .calendar-day.level-0 .day-progress {
            background-color: rgba(255, 255, 255, 0.7);
        }
        
        /* Timer Modal Styles */
        #timerModal .modal-body {
            text-align: center;
        }
        #timerDisplay {
            font-size: calc(5rem * var(--scale-factor));
            font-weight: 300;
            margin: 1rem 0;
            font-family: 'SF Mono', 'Monaco', monospace;
        }
        #timerControls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        #timerControls .btn {
            width: 80px;
        }
        
        .filter-controls {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        .filter-btn {
            background-color: #f0f0f0;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }
        .filter-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .goal-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .goal-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 0.75rem;
            accent-color: var(--primary-color);
            flex-shrink: 0;
        }
        .tomorrow-goal-icon {
            width: 20px;
            height: 20px;
            margin-right: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary-color);
            flex-shrink: 0;
        }
        .goal-input-wrapper {
            flex-grow: 1;
            position: relative;
            display: flex;
            align-items: center;
            background-color: #f8f9fa;
            border-radius: var(--border-radius-md);
            border: 1px solid var(--border-color);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .goal-input-wrapper:focus-within {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }
        .goal-input-wrapper i {
            padding-left: 0.8rem;
            color: var(--text-secondary-color);
        }
        .goal-text-input {
            flex-grow: 1;
            border: none;
            padding: 0.8rem 0.8rem 0.8rem 0.5rem; /* top right bottom left */
            font-size: 1rem;
            background: transparent;
            color: var(--text-color);
            outline: none;
        }
        .goal-text-input::placeholder {
            color: var(--text-secondary-color);
        }


        @media (prefers-color-scheme: dark) {
            :root {
                --background-color: #121212;
                --surface-color: #1e1e1e;
                --text-color: #e0e0e0;
                --text-secondary-color: #a0a0a0;
                --border-color: #333;
            }
            .bottom-nav {
                background-color: rgba(30, 30, 30, 0.95);
            }
            .routine-item.completed, .routine-item.skipped {
                background-color: #2a2a2a;
            }
            .form-group input, .form-group select, .form-group textarea {
                background-color: #2c2c2c;
                color: var(--text-color);
            }
            .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
                background-color: #1e1e1e;
            }
            .btn-secondary {
                background: #333;
                color: var(--text-color);
            }
            .calendar-day.future {
                background-color: var(--surface-color);
            }
            .calendar-day.no-routine {
                background-color: #4a4a4a;
            }
            .calendar-day.level-100 { background-color: #5252b4; }
            .calendar-day.level-80 { background-color: #388e3c; }
            .calendar-day.level-1 { background-color: #e65100; }
            .calendar-day.level-0 { background-color: #b71c1c; }
            .filter-btn {
                background-color: #333;
                color: var(--text-color);
            }
            .filter-btn.active {
                background-color: var(--primary-color);
                color: white;
            }
            .goal-input-wrapper {
                background-color: #2c2c2c;
            }
            .goal-text-input {
                color: var(--text-color);
            }
            .goal-text-input::placeholder {
                color: var(--text-secondary-color);
            }
        }
        @media only screen and (max-width: 430px) and (-webkit-min-device-pixel-ratio: 3),
                only screen and (max-width: 430px) and (min-resolution: 3dppx) {
            :root {
                --scale-factor: 1.1;
                --base-font-size: 17px;
                --touch-target-min: 48px;
            }
        }
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }
        @media screen and (orientation: landscape) and (max-height: 500px) {
            .bottom-nav {
                height: calc(60px * var(--scale-factor) + env(safe-area-inset-bottom));
            }
            .nav-btn i {
                font-size: calc(1.3rem * var(--scale-factor));
            }
            .nav-btn {
                font-size: calc(0.55rem * var(--scale-factor));
                gap: calc(2px * var(--scale-factor));
            }
            .container {
                padding: calc(15px * var(--scale-factor));
            }
        }

        /* ë³´ìƒ ìš”ì²­ ê´€ë¦¬ í˜ì´ì§€ ìŠ¤íƒ€ì¼ */
        .reward-request-item {
            background: white;
            padding: 1rem;
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-sm);
            margin-bottom: 0.75rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            border: 1px solid var(--border-color);
        }

        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
            color: var(--text-primary);
        }

        .request-details {
            font-size: 0.875rem;
            color: var(--text-secondary-color);
        }

        .request-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .request-btn {
            flex: 1;
            padding: 0.6rem 1rem;
            border-radius: var(--border-radius-md);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            color: white;
        }

        .request-btn.approve {
            background: var(--success);
        }

        .request-btn.approve:hover {
            background: var(--secondary-color); /* Adjusted hover color */
        }

        .request-btn.reject {
            background: var(--danger-color);
        }

        .request-btn.reject:hover {
            background: #cc3322; /* Darker red */
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ë¡œê·¸ì¸ í˜ì´ì§€ -->
        <div id="loginPage" class="login-page">
            <div class="login-form">
                <h1 class="app-title">ğŸŒ… ë£¨í‹´ íŠ¸ë˜ì»¤</h1>
                
                <!-- ì—­í•  ì„ íƒ -->
                <div class="role-selector">
                    <div class="role-btn active" data-role="parent">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ë¶€ëª¨</div>
                    <div class="role-btn" data-role="child">ğŸ‘¶ ìë…€</div>
                </div>

                <!-- ê°€ì¡± ì½”ë“œ ì…ë ¥ (ìë…€ìš©) -->
                <div id="familyCodeInput" class="input-group family-code-input">
                    <label for="familyCode">ê°€ì¡± ì½”ë“œ</label>
                    <input type="text" id="familyCode" placeholder="ê°€ì¡± ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                </div>

                <!-- Google ë¡œê·¸ì¸ ë²„íŠ¼ -->
                <button class="btn google-btn" id="googleSignInBtn">
                    <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google" class="google-icon">
                    <div>
                        <span class="google-btn-text">Googleë¡œ ì‹œì‘í•˜ê¸°</span>
                        <div class="google-btn-subtitle">ì•ˆì „í•˜ê³  ë¹ ë¥¸ ë¡œê·¸ì¸</div>
                    </div>
                </button>

                <!-- ë¡œê·¸ì¸ ë¬¸ì œ í•´ê²° ì•ˆë‚´ -->
                <div class="login-help">
                    <details>
                        <summary>ë¡œê·¸ì¸ì— ë¬¸ì œê°€ ìˆë‚˜ìš”?</summary>
                        <div class="help-content">
                            <p><strong>íŒì—…ì´ ì°¨ë‹¨ëœ ê²½ìš°:</strong></p>
                            <ul>
                                <li>ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ íŒì—… í—ˆìš©</li>
                                <li>í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„</li>
                            </ul>
                            <p><strong>iOS Safari ì‚¬ìš©ì:</strong></p>
                            <ul>
                                <li>ìë™ìœ¼ë¡œ ì•ˆì „í•œ ë¡œê·¸ì¸ ë°©ì‹ ì‚¬ìš©</li>
                                <li>í˜ì´ì§€ ì´ë™ í›„ ìë™ ë¡œê·¸ì¸ ì²˜ë¦¬</li>
                            </ul>
                        </div>
                    </details>
                </div>

                <!-- êµ¬ë¶„ì„  -->
                <div class="divider">
                    <span>ë˜ëŠ”</span>
                </div>

                <!-- ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ ë¡œê·¸ì¸ (ì„ íƒì‚¬í•­) -->
                <div class="email-login-section collapsed" id="emailLoginSection">
                    <div class="input-group">
                        <label for="email">ì´ë©”ì¼</label>
                        <input type="email" id="email" placeholder="your@email.com">
                    </div>
                    <div class="input-group">
                        <label for="password">ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
                    </div>
                    <button class="btn" id="loginBtn">ë¡œê·¸ì¸</button>
                    <button class="btn btn-secondary" id="registerBtn">íšŒì›ê°€ì…</button>
                </div>

                <button class="btn-text" id="toggleEmailLogin">ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸</button>

                <!-- ê°€ì¡± ì½”ë“œ í‘œì‹œ (ë¶€ëª¨ìš© íšŒì›ê°€ì… í›„) -->
                <div id="familyCodeDisplay" class="family-code-display hidden">
                    <div>ê°€ì¡± ì½”ë“œ</div>
                    <div class="family-code" id="generatedFamilyCode"></div>
                    <div style="font-size: 0.75rem; margin-top: 0.75rem; color: var(--text-secondary);">
                        ìë…€ì—ê²Œ ì´ ì½”ë“œë¥¼ ì•Œë ¤ì£¼ì„¸ìš”
                    </div>
                </div>
            </div>
        </div>

        <!-- ë©”ì¸ ì•± -->
        <div id="mainApp" class="main-app">
            <!-- í—¤ë” -->
            <div class="header">
                <div class="user-info">
                    <span id="userEmail"></span>
                    <span class="user-role" id="userRole"></span>
                    <button class="logout-btn" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
                <h1>ì˜¤ëŠ˜ì˜ ë£¨í‹´</h1>
                <div id="currentDate"></div>
            </div>

            <main class="main-content">
                <section id="page-today" class="page active">
                    <div id="stats-summary-container" class="stats-grid">
                        <!-- Placeholder for sleep card -->
                        <div class="stat-card sleep">
                            <i class="fas fa-bed stat-icon"></i>
                            <div class="stat-details">
                                <div class="stat-title">ì–´ì ¯ë°¤ ì´ ìˆ˜ë©´ ì‹œê°„</div>
                                <div class="stat-value" id="sleepHours">8ì‹œê°„ 30ë¶„</div>
                            </div>
                        </div>
                        <!-- Placeholder for other stats -->
                        <div class="stat-card">
                            <div class="stat-value" id="currentStreak">5</div>
                            <div class="stat-title">ì—°ì† ì¼ìˆ˜</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="todayProgress">75%</div>
                            <div class="stat-title">ì˜¤ëŠ˜ ì§„í–‰ë¥ </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="currentPoints">120</div>
                            <div class="stat-title">ë‚´ í¬ì¸íŠ¸</div>
                        </div>
                    </div>
                    
                    <div id="nvc-sentence-container" class="section-card">
                        <h2><i class="fas fa-comment-dots"></i> ì˜¤ëŠ˜ì˜ ë¬¸ì¥</h2>
                        <p id="nvc-sentence-text" style="font-style: italic; text-align: center; font-size: 1.1rem; padding: 0 1rem; line-height: 1.6;">
                            "ì‘ì€ ìŠµê´€ë“¤ì´ ëª¨ì—¬ í° ë³€í™”ë¥¼ ë§Œë“­ë‹ˆë‹¤."
                        </p>
                    </div>

                    <div id="daily-goals-container" class="section-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h2><i class="fas fa-bullseye"></i> ì˜¤ëŠ˜ì˜ ëª©í‘œ</h2>
                            <button id="ai-goal-suggestion-btn" class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                                <i class="fas fa-robot"></i> AI ëª©í‘œ ì œì•ˆ
                            </button>
                        </div>
                        <div class="goal-item">
                            <input type="checkbox" id="goal-check-0" data-index="0" checked>
                            <div class="goal-input-wrapper">
                                <i class="fas fa-puzzle-piece"></i>
                                <input type="text" id="goal-text-0" data-index="0" value="ì¹œêµ¬ì™€ 30ë¶„ ë†€ê¸°" placeholder="Play" class="goal-text-input">
                            </div>
                        </div>
                        <div class="goal-item">
                            <input type="checkbox" id="goal-check-1" data-index="1">
                            <div class="goal-input-wrapper">
                                <i class="fas fa-bolt"></i>
                                <input type="text" id="goal-text-1" data-index="1" value="ìš´ë™ 20ë¶„ í•˜ê¸°" placeholder="Power" class="goal-text-input">
                            </div>
                        </div>
                        <div class="goal-item">
                            <input type="checkbox" id="goal-check-2" data-index="2">
                            <div class="goal-input-wrapper">
                                <i class="fas fa-users"></i>
                                <input type="text" id="goal-text-2" data-index="2" value="ë¶€ëª¨ë‹˜ê»˜ ê°ì‚¬í•˜ë‹¤ê³  ë§í•˜ê¸°" placeholder="People" class="goal-text-input">
                            </div>
                        </div>
                    </div>
                    
                    <div class="section-card">
                        <h2><i class="fas fa-tasks"></i> ë‚¨ì€ ë£¨í‹´</h2>
                        <div class="routine-list" id="todayIncompleteRoutineList">
                            <!-- Routines will be dynamically loaded here -->
                        </div>
                        <div class="empty-state" id="emptyStateToday" style="display: none;">
                            <i class="fas fa-inbox"></i><h3>ì˜¤ëŠ˜ì˜ ë£¨í‹´ì´ ì—†ìŠµë‹ˆë‹¤</h3><p>í•˜ë‹¨ 'ê´€ë¦¬' íƒ­ì—ì„œ ìƒˆë¡œìš´ ë£¨í‹´ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!</p>
                        </div>
                    </div>

                    <div class="section-card" id="completed-section" style="display: none;">
                        <h2><i class="fas fa-check-double"></i> ì™„ë£Œí•œ ë£¨í‹´</h2>
                        <div class="routine-list" id="todayCompleteRoutineList">
                            <!-- Completed routines will be dynamically loaded here -->
                        </div>
                    </div>

                    <div class="section-card" id="skipped-section" style="display: none;">
                        <h2><i class="fas fa-forward"></i> ê±´ë„ˆë›´ ë£¨í‹´</h2>
                        <div class="routine-list" id="todaySkippedRoutineList">
                            <!-- Skipped routines will be dynamically loaded here -->
                        </div>
                    </div>

                    <div class="section-card" id="tomorrow-goals-container">
                        <h2><i class="fas fa-calendar-day"></i> ë‚´ì¼ì˜ ëª©í‘œ</h2>
                        <div class="goal-item">
                            <i class="far fa-circle tomorrow-goal-icon"></i>
                            <div class="goal-input-wrapper">
                                <i class="fas fa-puzzle-piece"></i>
                                <input type="text" id="tomorrow-goal-text-0" data-index="0" value="ìƒˆë¡œìš´ ê²Œì„ ì‹œë„" placeholder="Play" class="goal-text-input">
                            </div>
                        </div>
                        <div class="goal-item">
                            <i class="far fa-circle tomorrow-goal-icon"></i>
                            <div class="goal-input-wrapper">
                                <i class="fas fa-bolt"></i>
                                <input type="text" id="tomorrow-goal-text-1" data-index="1" value="ì¤„ë„˜ê¸° 100ê°œ" placeholder="Power" class="goal-text-input">
                            </div>
                        </div>
                        <div class="goal-item">
                            <i class="far fa-circle tomorrow-goal-icon"></i>
                            <div class="goal-input-wrapper">
                                <i class="fas fa-users"></i>
                                <input type="text" id="tomorrow-goal-text-2" data-index="2" value="ê°€ì¡±ê³¼ ë³´ë“œê²Œì„" placeholder="People" class="goal-text-input">
                            </div>
                        </div>
                    </div>
                </section>
            </main>

            <!-- ê´€ë¦¬ í˜ì´ì§€ -->
            <div id="managePage" class="page">
                <div class="page-title">ë£¨í‹´ ê´€ë¦¬</div>
                <button class="add-routine-btn" id="addRoutineBtn">âœ¨ ìƒˆ ë£¨í‹´ ì¶”ê°€</button>
                <div id="manageRoutineList">
                    <!-- ê´€ë¦¬ìš© ë£¨í‹´ ëª©ë¡ -->
                </div>
            </div>

            <!-- í†µê³„ í˜ì´ì§€ -->
            <div id="statsPage" class="page">
                <div class="page-title">ğŸ“ˆ ë‚˜ì˜ í†µê³„</div>
                
                <!-- ì „ì²´ í†µê³„ ì¹´ë“œ -->
                <div class="stats-overview">
                    <div class="stat-card">
                        <div class="stat-value" id="totalDays">0</div>
                        <div class="stat-title">ì´ í™œë™ ì¼ìˆ˜</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="bestStreak">0</div>
                        <div class="stat-title">ìµœê³  ì—°ì† ê¸°ë¡</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="completionRate">0%</div>
                        <div class="stat-title">í‰ê·  ì™„ë£Œìœ¨</div>
                    </div>
                </div>

                <!-- ì›”ê°„ íˆíŠ¸ë§µ -->
                <div class="monthly-heatmap">
                    <h3>ì›”ê°„ í™œë™ íˆíŠ¸ë§µ</h3>
                    <div class="heatmap-container" id="heatmapContainer">
                        <!-- ì›”ê°„ íˆíŠ¸ë§µì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                    <div class="heatmap-legend">
                        <span>ì ìŒ</span>
                        <div class="legend-colors">
                            <div class="legend-color" data-level="0"></div>
                            <div class="legend-color" data-level="1"></div>
                            <div class="legend-color" data-level="2"></div>
                            <div class="legend-color" data-level="3"></div>
                            <div class="legend-color" data-level="4"></div>
                        </div>
                        <span>ë§ìŒ</span>
                    </div>
                </div>

                <!-- ë£¨í‹´ë³„ ì„±ê³¼ -->
                <div class="routine-stats">
                    <h3>ë£¨í‹´ë³„ ì„±ê³¼</h3>
                    <div id="routineStatsContainer">
                        <!-- ë£¨í‹´ë³„ í†µê³„ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                </div>
            </div>
            
            <!-- ë³´ìƒ í˜ì´ì§€ -->
            <div id="rewardsPage" class="page">
                <div class="page-title">ğŸ ë³´ìƒ êµí™˜ì†Œ</div>
                <div class="current-points">
                    <div class="points-label">ë‚´ í¬ì¸íŠ¸</div>
                    <div class="points-number" id="rewardPointsDisplay">0</div>
                </div>

                <!-- ë¶€ëª¨ì—ê²Œë§Œ ë³´ì´ëŠ” ë³´ìƒ ì¶”ê°€ ë²„íŠ¼ -->
                <button class="add-reward-btn hidden" id="addRewardBtn">âœ¨ ìƒˆ ë³´ìƒ ì¶”ê°€</button>

                <div id="rewardsList" class="rewards-list">
                    <!-- ë³´ìƒ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
            </div>

            <!-- ê°€ì¡± í˜ì´ì§€ -->
            <div id="familyPage" class="page">
                <div class="page-title">ê°€ì¡± ë£¨í‹´ í˜„í™©</div>
                
                <!-- ê°€ì¡± ì½”ë“œ í‘œì‹œ ì¹´ë“œ (ë¶€ëª¨ë§Œ) -->
                <div id="familyCodeCard" class="family-code-card hidden">
                    <div class="card-header">
                        <h3>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ê°€ì¡± ì½”ë“œ</h3>
                        <div class="card-subtitle">ìë…€ë“¤ì´ ê°€ì¡±ì— ì°¸ì—¬í•  ë•Œ í•„ìš”í•œ ì½”ë“œì…ë‹ˆë‹¤</div>
                    </div>
                    <div class="family-code-display-main">
                        <div class="family-code-large" id="familyCodeMain">-</div>
                        <button class="copy-btn" id="copyFamilyCodeBtn">ğŸ“‹ ë³µì‚¬</button>
                    </div>
                    <div class="family-info">
                        <div class="info-item">
                            <span class="info-label">ê°€ì¡± êµ¬ì„±ì›:</span>
                            <span class="info-value" id="memberCount">-ëª…</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">ìƒì„±ì¼:</span>
                            <span class="info-value" id="familyCreatedDate">-</span>
                        </div>
                    </div>
                </div>

                <!-- ê°€ì¡± êµ¬ì„±ì› ëª©ë¡ -->
                <div id="familyMembers" class="family-members">
                    <!-- ê°€ì¡± êµ¬ì„±ì›ë“¤ì˜ ë£¨í‹´ í˜„í™© -->
                </div>
            </div>

            <!-- ë³´ìƒ ìš”ì²­ ê´€ë¦¬ í˜ì´ì§€ (ë¶€ëª¨ë§Œ) -->
            <div id="rewardRequestsPage" class="page hidden">
                <div class="page-title">ğŸ“ ë³´ìƒ ìš”ì²­ ê´€ë¦¬</div>
                <div id="rewardRequestsList">
                    <!-- ë³´ìƒ ìš”ì²­ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
            </div>

            <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
            <div class="bottom-nav">
                <button id="nav-home" class="nav-btn active touchable"><i class="fas fa-home"></i><span>í™ˆ</span></button>
                <button id="nav-manage" class="nav-btn touchable"><i class="fas fa-sliders-h"></i><span>ê´€ë¦¬</span></button>
                <button id="nav-stats" class="nav-btn touchable"><i class="fas fa-chart-line"></i><span>í†µê³„</span></button>
                <button id="nav-rewards" class="nav-btn touchable"><i class="fas fa-gift"></i><span>ë³´ìƒ</span></button>
                <button id="nav-family" class="nav-btn touchable"><i class="fas fa-users"></i><span>ê°€ì¡±</span></button>
                <button id="nav-reward-requests" class="nav-btn hidden touchable"><i class="fas fa-bell"></i><span>ìš”ì²­</span></button>
            </div>
        </div>

        <!-- ë£¨í‹´ ì¶”ê°€ ëª¨ë‹¬ -->
        <div id="addRoutineModal" class="modal-overlay" style="display: none;">
            <div class="modal">
                <div class="modal-header">
                    <h3>âœ¨ ìƒˆ ë£¨í‹´ ì¶”ê°€</h3>
                    <button class="modal-close touchable" id="closeModalBtn">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="routineName">ë£¨í‹´ ì´ë¦„</label>
                        <input type="text" id="routineName" placeholder="ë£¨í‹´ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
                    </div>

                    <div class="form-group">
                        <label for="routineType">ë£¨í‹´ íƒ€ì…</label>
                        <div class="select-wrapper">
                            <select id="routineType">
                                <option value="task">íƒœìŠ¤í¬ (ì˜ˆ/ì•„ë‹ˆì˜¤)</option>
                                <option value="number">ìˆ«ì ì…ë ¥</option>
                                <option value="timestamp">ì‹œê°„ ê¸°ë¡</option>
                                <option value="timer">íƒ€ì´ë¨¸</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="routineTime">ì‹œì </label>
                        <div class="select-wrapper">
                            <select id="routineTime">
                                <option value="morning">ğŸŒ… ì•„ì¹¨</option>
                                <option value="afternoon">ğŸŒ ì ì‹¬</option>
                                <option value="evening">ğŸŒ™ ì €ë…</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="routineFreq">ì£¼ê¸°</label>
                        <div class="select-wrapper">
                            <select id="routineFreq">
                                <option value="daily">ë§¤ì¼</option>
                                <option value="weekday">í‰ì¼</option>
                                <option value="weekend">ì£¼ë§</option>
                                <option value="none">ë°˜ë³µ ì—†ìŒ</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group" id="routineUnitContainer" style="display: none;">
                        <label for="routineUnit">ë‹¨ìœ„</label>
                        <input type="text" id="routineUnit" placeholder="ì˜ˆ: ì”, í˜ì´ì§€, íšŒ">
                    </div>
                    <div class="form-group" id="routineDurationContainer" style="display: none;">
                        <label for="routineDuration">ì‹œê°„ (ë¶„)</label>
                        <input type="number" id="routineDuration" placeholder="ì˜ˆ: 30">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary touchable" id="cancelModalBtn">ì·¨ì†Œ</button>
                    <button class="btn touchable" id="confirmAddRoutineBtn">ì¶”ê°€</button>
                </div>
            </div>
        </div>

        <!-- ìƒˆ ë³´ìƒ ì¶”ê°€ ëª¨ë‹¬ -->
        <div id="addRewardModal" class="modal-overlay" style="display: none;">
            <div class="modal">
                <div class="modal-header">
                    <h3>ğŸ ìƒˆ ë³´ìƒ ì¶”ê°€</h3>
                    <button class="modal-close touchable" id="closeRewardModalBtn">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="rewardName">ë³´ìƒ ì´ë¦„</label>
                        <input type="text" id="rewardName" placeholder="ë³´ìƒ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
                    </div>

                    <div class="form-group">
                        <label for="rewardCost">í•„ìš” í¬ì¸íŠ¸</label>
                        <input type="number" id="rewardCost" min="1" value="100" placeholder="í•„ìš” í¬ì¸íŠ¸">
                    </div>

                    <div class="form-group">
                        <label for="rewardEmoji">ì´ëª¨ì§€ (ì„ íƒ)</label>
                        <input type="text" id="rewardEmoji" maxlength="2" placeholder="ì˜ˆ: ğŸ®, ğŸ•">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary touchable" id="cancelRewardModalBtn">ì·¨ì†Œ</button>
                    <button class="btn touchable" id="confirmAddRewardBtn">ì¶”ê°€</button>
                </div>
            </div>
        </div>

        <!-- ì„±ì·¨ ì¶•í•˜ ëª¨ë‹¬ -->
        <div id="achievementModal" class="modal-overlay" style="display: none;">
            <div class="modal achievement-content">
                <div class="achievement-animation">
                    <div class="celebration-emoji">ğŸ‰</div>
                    <div class="achievement-title" id="achievementTitle">ì¶•í•˜í•©ë‹ˆë‹¤!</div>
                    <div class="achievement-description" id="achievementDesc">ìƒˆë¡œìš´ ê¸°ë¡ì„ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤!</div>
                    <button class="btn celebration-btn touchable" id="closeAchievementBtn">ê³„ì†í•˜ê¸°</button>
                </div>
            </div>
        </div>

        <!-- ê°€ì¡± êµ¬ì„±ì› ìƒì„¸ ëª¨ë‹¬ -->
        <div id="memberDetailModal" class="modal-overlay" style="display: none;">
            <div class="modal">
                <div class="modal-header">
                    <div class="member-avatar" id="memberDetailAvatar" style="margin-right: 1rem;">ğŸ‘¤</div>
                    <div style="flex-grow: 1;">
                        <h3 id="memberDetailName" style="margin: 0;">êµ¬ì„±ì›</h3>
                        <div id="memberDetailRole" style="font-size: 0.9rem; color: var(--primary-color);">ì—­í• </div>
                    </div>
                    <div class="member-progress-ring">
                        <svg class="progress-ring" width="64" height="64">
                            <circle class="progress-ring-bg" cx="32" cy="32" r="28"></circle>
                            <circle class="progress-ring-fill" cx="32" cy="32" r="28" 
                                    id="memberProgressRing" 
                                    stroke-dasharray="0 176"
                                    stroke-dashoffset="0"></circle>
                        </svg>
                        <div class="progress-ring-text" id="memberProgressText">0%</div>
                    </div>
                    <button class="modal-close touchable" id="closeMemberDetailBtn" style="margin-left: 1rem;">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="member-stats" style="margin-bottom: 1.5rem;">
                        <div class="member-stat">
                            <div class="member-stat-number" id="memberTotalRoutines">0</div>
                            <div class="member-stat-label">ì´ ë£¨í‹´</div>
                        </div>
                        <div class="member-stat">
                            <div class="member-stat-number" id="memberCompletedRoutines">0</div>
                            <div class="member-stat-label">ì™„ë£Œë¨</div>
                        </div>
                        <div class="member-stat">
                            <div class="member-stat-number" id="memberPendingRoutines">0</div>
                            <div class="member-stat-label">ëŒ€ê¸°ì¤‘</div>
                        </div>
                    </div>

                    <div class="member-routines-today">
                        <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem; color: var(--text-color);">
                            ğŸ“… ì˜¤ëŠ˜ì˜ ë£¨í‹´ í˜„í™©
                        </h3>
                        <div id="memberRoutinesList" class="routine-list">
                            <!-- êµ¬ì„±ì›ì˜ ì˜¤ëŠ˜ ë£¨í‹´ ê²°ê³¼ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ìˆ«ì ì…ë ¥ ëª¨ë‹¬ -->
        <div class="modal-overlay" id="numberInputModal" style="display: none;">
            <div class="modal">
                <div class="modal-header"><h3 id="numberModalTitle">ìˆ«ì ì…ë ¥</h3><button id="numberModalClose" class="modal-close touchable"><i class="fas fa-times"></i></button></div>
                <div class="modal-body">
                    <div class="form-group"><label for="numberInput">ê°’ì„ ì…ë ¥í•˜ì„¸ìš”:</label><input type="number" id="numberInput" class="number-input" step="0.1"></div>
                </div>
                <div class="modal-footer"><button id="numberModalCancel" class="btn btn-secondary touchable">ì·¨ì†Œ</button><button class="btn btn-primary touchable" id="numberConfirmBtn">í™•ì¸</button></div>
            </div>
        </div>
        <!-- ì‹œê°„ ì…ë ¥ ëª¨ë‹¬ -->
        <div class="modal-overlay" id="timeInputModal" style="display: none;">
            <div class="modal">
                <div class="modal-header"><h3 id="timeModalTitle">ì‹œê°„ ì…ë ¥</h3><button id="timeModalClose" class="modal-close touchable"><i class="fas fa-times"></i></button></div>
                <div class="modal-body">
                    <div class="form-group"><label for="timeInput">ì‹œê°„ì„ ì„ íƒ ë˜ëŠ” ì…ë ¥í•˜ì„¸ìš”:</label><input type="time" id="timeInput" class="time-input"></div>
                </div>
                <div class="modal-footer"><button id="timeModalCancel" class="btn btn-secondary touchable">ì·¨ì†Œ</button><button class="btn btn-primary touchable" id="timeConfirmBtn">í™•ì¸</button></div>
            </div>
        </div>

        <!-- íƒ€ì´ë¨¸ ëª¨ë‹¬ -->
        <div class="modal-overlay" id="timerModal" style="display: none;">
            <div class="modal">
                <div class="modal-header">
                    <h3 id="timerModalTitle">íƒ€ì´ë¨¸</h3>
                    <button id="timerModalClose" class="modal-close touchable"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body">
                    <div id="timerDisplay">00:00</div>
                </div>
                <div class="modal-footer" id="timerControls">
                    <button id="timerPlayPauseBtn" class="btn touchable"><i class="fas fa-pause"></i></button>
                    <button id="timerCompleteBtn" class="btn btn-primary touchable">ì™„ë£Œ</button>
                </div>
            </div>
        </div>
        
        <!-- ì¼ë³„ ìƒì„¸ ëª¨ë‹¬ -->
        <div class="modal-overlay" id="dayDetailModal" style="display: none;">
            <div class="modal">
                <div class="modal-header">
                    <h3 id="dayDetailTitle"></h3>
                    <button id="dayDetailModalClose" class="modal-close touchable"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body">
                    <div class="routine-list" id="dayDetailRoutineList"></div>
                </div>
            </div>
        </div>

        <!-- ê·œì¹™ ìˆ˜ì • ëª¨ë‹¬ -->
        <div class="modal-overlay" id="editRuleModal" style="display: none;">
            <div class="modal">
                <form id="editRuleForm">
                    <div class="modal-header">
                        <h3>ë°˜ë³µ ë£¨í‹´ ìˆ˜ì •</h3>
                        <button id="editRuleModalClose" type="button" class="modal-close touchable"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="editRuleId" name="id">
                        <div class="form-group">
                            <label for="editRuleName">ë£¨í‹´ ì´ë¦„</label>
                            <input type="text" id="editRuleName" name="name" required>
                        </div>
                        <div class="form-row" style="display:flex; gap:1rem;">
                            <div class="form-group" style="flex:1;">
                                <label for="editRuleTimePeriod">ì‹œê°„ëŒ€</label>
                                <div class="select-wrapper"><select id="editRuleTimePeriod" name="timePeriod" required><option value="morning">ì•„ì¹¨</option><option value="afternoon">ì ì‹¬</option><option value="evening">ì €ë…</option></select></div>
                            </div>
                            <div class="form-group" style="flex:1;">
                                <label for="editRuleCategory">ì¹´í…Œê³ ë¦¬</label>
                                <input type="text" id="editRuleCategory" list="category-list" name="category" required> <datalist id="category-list"></datalist>
                            </div>
                        </div>
                        <div class="form-row" style="display:flex; gap:1rem;">
                            <div class="form-group" style="flex:1;">
                                <label for="editRuleType">íƒ€ì…</label>
                                <div class="select-wrapper"><select id="editRuleType" name="routineType" required><option value="task">íƒœìŠ¤í¬</option><option value="timestamp">íƒ€ì„ìŠ¤íƒ¬í”„</option><option value="number">ìˆ«ì</option><option value="timer">íƒ€ì´ë¨¸</option></select></div>
                            </div>
                            <div class="form-group" style="flex:1;">
                                <label for="editRuleRepeatPattern">ë°˜ë³µ</label>
                                <div class="select-wrapper"><select id="editRuleRepeatPattern" name="repeatPattern" required><option value="daily">ë§¤ì¼</option><option value="weekday">í‰ì¼</option><option value="weekend">ì£¼ë§</option><option value="none">ë°˜ë³µ ì—†ìŒ</option></select></div>
                            </div>
                        </div>
                        <div class="form-group" id="editRuleUnitContainer" style="display: none;">
                            <label for="editRuleUnit">ë‹¨ìœ„/ì‹œê°„(ë¶„)</label>
                            <input type="text" id="editRuleUnit" name="unit">
                        </div>
                        <div class="form-group">
                            <label for="editRuleStartDate">ì‹œì‘ ë‚ ì§œ</label>
                            <input type="date" id="editRuleStartDate" name="startDate" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button id="deleteRuleBtn" type="button" class="btn btn-danger touchable">ì‚­ì œ</button>
                        <div>
                            <button id="editRuleModalCancel" type="button" class="btn btn-secondary touchable">ì·¨ì†Œ</button>
                            <button type="submit" class="btn btn-primary touchable">ì €ì¥</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- í™•ì¸ ëª¨ë‹¬ -->
        <div class="modal-overlay" id="confirmModal" style="display: none;">
            <div class="modal">
                <div class="modal-header"><h3 id="confirmModalTitle">í™•ì¸</h3></div>
                <div class="modal-body">
                    <p id="confirmModalMessage"></p>
                </div>
                <div class="modal-footer" style="justify-content: flex-end; gap: 0.5rem;">
                    <button id="confirmModalCancel" class="btn btn-secondary touchable">ì·¨ì†Œ</button>
                    <button id="confirmModalOk" class="btn btn-danger touchable">í™•ì¸</button>
                </div>
            </div>
        </div>

        <!-- ê°„ë‹¨í•œ ìƒíƒœ í‘œì‹œê¸° -->
        <div id="statusIndicator" class="status-indicator hidden">
            <div id="statusText">ìƒíƒœ í™•ì¸ ì¤‘...</div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <!-- JavaScript ì½”ë“œ -->
    <script>
        // Firebase ì„¤ì • (ë°˜ë“œì‹œ ë³¸ì¸ì˜ í”„ë¡œì íŠ¸ ì„¤ì •ìœ¼ë¡œ êµì²´í•˜ì„¸ìš”!)
        const firebaseConfig = {
            apiKey: "AIzaSyC6bvEaHsxpLtPv5zM99PmgAwOnRXnhkBM", // YOUR_API_KEY
            authDomain: "habit-dc62a.firebaseapp.com", // YOUR_AUTH_DOMAIN
            projectId: "habit-dc62a", // YOUR_PROJECT_ID
            storageBucket: "habit-dc62a.firebasestorage.app", // YOUR_STORAGE_BUCKET
            messagingSenderId: "668374525477", // YOUR_MESSAGING_SENDER_ID
            appId: "1:668374525477:web:ecbecd95ec631fb82cc1cc" // YOUR_APP_ID
        };

        // ì „ì—­ ë³€ìˆ˜
        let currentUser = null;
        let userRole = 'parent'; // ê¸°ë³¸ ì—­í• ì€ 'parent'
        let familyId = null;
        let userPoints = 0; // ì‚¬ìš©ì í¬ì¸íŠ¸ ì¶”ê°€
        let auth, db;
        let todayCompletedRoutines = new Set();
        let userStats = {
            currentStreak: 0,
            bestStreak: 0,
            totalDays: 0,
            weeklyScore: 0,
            completionRate: 0
        };
        let allRoutinesCache = []; // ëª¨ë“  ë£¨í‹´ ë°ì´í„°ë¥¼ ì €ì¥í•  ìºì‹œ
        let allRulesCache = []; // ëª¨ë“  ê·œì¹™ ë°ì´í„°ë¥¼ ì €ì¥í•  ìºì‹œ
        let allGoalsCache = []; // ëª¨ë“  ëª©í‘œ ë°ì´í„°ë¥¼ ì €ì¥í•  ìºì‹œ

        // ë””ë²„ê·¸ ë¡œê¹… í•¨ìˆ˜ (console.logë¡œ ëŒ€ì²´)
        function debugLog(message, type = 'info') {
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // ìƒíƒœ í‘œì‹œ
        function showStatus(message, duration = 3000) {
            const statusIndicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            
            if (statusIndicator && statusText) {
                statusText.textContent = message;
                statusIndicator.classList.remove('hidden');
                
                setTimeout(() => {
                    statusIndicator.classList.add('hidden');
                }, duration);
            }
        }

        // í„°ì¹˜ ì´ë²¤íŠ¸ ì²˜ë¦¬ í•¨ìˆ˜
        function addTouchEventListener(element, callback, useCapture = false) {
            if (!element) {
                console.error('âŒ í„°ì¹˜ ì´ë²¤íŠ¸ ì¶”ê°€ ì‹¤íŒ¨: ìš”ì†Œê°€ ì—†ìŒ');
                return;
            }

            // í„°ì¹˜ ì´ë²¤íŠ¸ ì¶”ê°€
            element.addEventListener('touchstart', function(e) {
                e.preventDefault(); // ê¸°ë³¸ ìŠ¤í¬ë¡¤/ì¤Œ ë°©ì§€
                this.style.transform = 'scale(0.98)';
            }, { passive: false, capture: useCapture });

            element.addEventListener('touchend', function(e) {
                e.preventDefault(); // ê¸°ë³¸ í´ë¦­ ì´ë²¤íŠ¸ ë°©ì§€
                e.stopPropagation(); // ì´ë²¤íŠ¸ ë²„ë¸”ë§ ì¤‘ë‹¨
                this.style.transform = '';
                callback.call(this, e);
            }, { passive: false, capture: useCapture });

            // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ë„ ì¶”ê°€ (ë°ìŠ¤í¬í†± ì§€ì›)
            element.addEventListener('click', function(e) {
                e.preventDefault(); // ê¸°ë³¸ í´ë¦­ ì´ë²¤íŠ¸ ë°©ì§€
                e.stopPropagation(); // ì´ë²¤íŠ¸ ë²„ë¸”ë§ ì¤‘ë‹¨
                callback.call(this, e);
            }, { capture: useCapture });
        }

        // ìˆ«ì íœ  í”¼ì»¤ ìƒì„±
        function createNumberWheel(maxValue = 999, initialValue = 0) {
            const container = document.createElement('div');
            container.className = 'number-wheel-container';
            
            const hundreds = Math.floor(initialValue / 100);
            const tens = Math.floor((initialValue % 100) / 10);
            const ones = initialValue % 10;
            
            const maxHundreds = Math.floor(maxValue / 100);
            
            // ìˆ«ì í‘œì‹œ
            const display = document.createElement('div');
            display.className = 'number-display';
            display.textContent = initialValue.toString().padStart(3, '0');
            
            // 100ì˜ ìë¦¬ íœ 
            const hundredsWheel = createSingleWheel(0, maxHundreds, hundreds, 'ë°±');
            const tensWheel = createSingleWheel(0, 9, tens, 'ì‹­');
            const onesWheel = createSingleWheel(0, 9, ones, 'ì¼');
            
            // ê°’ ë³€ê²½ ì´ë²¤íŠ¸
            function updateValue() {
                const h = parseInt(hundredsWheel.querySelector('.number-wheel-scroll').dataset.value || '0');
                const t = parseInt(tensWheel.querySelector('.number-wheel-scroll').dataset.value || '0');
                const o = parseInt(onesWheel.querySelector('.number-wheel-scroll').dataset.value || '0');
                const total = h * 100 + t * 10 + o;
                
                display.textContent = total.toString().padStart(3, '0');
                container.dataset.value = total;
                
                // ì»¤ìŠ¤í…€ ì´ë²¤íŠ¸ ë°œìƒ
                container.dispatchEvent(new CustomEvent('valuechange', { detail: { value: total } }));
            }
            
            [hundredsWheel, tensWheel, onesWheel].forEach(wheel => {
                const scroll = wheel.querySelector('.number-wheel-scroll');
                scroll.addEventListener('scroll', () => {
                    debounce(() => {
                        const scrollTop = scroll.scrollTop;
                        const itemHeight = 32; // 2rem
                        const index = Math.round(scrollTop / itemHeight);
                        const maxIndex = scroll.children.length - 1;
                        const clampedIndex = Math.max(0, Math.min(index, maxIndex));
                        
                        // ì •í™•í•œ ìœ„ì¹˜ë¡œ ìŠ¤ëƒ…
                        scroll.scrollTop = clampedIndex * itemHeight;
                        scroll.dataset.value = clampedIndex;
                        
                        // í™œì„± ìƒíƒœ ì—…ë°ì´íŠ¸
                        Array.from(scroll.children).forEach((option, i) => {
                            option.classList.toggle('active', i === clampedIndex);
                        });
                        
                        updateValue();
                    }, 100)();
                });
            });
            
            container.appendChild(hundredsWheel);
            container.appendChild(display);
            container.appendChild(tensWheel);
            container.appendChild(onesWheel);
            
            // ì´ˆê¸°ê°’ ì„¤ì •
            container.dataset.value = initialValue;
            
            // getValue ë©”ì„œë“œ ì¶”ê°€
            container.getValue = () => parseInt(container.dataset.value || '0');
            
            return container;
        }
        
        function createSingleWheel(min, max, initialValue, label) {
            const wheelGroup = document.createElement('div');
            wheelGroup.className = 'wheel-group';
            
            const wheel = document.createElement('div');
            wheel.className = 'number-wheel';
            
            const scroll = document.createElement('div');
            scroll.className = 'number-wheel-scroll';
            scroll.dataset.value = initialValue;
            
            // ì˜µì…˜ë“¤ ìƒì„±
            for (let i = min; i <= max; i++) {
                const option = document.createElement('div');
                option.className = 'number-option';
                if (i === initialValue) option.classList.add('active');
                option.textContent = i;
                
                // í„°ì¹˜ ì´ë²¤íŠ¸ ì¶”ê°€
                addTouchEventListener(option, function() {
                    const index = Array.from(scroll.children).indexOf(this);
                    scroll.scrollTop = index * 32;
                });
                
                scroll.appendChild(option);
            }
            
            // ì´ˆê¸° ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì„¤ì •
            setTimeout(() => {
                scroll.scrollTop = initialValue * 32;
            }, 100);
            
            wheel.appendChild(scroll);
            
            const labelEl = document.createElement('div');
            labelEl.className = 'wheel-label';
            labelEl.textContent = label;
            
            wheelGroup.appendChild(wheel);
            wheelGroup.appendChild(labelEl);
            
            return wheelGroup;
        }
        
        // ë””ë°”ìš´ìŠ¤ í•¨ìˆ˜
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        function initializeTouchEvents() {
            // ì—­í•  ì„ íƒ ë²„íŠ¼ë“¤
            const roleButtons = document.querySelectorAll('.role-btn');
            roleButtons.forEach(btn => {
                addTouchEventListener(btn, function(e) {
                    const role = this.getAttribute('data-role');
                    selectRole(role);
                });
            });

            // Google ë¡œê·¸ì¸ ë²„íŠ¼
            const googleBtn = document.getElementById('googleSignInBtn');
            if (googleBtn) {
                addTouchEventListener(googleBtn, function(e) {
                    signInWithGoogle();
                });
            }

            // ì´ë©”ì¼ ë¡œê·¸ì¸ í† ê¸€
            const toggleEmailBtn = document.getElementById('toggleEmailLogin');
            if (toggleEmailBtn) {
                addTouchEventListener(toggleEmailBtn, toggleEmailLogin);
            }

            // ë¡œê·¸ì¸/íšŒì›ê°€ì… ë²„íŠ¼
            const loginBtn = document.getElementById('loginBtn');
            const registerBtn = document.getElementById('registerBtn');
            if (loginBtn) {
                addTouchEventListener(loginBtn, () => handleAuth('login'));
            }
            if (registerBtn) {
                addTouchEventListener(registerBtn, () => handleAuth('register'));
            }

            // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                addTouchEventListener(logoutBtn, logout);
            }

            // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ë“¤
            const navItems = document.querySelectorAll('.nav-btn'); // Changed to nav-btn
            navItems.forEach(navItem => {
                addTouchEventListener(navItem, function(e) {
                    const page = this.id.replace('nav-', 'page-'); // Adjusted to use id
                    showPage(page);
                });
            });

            // ë£¨í‹´ ì¶”ê°€ ë²„íŠ¼
            const addRoutineBtn = document.getElementById('addRoutineBtn');
            if (addRoutineBtn) {
                addTouchEventListener(addRoutineBtn, openAddRoutineModal);
            }

            // ë³´ìƒ ì¶”ê°€ ë²„íŠ¼ (ë¶€ëª¨ì—ê²Œë§Œ ë³´ì„)
            const addRewardBtn = document.getElementById('addRewardBtn');
            if (addRewardBtn) {
                addTouchEventListener(addRewardBtn, openAddRewardModal);
            }

            // ëª¨ë‹¬ ê´€ë ¨ ë²„íŠ¼ë“¤ (ë£¨í‹´ ì¶”ê°€ ëª¨ë‹¬)
            const closeModalBtn = document.getElementById('closeModalBtn');
            const cancelModalBtn = document.getElementById('cancelModalBtn');
            const confirmAddRoutineBtn = document.getElementById('confirmAddRoutineBtn');
            
            if (closeModalBtn) addTouchEventListener(closeModalBtn, closeModal);
            if (cancelModalBtn) addTouchEventListener(cancelModalBtn, closeModal);
            if (confirmAddRoutineBtn) addTouchEventListener(confirmAddRoutineBtn, addRoutine);

            // ëª¨ë‹¬ ê´€ë ¨ ë²„íŠ¼ë“¤ (ë³´ìƒ ì¶”ê°€ ëª¨ë‹¬)
            const closeRewardModalBtn = document.getElementById('closeRewardModalBtn');
            const cancelRewardModalBtn = document.getElementById('cancelRewardModalBtn');
            const confirmAddRewardBtn = document.getElementById('confirmAddRewardBtn');

            if (closeRewardModalBtn) addTouchEventListener(closeRewardModalBtn, closeAddRewardModal);
            if (cancelRewardModalBtn) addTouchEventListener(cancelRewardModalBtn, closeAddRewardModal);
            if (confirmAddRewardBtn) addTouchEventListener(confirmAddRewardBtn, addReward);

            // ì„±ì·¨ ëª¨ë‹¬
            const closeAchievementBtn = document.getElementById('closeAchievementBtn');
            if (closeAchievementBtn) addTouchEventListener(closeAchievementBtn, closeAchievementModal);
            
            // ê°€ì¡± êµ¬ì„±ì› ìƒì„¸ ëª¨ë‹¬
            const closeMemberDetailBtn = document.getElementById('closeMemberDetailBtn');
            if (closeMemberDetailBtn) addTouchEventListener(closeMemberDetailBtn, closeMemberDetail);

            // ê°€ì¡± ì½”ë“œ ë³µì‚¬ ë²„íŠ¼
            const copyFamilyCodeBtn = document.getElementById('copyFamilyCodeBtn');
            if (copyFamilyCodeBtn) {
                addTouchEventListener(copyFamilyCodeBtn, copyFamilyCode);
            }

            // Number Input Modal buttons
            const numberModalClose = document.getElementById('numberModalClose');
            const numberModalCancel = document.getElementById('numberModalCancel');
            const numberConfirmBtn = document.getElementById('numberConfirmBtn');
            if (numberModalClose) addTouchEventListener(numberModalClose, hideNumberInputModal);
            if (numberModalCancel) addTouchEventListener(numberModalCancel, hideNumberInputModal);
            if (numberConfirmBtn) addTouchEventListener(numberConfirmBtn, handleNumberInputConfirm);

            // Time Input Modal buttons
            const timeModalClose = document.getElementById('timeModalClose');
            const timeModalCancel = document.getElementById('timeModalCancel');
            const timeConfirmBtn = document.getElementById('timeConfirmBtn');
            if (timeModalClose) addTouchEventListener(timeModalClose, hideTimeInputModal);
            if (timeModalCancel) addTouchEventListener(timeModalCancel, hideTimeInputModal);
            if (timeConfirmBtn) addTouchEventListener(timeConfirmBtn, handleTimeInputConfirm);

            // Day Detail Modal buttons
            const dayDetailModalClose = document.getElementById('dayDetailModalClose');
            if (dayDetailModalClose) addTouchEventListener(dayDetailModalClose, hideDayDetailModal);

            // Timer Modal buttons
            const timerModalClose = document.getElementById('timerModalClose');
            const timerPlayPauseBtn = document.getElementById('timerPlayPauseBtn');
            const timerCompleteBtn = document.getElementById('timerCompleteBtn');
            if (timerModalClose) addTouchEventListener(timerModalClose, hideTimerModal);
            if (timerPlayPauseBtn) addTouchEventListener(timerPlayPauseBtn, handleTimerPlayPause);
            if (timerCompleteBtn) addTouchEventListener(timerCompleteBtn, handleTimerComplete);

            // Edit Rule Modal buttons
            const editRuleModalClose = document.getElementById('editRuleModalClose');
            const editRuleModalCancel = document.getElementById('editRuleModalCancel');
            const deleteRuleBtn = document.getElementById('deleteRuleBtn');
            if (editRuleModalClose) addTouchEventListener(editRuleModalClose, hideEditRuleModal);
            if (editRuleModalCancel) addTouchEventListener(editRuleModalCancel, hideEditRuleModal);
            if (deleteRuleBtn) addTouchEventListener(deleteRuleBtn, handleDeleteRule);

            // AI Settings buttons
            const generatePromptBtn = document.getElementById('generatePromptBtn');
            if (generatePromptBtn) addTouchEventListener(generatePromptBtn, handleGeneratePrompt);

            // Confirm Modal buttons
            const confirmModalCancel = document.getElementById('confirmModalCancel');
            const confirmModalOk = document.getElementById('confirmModalOk');
            // These are handled by the promise in showConfirmModal, no direct listeners here.

            // AI Goal Suggestion button
            const aiGoalSuggestionBtn = document.getElementById('ai-goal-suggestion-btn');
            if (aiGoalSuggestionBtn) addTouchEventListener(aiGoalSuggestionBtn, handleGetAiGoals);

            // Rule Filter Controls
            const ruleFilterControls = document.getElementById('rule-filter-controls');
            if (ruleFilterControls) {
                ruleFilterControls.querySelectorAll('.filter-btn').forEach(btn => {
                    addTouchEventListener(btn, function() {
                        handleRuleFilterClick(this);
                    });
                });
            }
        }

        // ê¸°ë³¸ ëª…ì–¸ë“¤
        const quotes = [
            "ì„±ê³µì€ ë§¤ì¼ì˜ ì‘ì€ ë…¸ë ¥ë“¤ì´ ìŒ“ì—¬ì„œ ë§Œë“¤ì–´ì§„ë‹¤.",
            "ì˜¤ëŠ˜ í•˜ë£¨ë„ ìµœì„ ì„ ë‹¤í•˜ëŠ” í•˜ë£¨ê°€ ë˜ê¸¸.",
            "ì‘ì€ ìŠµê´€ì´ í° ë³€í™”ë¥¼ ë§Œë“ ë‹¤.",
            "ê¾¸ì¤€í•¨ì´ ì²œì¬ë¥¼ ì´ê¸´ë‹¤.",
            "ë§¤ì¼ ì¡°ê¸ˆì”© ë‚˜ì•„ì§€ëŠ” ê²ƒì´ ì¤‘ìš”í•˜ë‹¤.",
            "ëª©í‘œë¥¼ í–¥í•œ ì²« ê±¸ìŒì´ ê°€ì¥ ì¤‘ìš”í•˜ë‹¤.",
            "ì™„ë²½í•˜ì§€ ì•Šì•„ë„ ì‹œì‘í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•˜ë‹¤.",
            "ì˜¤ëŠ˜ì˜ ë‚˜ëŠ” ì–´ì œì˜ ë‚˜ë³´ë‹¤ ì¡°ê¸ˆ ë” ë‚˜ì€ ì‚¬ëŒì´ë‹¤.",
            "ë£¨í‹´ì€ ê¿ˆì„ í˜„ì‹¤ë¡œ ë§Œë“œëŠ” ë‹¤ë¦¬ë‹¤.",
            "ì‘ì€ ì‹¤ì²œì´ í° ê¸°ì ì„ ë§Œë“ ë‹¤."
        ];

        // Firebase ì´ˆê¸°í™”
        function initializeFirebase() {
            try {
                showStatus('Firebase ì—°ê²° ì¤‘...', 2000);
                
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                
                showStatus('Firebase ì—°ê²° ì™„ë£Œ!', 2000);
                
                // ì¸ì¦ ìƒíƒœ ë³€ê²½ ê°ì§€
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        currentUser = user;
                        showStatus('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì¤‘...', 3000);
                        
                        try {
                            await loadUserProfile();
                            showMainApp();
                            startRealtimeListeners();
                        } catch (error) {
                            // í”„ë¡œí•„ ë¡œë“œ ì‹¤íŒ¨ ì‹œì—ë„ ë©”ì¸ ì•±ìœ¼ë¡œ ì „í™˜ (ìƒˆ ì‚¬ìš©ìì¼ ìˆ˜ ìˆìŒ)
                            showStatus('ìƒˆ ì‚¬ìš©ìë¡œ í”„ë¡œí•„ ìƒì„± ì¤‘...', 2000);
                            await handleNewUser(user);
                        }
                    } else {
                        currentUser = null;
                        showLoginPage();
                    }
                });
                
                // ë¦¬ë””ë ‰ì…˜ ê²°ê³¼ ì²˜ë¦¬ (í˜ì´ì§€ ë¡œë“œ ì‹œ)
                handleRedirectResult();
                
                return true;
            } catch (error) {
                console.error('âŒ Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                showStatus('Firebase ì—°ê²° ì‹¤íŒ¨: ' + error.message, 5000);
                return false;
            }
        }

        // ì• ë‹ˆë©”ì´ì…˜ íŠ¸ë¦¬ê±° í•¨ìˆ˜ë“¤
        function triggerAnimation(element, animationClass) {
            element.classList.add(animationClass);
            setTimeout(() => {
                element.classList.remove(animationClass);
            }, 600);
        }

        function addRippleEffect(button, event) {
            const ripple = document.createElement('span');
            const rect = button.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            const x = event.clientX - rect.left - size / 2;
            const y = event.clientY - rect.top - size / 2;
            
            ripple.style.width = ripple.style.height = size + 'px';
            ripple.style.left = x + 'px';
            ripple.style.top = y + 'px';
            ripple.classList.add('ripple');
            
            button.appendChild(ripple);
            
            setTimeout(() => {
                ripple.remove();
            }, 600);
        }

        // ì—­í•  ì„ íƒ
        function selectRole(role) {
            userRole = role;
            document.querySelectorAll('.role-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-role="${role}"]`).classList.add('active');
            
            const familyCodeInput = document.getElementById('familyCodeInput');
            if (role === 'child') {
                familyCodeInput.style.display = 'block';
                familyCodeInput.style.animation = 'fadeInUp 0.3s ease-out';
            } else {
                familyCodeInput.style.display = 'none';
            }
        }

        // Google ë¡œê·¸ì¸ (ê°œì„ ëœ ë²„ì „)
        async function signInWithGoogle() {
            const familyCode = document.getElementById('familyCode').value;
            
            if (userRole === 'child' && !familyCode) {
                showNotification('ìë…€ëŠ” ê°€ì¡± ì½”ë“œë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (!auth) {
                showNotification('Firebaseê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            setLoading(true, 'google');
            showStatus('Google ë¡œê·¸ì¸ ì¤‘...', 3000);
            
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                provider.addScope('email');
                provider.addScope('profile');
                
                let result;
                
                try {
                    result = await auth.signInWithPopup(provider);
                } catch (popupError) {
                    if (popupError.code === 'auth/popup-blocked' || 
                        popupError.code === 'auth/popup-closed-by-user' ||
                        popupError.code === 'auth/cancelled-popup-request') {
                        
                        if (familyCode) {
                            sessionStorage.setItem('tempFamilyCode', familyCode);
                            sessionStorage.setItem('tempUserRole', userRole);
                        }
                        
                        showNotification('íŒì—…ì´ ì°¨ë‹¨ë˜ì–´ í˜ì´ì§€ ì´ë™ ë°©ì‹ìœ¼ë¡œ ë¡œê·¸ì¸í•©ë‹ˆë‹¤.', 'warning');
                        await auth.signInWithRedirect(provider);
                        return;
                    } else {
                        throw popupError;
                    }
                }
                
                if (result && result.user) {
                    await handleGoogleSignInSuccess(result.user, familyCode);
                }
                
            } catch (error) {
                console.error('âŒ Google ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
                
                if (error.code === 'auth/unauthorized-domain') {
                    showNotification('âŒ ë„ë©”ì¸ì´ ìŠ¹ì¸ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. Firebase Consoleì—ì„œ ë„ë©”ì¸ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.', 'error');
                    showStatus('ë„ë©”ì¸ ìŠ¹ì¸ í•„ìš”', 5000);
                } else if (error.code === 'auth/operation-not-allowed') {
                    showNotification('âŒ Google ë¡œê·¸ì¸ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤. Firebase Consoleì—ì„œ í™œì„±í™”í•´ì£¼ì„¸ìš”.', 'error');
                    showStatus('Google ë¡œê·¸ì¸ ë¹„í™œì„±í™”', 5000);
                } else if (error.code === 'auth/popup-closed-by-user') {
                    showNotification('ë¡œê·¸ì¸ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'error');
                    showStatus('ë¡œê·¸ì¸ ì·¨ì†Œë¨', 2000);
                } else if (error.code === 'auth/popup-blocked') {
                    showNotification('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. íŒì—…ì„ í—ˆìš©í•˜ê±°ë‚˜ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
                    showStatus('íŒì—… ì°¨ë‹¨ë¨', 3000);
                } else if (error.code === 'auth/network-request-failed') {
                    showNotification('ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
                    showStatus('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜', 3000);
                } else if (error.code === 'permission-denied') {
                    showNotification('âš ï¸ Firebase ê¶Œí•œ ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
                    showStatus('ê¶Œí•œ ì˜¤ë¥˜', 3000);
                } else {
                    showNotification('Google ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
                    showStatus('ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + error.message, 5000);
                }
            } finally {
                setLoading(false, 'google');
            }
        }

        // Google ë¡œê·¸ì¸ ì„±ê³µ ì²˜ë¦¬
        async function handleGoogleSignInSuccess(user, familyCode) {
            showStatus('ë¡œê·¸ì¸ ì„±ê³µ! í”„ë¡œí•„ í™•ì¸ ì¤‘...', 2000);
            
            try {
                // ê¸°ì¡´ ì‚¬ìš©ìì¸ì§€ í™•ì¸
                const userDoc = await db.collection('users').doc(user.uid).get();
                
                if (!userDoc.exists) {
                    await createUserProfileFromGoogle(user, familyCode);
                    showNotification('Google ê³„ì •ìœ¼ë¡œ ì„±ê³µì ìœ¼ë¡œ ê°€ì…ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰');
                    showStatus('íšŒì›ê°€ì… ì™„ë£Œ!', 2000);
                } else {
                    showNotification('Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‘‹');
                    showStatus('ë¡œê·¸ì¸ ì™„ë£Œ!', 2000);
                }
                
            } catch (permissionError) {
                if (permissionError.code === 'permission-denied') {
                    await createUserProfileFromGoogle(user, familyCode);
                    showNotification('ìƒˆ ê³„ì •ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰');
                    showStatus('ê³„ì • ìƒì„± ì™„ë£Œ!', 2000);
                } else {
                    throw permissionError;
                }
            }
        }

        // ë¦¬ë””ë ‰ì…˜ ê²°ê³¼ ì²˜ë¦¬ (í˜ì´ì§€ ë¡œë“œ ì‹œ í™•ì¸)
        async function handleRedirectResult() {
            try {
                const result = await auth.getRedirectResult();
                
                if (result && result.user) {
                    // sessionStorageì—ì„œ ì„ì‹œ ì €ì¥ëœ ì •ë³´ ë³µì›
                    const tempFamilyCode = sessionStorage.getItem('tempFamilyCode');
                    const tempUserRole = sessionStorage.getItem('tempUserRole');
                    
                    if (tempUserRole) {
                        userRole = tempUserRole;
                        sessionStorage.removeItem('tempUserRole');
                    }
                    
                    if (tempFamilyCode) {
                        sessionStorage.removeItem('tempFamilyCode');
                    }
                    
                    await handleGoogleSignInSuccess(result.user, tempFamilyCode);
                }
            } catch (error) {
                console.error('âŒ ë¦¬ë””ë ‰ì…˜ ê²°ê³¼ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                showNotification('ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            }
        }

        // ì´ë©”ì¼ ë¡œê·¸ì¸ í† ê¸€
        function toggleEmailLogin() {
            const section = document.getElementById('emailLoginSection');
            const button = document.getElementById('toggleEmailLogin');
            
            if (section.classList.contains('collapsed')) {
                section.classList.remove('collapsed');
                button.textContent = 'ê°„í¸ ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°';
            } else {
                section.classList.add('collapsed');
                button.textContent = 'ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸';
            }
        }

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function generateFamilyCode() {
            return Math.random().toString(36).substr(2, 8).toUpperCase();
        }

        function showNotification(message, type = 'success') {
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease-out forwards';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }, 4000);
        }

        function setLoading(loading, type = 'email') {
            if (type === 'google') {
                const googleBtn = document.getElementById('googleSignInBtn');
                
                if (googleBtn) {
                    if (loading) {
                        googleBtn.disabled = true;
                        googleBtn.innerHTML = `
                            <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google" class="google-icon">
                            <div style="width: 20px; height: 20px; border: 2px solid #f3f3f3; border-top: 2px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                            <div class="google-btn-subtitle">ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘...</div>
                        `;
                    } else {
                        googleBtn.disabled = false;
                        googleBtn.innerHTML = `
                            <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google" class="google-icon">
                            <div>
                                <span class="google-btn-text">Googleë¡œ ì‹œì‘í•˜ê¸°</span>
                                <div class="google-btn-subtitle">ì•ˆì „í•˜ê³  ë¹ ë¥¸ ë¡œê·¸ì¸</div>
                            </div>
                        `;
                    }
                }
            }
        }

        function showLoginPage() {
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
        }

        function showMainApp() {
            try {
                const loginPage = document.getElementById('loginPage');
                const mainApp = document.getElementById('mainApp');
                
                if (!loginPage || !mainApp) {
                    console.error('âŒ í˜ì´ì§€ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                    return;
                }
                
                loginPage.style.display = 'none';
                mainApp.style.display = 'block';
                
                const mainAppElement = document.getElementById('mainApp');
                if (mainAppElement) {
                    mainAppElement.style.animation = 'fadeInUp 0.6s ease-out';
                }
                
                showStatus('ë©”ì¸ ì•± ë¡œë“œ ì™„ë£Œ!', 2000);
                
                // í™ˆ í˜ì´ì§€ë¥¼ ê¸°ë³¸ìœ¼ë¡œ í‘œì‹œ
                setTimeout(() => {
                    showPage('page-today'); // Changed to page-today
                }, 500);
                
            } catch (error) {
                console.error('âŒ ë©”ì¸ ì•± í‘œì‹œ ì˜¤ë¥˜:', error);
                showStatus('ì•± ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ', 3000);
            }
        }

        // í˜„ì¬ ë‚ ì§œ ì—…ë°ì´íŠ¸
        function updateCurrentDate() {
            const today = new Date();
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                weekday: 'long'
            };
            document.getElementById('currentDate').textContent = 
                today.toLocaleDateString('ko-KR', options);
        }

        // ì¼ì¼ ëª…ì–¸ ì—…ë°ì´íŠ¸
        function updateDailyQuote() {
            const today = new Date();
            const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
            const quoteIndex = dayOfYear % quotes.length;
            document.getElementById('nvc-sentence-text').textContent = `"${quotes[quoteIndex]}"`; // Updated ID
        }

        // í˜ì´ì§€ ì „í™˜
        function showPage(pageId) { // Changed parameter name to pageId
            showStatus('í˜ì´ì§€ ë¡œë“œ ì¤‘...', 1500);
            
            // ê°€ì¡± í˜ì´ì§€ì—ì„œ ë²—ì–´ë‚  ë•Œ ìë™ ìƒˆë¡œê³ ì¹¨ ì¤‘ë‹¨
            if (pageId !== 'page-family') { // Adjusted to page-family
                stopFamilyPageAutoRefresh();
            }
            
            // ëª¨ë“  í˜ì´ì§€ ìˆ¨ê¸°ê¸°
            document.querySelectorAll('.page').forEach(p => {
                p.style.display = 'none';
            });
            
            // ëª¨ë“  ë„¤ë¹„ê²Œì´ì…˜ í•­ëª© ë¹„í™œì„±í™”
            document.querySelectorAll('.nav-btn').forEach(nav => { // Changed to nav-btn
                nav.classList.remove('active');
            });
            
            // ì„ íƒëœ í˜ì´ì§€ ë° ë„¤ë¹„ê²Œì´ì…˜ í™œì„±í™”
            const targetPageElement = document.getElementById(pageId);
            const targetNavElement = document.getElementById(pageId.replace('page-', 'nav-'));

            if (targetPageElement) {
                targetPageElement.style.display = 'block';
            }
            if (targetNavElement) {
                targetNavElement.classList.add('active');
            }

            // Load content for specific pages
            if (pageId === 'page-today') {
                loadHomeRoutines();
            } else if (pageId === 'page-manage') {
                loadUserRoutines();
            } else if (pageId === 'page-stats') {
                loadStatsPage();
            } else if (pageId === 'page-rewards') {
                loadRewardsPage();
            } else if (pageId === 'page-family') {
                loadFamilyPageInfo();
            } else if (pageId === 'page-reward-requests') {
                loadRewardRequests();
            } else if (pageId === 'page-monthly') {
                loadMonthlyHeatmap(); // Assuming this is the calendar view
            }
            // Add other page specific loading functions here as needed

            // í˜ì´ì§€ ì „í™˜ ì• ë‹ˆë©”ì´ì…˜
            const activePage = document.querySelector('.page[style*="block"]');
            if (activePage) {
                activePage.style.animation = 'fadeInUp 0.4s ease-out';
            }
        }

        // ìŠ¤íŠ¸ë¦­ ë° í†µê³„ ë¡œë“œ
        async function loadUserStats() {
            if (!currentUser || !familyId) return;

            try {
                // ì§€ë‚œ 30ì¼ê°„ì˜ ë£¨í‹´ ë¡œê·¸ ê°€ì ¸ì˜¤ê¸° (ì¸ë±ìŠ¤ ì˜¤ë¥˜ ë°©ì§€ë¥¼ ìœ„í•´ ë‹¨ìˆœ ì¿¼ë¦¬ ì‚¬ìš©)
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                thirtyDaysAgo.setHours(0, 0, 0, 0); // ë‚ ì§œë§Œ ë¹„êµí•˜ê¸° ìœ„í•´ ì‹œê°„ ì´ˆê¸°í™”
                const thirtyDaysAgoStr = thirtyDaysAgo.toISOString().split('T')[0];

                const logsSnapshot = await db.collection('routine_logs')
                    .where('userId', '==', currentUser.uid)
                    .get(); // ë‚ ì§œ í•„í„°ë§ì€ JSì—ì„œ ìˆ˜í–‰

                // ë‚ ì§œë³„ ì™„ë£Œ ë°ì´í„° ì •ë¦¬ (JavaScriptì—ì„œ í•„í„°ë§)
                const dailyCompletions = {};
                const totalRoutinesPerDay = {};

                logsSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const date = data.date;
                    
                    // 30ì¼ ì´ë‚´ ë°ì´í„°ë§Œ ì²˜ë¦¬
                    if (date >= thirtyDaysAgoStr) {
                        if (!dailyCompletions[date]) {
                            dailyCompletions[date] = 0;
                            totalRoutinesPerDay[date] = 0;
                        }
                        
                        // í•´ë‹¹ ë‚ ì§œì— ë£¨í‹´ì´ í‘œì‹œë˜ì–´ì•¼ í•˜ëŠ”ì§€ í™•ì¸ (ì¤‘ë³µ ê³„ì‚° ë°©ì§€)
                        // ì´ ë¶€ë¶„ì€ ë£¨í‹´ ìì²´ì˜ frequencyë¥¼ í™•ì¸í•´ì•¼ ì •í™•í•˜ì§€ë§Œ,
                        // ì—¬ê¸°ì„œëŠ” logì— ê¸°ë¡ëœ ëª¨ë“  ë£¨í‹´ì„ ëŒ€ìƒìœ¼ë¡œ í•¨.
                        // ì •í™•ë„ë¥¼ ë†’ì´ë ¤ë©´ í•´ë‹¹ ë‚ ì§œì˜ ëª¨ë“  ë£¨í‹´ì„ ë¶ˆëŸ¬ì™€ì•¼ í•¨. (ë³µì¡ë„ ì¦ê°€)
                        // í˜„ì¬ëŠ” ë¡œê·¸ì— ê¸°ë¡ëœ ë£¨í‹´ì˜ ì™„ë£Œ ì—¬ë¶€ë§Œìœ¼ë¡œ ì§‘ê³„.
                        totalRoutinesPerDay[date]++; 
                        if (data.completed) {
                            dailyCompletions[date]++;
                        }
                    }
                });

                // í˜„ì¬ ì‚¬ìš©ì í¬ì¸íŠ¸ ë¡œë“œ
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (userDoc.exists) {
                    userPoints = userDoc.data().points || 0;
                }

                // ì—°ì† ì¼ìˆ˜ ê³„ì‚°
                userStats.currentStreak = calculateCurrentStreak(dailyCompletions, totalRoutinesPerDay);
                userStats.bestStreak = calculateBestStreak(dailyCompletions, totalRoutinesPerDay);
                userStats.totalDays = Object.keys(dailyCompletions).length;

                // ì£¼ê°„ ì ìˆ˜ ê³„ì‚° (ì´ë²ˆ ì£¼)
                userStats.weeklyScore = calculateWeeklyScore(dailyCompletions, totalRoutinesPerDay);

                // ì „ì²´ ì™„ë£Œìœ¨ ê³„ì‚°
                let totalCompleted = 0;
                let totalPossible = 0;
                Object.keys(dailyCompletions).forEach(date => {
                    totalCompleted += dailyCompletions[date];
                    totalPossible += totalRoutinesPerDay[date];
                });
                userStats.completionRate = totalPossible > 0 ? Math.round((totalCompleted / totalPossible) * 100) : 0;

                // UI ì—…ë°ì´íŠ¸
                updateStatsUI();

            } catch (error) {
                console.error('âŒ í†µê³„ ë¡œë“œ ì˜¤ë¥˜:', error);
                if (error.code === 'permission-denied') {
                    console.warn('âš ï¸ Firebase ê¶Œí•œ ì˜¤ë¥˜ - Firestore ë³´ì•ˆ ê·œì¹™ì„ í™•ì¸í•˜ì„¸ìš”');
                }
            }
        }

        // í˜„ì¬ ì—°ì† ì¼ìˆ˜ ê³„ì‚°
        function calculateCurrentStreak(dailyCompletions, totalRoutinesPerDay) {
            const today = new Date();
            let streak = 0;
            
            for (let i = 0; i < 30; i++) { // ìµœê·¼ 30ì¼ë§Œ í™•ì¸
                const checkDate = new Date(today);
                checkDate.setDate(today.getDate() - i);
                const dateStr = checkDate.toISOString().split('T')[0];
                
                if (dailyCompletions[dateStr] && totalRoutinesPerDay[dateStr]) {
                    const completionRate = dailyCompletions[dateStr] / totalRoutinesPerDay[dateStr];
                    if (completionRate >= 0.8) { // 80% ì´ìƒ ì™„ë£Œ ì‹œ ì„±ê³µí•œ ë‚ ë¡œ ê°„ì£¼
                        streak++;
                    } else {
                        break;
                    }
                } else if (i === 0) { // ì˜¤ëŠ˜ ì•„ë¬´ê²ƒë„ ì•ˆ í–ˆìœ¼ë©´ ìŠ¤íŠ¸ë¦­ 0
                    break;
                } else { // ê³¼ê±° ë‚ ì§œì— ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ìŠ¤íŠ¸ë¦­ ì¤‘ë‹¨
                    break;
                }
            }
            
            return streak;
        }

        // ìµœê³  ì—°ì† ì¼ìˆ˜ ê³„ì‚°
        function calculateBestStreak(dailyCompletions, totalRoutinesPerDay) {
            const dates = Object.keys(dailyCompletions).sort();
            let bestStreak = 0;
            let currentStreak = 0;
            
            dates.forEach(date => {
                if (dailyCompletions[date] && totalRoutinesPerDay[date]) {
                    const completionRate = dailyCompletions[date] / totalRoutinesPerDay[date];
                    if (completionRate >= 0.8) {
                        currentStreak++;
                        bestStreak = Math.max(bestStreak, currentStreak);
                    } else {
                        currentStreak = 0;
                    }
                } else {
                    currentStreak = 0;
                }
            });
            
            return bestStreak;
        }

        // ì£¼ê°„ ì ìˆ˜ ê³„ì‚°
        function calculateWeeklyScore(dailyCompletions, totalRoutinesPerDay) {
            const today = new Date();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay()); // ì´ë²ˆ ì£¼ ì¼ìš”ì¼
            
            let weekScore = 0;
            let daysCounted = 0;
            for (let i = 0; i < 7; i++) {
                const checkDate = new Date(startOfWeek);
                checkDate.setDate(startOfWeek.getDate() + i);
                const dateStr = checkDate.toISOString().split('T')[0];
                
                if (dailyCompletions[dateStr] && totalRoutinesPerDay[dateStr]) {
                    const completionRate = dailyCompletions[dateStr] / totalRoutinesPerDay[dateStr];
                    weekScore += Math.round(completionRate * 100);
                    daysCounted++;
                } else if (checkDate < today) { // ì˜¤ëŠ˜ ì´ì „ì˜ ë°ì´í„° ì—†ëŠ” ë‚ ì€ 0ì ìœ¼ë¡œ ì²˜ë¦¬
                     daysCounted++;
                }
            }
            
            return daysCounted > 0 ? Math.round(weekScore / daysCounted) : 0; // ì£¼ê°„ í‰ê· 
        }

        // í†µê³„ UI ì—…ë°ì´íŠ¸
        function updateStatsUI() {
            const currentStreakEl = document.getElementById('currentStreak');
            const todayProgressEl = document.getElementById('todayProgress');
            const currentPointsEl = document.getElementById('currentPoints'); // í¬ì¸íŠ¸ í‘œì‹œ ì—˜ë¦¬ë¨¼íŠ¸
            const sleepHoursEl = document.getElementById('sleepHours'); // ìˆ˜ë©´ ì‹œê°„ ì—˜ë¦¬ë¨¼íŠ¸

            if (currentStreakEl) currentStreakEl.textContent = userStats.currentStreak;
            if (currentPointsEl) currentPointsEl.textContent = userPoints; // í¬ì¸íŠ¸ ì—…ë°ì´íŠ¸
            if (sleepHoursEl) sleepHoursEl.textContent = userStats.sleepDuration || '-'; // ìˆ˜ë©´ ì‹œê°„ ì—…ë°ì´íŠ¸

            // ì˜¤ëŠ˜ ì§„í–‰ë¥  ê³„ì‚°
            calculateTodayProgress().then(progress => {
                if (todayProgressEl) todayProgressEl.textContent = `${progress}%`;
            });

            // í†µê³„ í˜ì´ì§€ ì—…ë°ì´íŠ¸
            const totalDaysEl = document.getElementById('totalDays');
            const bestStreakEl = document.getElementById('bestStreak');
            const completionRateEl = document.getElementById('completionRate');
            const rewardPointsDisplayEl = document.getElementById('rewardPointsDisplay'); // ë³´ìƒ í˜ì´ì§€ í¬ì¸íŠ¸

            if (totalDaysEl) totalDaysEl.textContent = userStats.totalDays;
            if (bestStreakEl) bestStreakEl.textContent = userStats.bestStreak;
            if (completionRateEl) completionRateEl.textContent = `${userStats.completionRate}%`;
            if (rewardPointsDisplayEl) rewardPointsDisplayEl.textContent = userPoints; // ë³´ìƒ í˜ì´ì§€ í¬ì¸íŠ¸ ì—…ë°ì´íŠ¸
        }

        // ì˜¤ëŠ˜ ì§„í–‰ë¥  ê³„ì‚°
        async function calculateTodayProgress() {
            if (!currentUser || !familyId) return 0;

            try {
                // ì˜¤ëŠ˜ í•´ì•¼ í•  ë£¨í‹´ë“¤ ê°€ì ¸ì˜¤ê¸°
                const routinesSnapshot = await db.collection('routines')
                    .where('userId', '==', currentUser.uid)
                    .where('familyId', '==', familyId)
                    .get();

                let totalTodayRoutines = 0;
                routinesSnapshot.docs.forEach(doc => {
                    const routine = doc.data();
                    if (shouldShowRoutineToday(routine)) {
                        totalTodayRoutines++;
                    }
                });

                if (totalTodayRoutines === 0) return 100;

                const completedCount = todayCompletedRoutines.size;
                return Math.round((completedCount / totalTodayRoutines) * 100);

            } catch (error) {
                console.error('âŒ ì˜¤ëŠ˜ ì§„í–‰ë¥  ê³„ì‚° ì˜¤ë¥˜:', error);
                return 0;
            }
        }

        // ì£¼ê°„ ìº˜ë¦°ë” ìƒì„±
        async function loadWeekCalendar() {
            const weekCalendar = document.getElementById('weekCalendar');
            if (!weekCalendar) return;

            const today = new Date();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay()); // ì´ë²ˆ ì£¼ ì¼ìš”ì¼

            weekCalendar.innerHTML = '';

            const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];

            for (let i = 0; i < 7; i++) {
                const date = new Date(startOfWeek);
                date.setDate(startOfWeek.getDate() + i);
                const dateStr = date.toISOString().split('T')[0];
                const isToday = dateStr === today.toISOString().split('T')[0];

                // í•´ë‹¹ ë‚ ì§œì˜ ì™„ë£Œìœ¨ ê³„ì‚°
                const completionRate = await getDayCompletionRate(dateStr);

                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';
                if (isToday) dayEl.classList.add('today');

                let levelClass = 'level-0';
                if (completionRate === 100) levelClass = 'level-100'; // 100% ì™„ë£Œ
                else if (completionRate >= 80) levelClass = 'level-80'; // 80% ì´ìƒ
                else if (completionRate > 0) levelClass = 'level-1'; // 1% ì´ìƒ

                dayEl.innerHTML = `
                    <div class="day-name">${dayNames[i]}</div>
                    <div class="day-number">${date.getDate()}</div>
                    <div class="day-progress-bar"><div class="day-progress ${levelClass}" style="width: ${completionRate}%;"></div></div>
                `;
                dayEl.querySelector('.day-progress').style.backgroundColor = ''; // Remove inline style for progress bar fill

                weekCalendar.appendChild(dayEl);
            }
        }

        // íŠ¹ì • ë‚ ì§œì˜ ì™„ë£Œìœ¨ ê³„ì‚°
        async function getDayCompletionRate(dateStr) {
            if (!currentUser || !familyId) return 0;

            try {
                const logsSnapshot = await db.collection('routine_logs')
                    .where('userId', '==', currentUser.uid)
                    .where('date', '==', dateStr)
                    .get();

                let totalRoutines = 0;
                let completedRoutines = 0;

                // í•´ë‹¹ ë‚ ì§œì— í‘œì‹œë˜ì–´ì•¼ í•˜ëŠ” ë£¨í‹´ì˜ ì´ ê°œìˆ˜ë¥¼ ê³„ì‚°
                const routinesSnapshot = await db.collection('routines')
                    .where('userId', '==', currentUser.uid)
                    .where('familyId', '==', familyId)
                    .get();
                
                const dateObj = new Date(dateStr);
                const dayOfWeek = dateObj.getDay(); // 0: ì¼ìš”ì¼, 1: ì›”ìš”ì¼, ..., 6: í† ìš”ì¼

                routinesSnapshot.docs.forEach(doc => {
                    const routine = doc.data();
                    let shouldCount = false;
                    switch (routine.frequency) {
                        case 'daily':
                            shouldCount = true;
                            break;
                        case 'weekday':
                            shouldCount = dayOfWeek >= 1 && dayOfWeek <= 5;
                            break;
                        case 'weekend':
                            shouldCount = dayOfWeek === 0 || dayOfWeek === 6;
                            break;
                        case 'none': // 'ë°˜ë³µ ì—†ìŒ' ë£¨í‹´ì€ íŠ¹ì • ë‚ ì§œì—ë§Œ í•´ë‹¹
                            if (routine.date === dateStr) {
                                shouldCount = true;
                            }
                            break;
                    }
                    if (shouldCount) {
                        totalRoutines++;
                    }
                });

                logsSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    if (data.completed) {
                        completedRoutines++;
                    }
                });

                return totalRoutines > 0 ? Math.round((completedRoutines / totalRoutines) * 100) : 0;

            } catch (error) {
                console.error('âŒ ë‚ ì§œë³„ ì™„ë£Œìœ¨ ê³„ì‚° ì˜¤ë¥˜:', error);
                return 0;
            }
        }

        // í™ˆ í˜ì´ì§€ ë£¨í‹´ ë¡œë“œ
        async function loadHomeRoutines() {
            const routineListIncomplete = document.getElementById('todayIncompleteRoutineList');
            const routineListComplete = document.getElementById('todayCompleteRoutineList');
            const routineListSkipped = document.getElementById('todaySkippedRoutineList');
            const emptyStateToday = document.getElementById('emptyStateToday');
            const completedSection = document.getElementById('completed-section');
            const skippedSection = document.getElementById('skipped-section');

            if (!routineListIncomplete || !routineListComplete || !routineListSkipped || !emptyStateToday || !completedSection || !skippedSection) {
                console.error('âŒ í™ˆ í˜ì´ì§€ ë£¨í‹´ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            if (!currentUser) {
                routineListIncomplete.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ‘¤</div>
                        <div class="empty-state-title">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</div>
                        <div class="empty-state-description">ë£¨í‹´ì„ í™•ì¸í•˜ë ¤ë©´ ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”</div>
                    </div>
                `;
                routineListComplete.innerHTML = '';
                routineListSkipped.innerHTML = '';
                completedSection.style.display = 'none';
                skippedSection.style.display = 'none';
                emptyStateToday.style.display = 'block';
                return;
            }

            routineListIncomplete.innerHTML = '<div class="loading-message">ë£¨í‹´ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
            routineListComplete.innerHTML = '';
            routineListSkipped.innerHTML = '';
            completedSection.style.display = 'none';
            skippedSection.style.display = 'none';
            emptyStateToday.style.display = 'none';

            try {
                if (!familyId) {
                    routineListIncomplete.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</div>
                            <div class="empty-state-title">ê°€ì¡± ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤</div>
                            <div class="empty-state-description">ê´€ë¦¬ íƒ­ì—ì„œ ë£¨í‹´ì„ ì¶”ê°€í•˜ê±°ë‚˜ ê°€ì¡±ì— ì°¸ì—¬í•´ì£¼ì„¸ìš”</div>
                        </div>
                    `;
                    emptyStateToday.style.display = 'block';
                    return;
                }

                // ì‚¬ìš©ìì˜ ë£¨í‹´ë“¤ ê°€ì ¸ì˜¤ê¸°
                const routinesSnapshot = await db.collection('routines')
                    .where('userId', '==', currentUser.uid)
                    .where('familyId', '==', familyId)
                    .get();

                // ì˜¤ëŠ˜ ì™„ë£Œëœ ë£¨í‹´ë“¤ í™•ì¸
                await loadTodayCompletedRoutines();

                // í†µê³„ ë¡œë“œ
                await loadUserStats();

                // ì£¼ê°„ ìº˜ë¦°ë” ë¡œë“œ
                await loadWeekCalendar();

                routineListIncomplete.innerHTML = '';
                routineListComplete.innerHTML = '';
                routineListSkipped.innerHTML = '';


                if (routinesSnapshot.empty) {
                    routineListIncomplete.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“</div>
                            <div class="empty-state-title">ì•„ì§ ë£¨í‹´ì´ ì—†ìŠµë‹ˆë‹¤</div>
                            <div class="empty-state-description">ê´€ë¦¬ íƒ­ì—ì„œ ìƒˆë¡œìš´ ë£¨í‹´ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!</div>
                        </div>
                    `;
                    emptyStateToday.style.display = 'block';
                    return;
                }

                // ì‹œê°„ëŒ€ë³„ë¡œ ë£¨í‹´ ì •ë¦¬
                const routinesByTime = {
                    morning: [],
                    afternoon: [],
                    evening: []
                };

                // ë£¨í‹´ ë°ì´í„°ë¥¼ ë°°ì—´ë¡œ ë³€í™˜í•˜ê³  orderë¡œ ì •ë ¬
                const routineArray = [];
                routinesSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const routine = {
                        id: doc.id,
                        ...data
                    };
                    routineArray.push(routine);
                });

                // order í•„ë“œë¡œ ì •ë ¬ (ì—†ìœ¼ë©´ ìƒì„±ì¼ ìˆœ)
                routineArray.sort((a, b) => {
                    const orderA = a.order || (a.createdAt ? a.createdAt.toMillis() : 0);
                    const orderB = b.order || (b.createdAt ? b.createdAt.toMillis() : 0);
                    return orderA - orderB;
                });

                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];

                const incompleteRoutines = [];
                const completeRoutines = [];
                const skippedRoutines = [];

                routineArray.forEach(routine => {
                    // Check if routine applies to today based on frequency
                    if (shouldShowRoutineToday(routine, today)) {
                        // Check if it's a 'none' frequency routine and its date is today
                        if (routine.frequency === 'none' && routine.date !== todayStr) {
                            return; // Skip if 'none' and not today's date
                        }

                        // Check its status for today
                        const isCompleted = todayCompletedRoutines.has(routine.id);
                        const isSkipped = routine.status === 'skipped' && routine.date === todayStr; // Only if skipped today

                        if (isSkipped) {
                            skippedRoutines.push(routine);
                        } else if (isCompleted) {
                            completeRoutines.push(routine);
                        } else {
                            incompleteRoutines.push(routine);
                        }
                    }
                });

                // Render lists
                incompleteRoutines.forEach(routine => routineListIncomplete.appendChild(createRoutineElement(routine)));
                completeRoutines.forEach(routine => routineListComplete.appendChild(createRoutineElement(routine)));
                skippedRoutines.forEach(routine => routineListSkipped.appendChild(createRoutineElement(routine)));

                // Show/hide sections
                completedSection.style.display = completeRoutines.length > 0 ? 'block' : 'none';
                skippedSection.style.display = skippedRoutines.length > 0 ? 'block' : 'none';
                emptyStateToday.style.display = (incompleteRoutines.length === 0 && completeRoutines.length === 0 && skippedRoutines.length === 0) ? 'block' : 'none';


            } catch (error) {
                console.error('âŒ í™ˆ ë£¨í‹´ ë¡œë“œ ì˜¤ë¥˜:', error);
                
                showStatus('ë£¨í‹´ ë¡œë“œ ì‹¤íŒ¨: ' + error.message, 5000);
                
                if (error.code === 'permission-denied') {
                    routineListIncomplete.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ”’</div>
                            <div class="empty-state-title">ë°ì´í„°ë² ì´ìŠ¤ ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤</div>
                            <div class="empty-state-description">Firebase ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”</div>
                        </div>
                    `;
                } else {
                    routineListIncomplete.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">âš ï¸</div>
                            <div class="empty-state-title">ë£¨í‹´ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</div>
                            <div class="empty-state-description">ì˜¤ë¥˜: ${error.message}</div>
                        </div>
                    `;
                }
            }
        }

        // ì˜¤ëŠ˜ ì™„ë£Œëœ ë£¨í‹´ë“¤ ë¡œë“œ
        async function loadTodayCompletedRoutines() {
            const today = new Date().toISOString().split('T')[0];
            
            try {
                const logsSnapshot = await db.collection('routine_logs')
                    .where('userId', '==', currentUser.uid)
                    .where('date', '==', today)
                    .get();

                todayCompletedRoutines.clear();
                logsSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    if (data.completed) {
                        todayCompletedRoutines.add(data.routineId);
                    }
                });

                console.log('ğŸ“‹ ì˜¤ëŠ˜ ì™„ë£Œëœ ë£¨í‹´ë“¤:', Array.from(todayCompletedRoutines));
            } catch (error) {
                console.error('âŒ ì™„ë£Œëœ ë£¨í‹´ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ë£¨í‹´ì´ ì˜¤ëŠ˜ í‘œì‹œë˜ì–´ì•¼ í•˜ëŠ”ì§€ í™•ì¸
        function shouldShowRoutineToday(routine, date = new Date()) {
            const dayOfWeek = date.getDay(); // 0: ì¼ìš”ì¼, 1: ì›”ìš”ì¼, ..., 6: í† ìš”ì¼
            const routineDate = routine.date ? new Date(routine.date) : null;
            const todayDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());

            switch (routine.frequency) {
                case 'daily':
                    return true;
                case 'weekday':
                    return dayOfWeek >= 1 && dayOfWeek <= 5; // ì›”-ê¸ˆ
                case 'weekend':
                    return dayOfWeek === 0 || dayOfWeek === 6; // í† -ì¼
                case 'none':
                    // 'ë°˜ë³µ ì—†ìŒ' ë£¨í‹´ì€ ì •í™•íˆ í•´ë‹¹ ë‚ ì§œì—ë§Œ í‘œì‹œ
                    return routineDate && routineDate.getTime() === todayDate.getTime();
                default:
                    return true;
            }
        }

        // ë£¨í‹´ ìš”ì†Œ ìƒì„± (UI ë³µì‚¬ë³¸ì— ë§ì¶° ìˆ˜ì •)
        function createRoutineElement(routine) {
            const wrapper = document.createElement('div');
            wrapper.className = 'routine-item-wrapper';

            const item = document.createElement('div');
            item.className = 'routine-item';
            item.dataset.id = routine.id;
            item.dataset.ruleId = routine.ruleId || '';
            item.dataset.routineType = routine.routineType;
            item.dataset.isVirtual = routine.isVirtual || false;
            item.dataset.date = routine.date;

            const isCompleted = routine.status === 'completed' || (routine.status !== 'skipped' && routine.value !== null && routine.value !== false);
            const isSkipped = routine.status === 'skipped';
            const isCarryOver = routine.isCarryOver || false;

            if (isCompleted) item.classList.add('completed');
            if (isSkipped) item.classList.add('skipped');
            if (isCarryOver) item.classList.add('carry-over');
            if (routine.isVirtual) item.style.opacity = '0.7'; // ê°€ìƒ ë£¨í‹´ì€ íˆ¬ëª…ë„ ì ìš©

            const valueDisplay = getRoutineValueDisplay(routine);
            
            let actionContent = '';
            if (routine.routineType === 'task') {
                actionContent = isCompleted ? '<i class="fas fa-check"></i>' : '';
            } else {
                if (isCompleted) {
                    actionContent = '<i class="fas fa-check"></i>';
                } else if (isSkipped) {
                    actionContent = '<i class="fas fa-forward"></i>';
                } else {
                    const icons = { 'timestamp': 'fa-clock', 'number': 'fa-keyboard', 'timer': 'fa-play' };
                    actionContent = `<i class="fas ${icons[routine.routineType]}"></i>`;
                }
            }

            item.innerHTML = `
                <div class="${routine.routineType === 'task' ? 'checkbox' : 'action-button'}" role="button">${actionContent}</div>
                <div class="routine-content">
                    <span class="routine-name">${routine.name}</span>
                    <div class="routine-details">${routine.timePeriod} | ${routine.category}</div>
                </div>
                <div class="routine-value" style="font-weight:500;">${valueDisplay}</div>
                ${routine.streak > 0 ? `<div class="streak-badge"><i class="fas fa-fire"></i>${routine.streak}</div>` : ''}
            `;
            
            const actionTarget = item.querySelector('.checkbox, .action-button');
            if (!isSkipped) { // ê±´ë„ˆë›´ ë£¨í‹´ì€ í´ë¦­ ì•¡ì…˜ ë¹„í™œì„±í™” (ìŠ¤ì™€ì´í”„ë¡œë§Œ ë³µêµ¬)
                addTouchEventListener(actionTarget, () => handleRoutineAction(routine));
            }

            const actions = document.createElement('div');
            actions.className = 'routine-item-actions';
            if (isSkipped) {
                actions.innerHTML = `<button class="swipe-action-btn unskip">ë³µêµ¬</button>`;
                addTouchEventListener(actions.querySelector('.unskip'), () => handleRoutineStatusUpdate(routine, null));
            } else {
                actions.innerHTML = `<button class="swipe-action-btn skip">ê±´ë„ˆë›°ê¸°</button>`;
                addTouchEventListener(actions.querySelector('.skip'), () => handleRoutineStatusUpdate(routine, 'skipped'));
            }
            
            wrapper.appendChild(item);
            wrapper.appendChild(actions);

            addSwipeEvents(wrapper);

            return wrapper;
        }

        // ìˆ«ì ë£¨í‹´ ì—…ë°ì´íŠ¸ (íœ  í”¼ì»¤ ì‚¬ìš©)
        async function updateRoutineNumber(routineId, button) {
            const numberInput = document.getElementById('numberInput'); // Get the input from the modal
            const value = numberInput.value;
            
            if (!value || parseFloat(value) === 0) { // Check for empty or zero
                showNotification('0ë³´ë‹¤ í° ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            await updateRoutine(routineId, parseFloat(value)); // Parse to float for number type
        }

        // ì‹œê°„ ë£¨í‹´ ì—…ë°ì´íŠ¸
        async function updateRoutineTime(routineId, button) {
            const timeInput = document.getElementById('timeInput'); // Get the input from the modal
            const value = timeInput.value;
            
            if (!value || value === '') {
                showNotification('ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            await updateRoutine(routineId, value);
        }

        // ë£¨í‹´ ì—…ë°ì´íŠ¸ (í¬ì¸íŠ¸ ë¶€ì—¬ ë¡œì§ ì¶”ê°€)
        async function updateRoutine(routineId, value) {
            if (!currentUser) return;
            
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            const logDocRef = db.collection('routine_logs').doc(`${routineId}_${currentUser.uid}_${todayStr}`);

            // ë£¨í‹´ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (í¬ì¸íŠ¸ ê³„ì‚°ì„ ìœ„í•´)
            const routineDoc = await db.collection('routines').doc(routineId).get();
            const routineData = routineDoc.data();
            
            if (!routineData) {
                console.error('ë£¨í‹´ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', routineId);
                showNotification('ë£¨í‹´ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            let pointsToAdd = 0;
            let currentLog = (await logDocRef.get()).data();
            let wasCompletedBefore = currentLog && currentLog.completed && currentLog.value !== false;

            if (value !== false && !wasCompletedBefore) { // ìƒˆë¡œ ì™„ë£Œëœ ê²½ìš°ì—ë§Œ í¬ì¸íŠ¸ ë¶€ì—¬
                switch (routineData.type) {
                    case 'task':
                        pointsToAdd = 10;
                        break;
                    case 'number':
                        pointsToAdd = (typeof value === 'number' ? value : 0) * 5; // ë¬¼ 1ì”ë‹¹ 5í¬ì¸íŠ¸
                        break;
                    case 'timestamp':
                    case 'timer':
                        pointsToAdd = 15;
                        break;
                }
            } else if (value === false && wasCompletedBefore) { // ì™„ë£Œ ì·¨ì†Œ ì‹œ í¬ì¸íŠ¸ íšŒìˆ˜ (ì„ íƒ ì‚¬í•­)
                // ì´ ë¶€ë¶„ì€ ë³µì¡í•´ì§ˆ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ì´ˆê¸° ë²„ì „ì—ì„œëŠ” í¬ì¸íŠ¸ íšŒìˆ˜ ë¡œì§ì€ ì œì™¸
                // í•„ìš”í•˜ë‹¤ë©´, ë¡œê·¸ì—ì„œ ì´ì „ ê°’ì„ ì°¾ì•„ ì°¨ê°í•˜ëŠ” ë¡œì§ ì¶”ê°€
                // pointsToAdd = - (ì´ì „ í¬ì¸íŠ¸ ê³„ì‚° ê°’);
            }

            const logData = {
                routineId: routineId,
                userId: currentUser.uid,
                familyId: familyId,
                value: value,
                completed: value !== false, // falseê°€ ì•„ë‹ˆë©´ ì™„ë£Œë¡œ ê°„ì£¼
                date: todayStr,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await logDocRef.set(logData);
                
                if (pointsToAdd > 0) {
                    // ì‚¬ìš©ì í¬ì¸íŠ¸ ì—…ë°ì´íŠ¸
                    const userRef = db.collection('users').doc(currentUser.uid);
                    await userRef.update({
                        points: firebase.firestore.FieldValue.increment(pointsToAdd)
                    });
                    userPoints += pointsToAdd; // UI ë³€ìˆ˜ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                    showNotification(`âœ… ë£¨í‹´ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! +${pointsToAdd}í¬ì¸íŠ¸ íšë“!`);
                } else if (value !== false) {
                    showNotification('âœ… ë£¨í‹´ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                } else {
                    showNotification('ï¿½ ë£¨í‹´ì„ ê±´ë„ˆë›°ì—ˆìŠµë‹ˆë‹¤.');
                }

                if (value !== false) {
                    todayCompletedRoutines.add(routineId);
                } else {
                    todayCompletedRoutines.delete(routineId);
                }
                
                // UI ì—…ë°ì´íŠ¸
                loadHomeRoutines();
                updateStatsUI(); // í¬ì¸íŠ¸ ì—…ë°ì´íŠ¸ ë°˜ì˜
                
                // ìŠ¤íŠ¸ë¦­ ì²´í¬ ë° ì¶•í•˜ ë©”ì‹œì§€
                checkForAchievements();
                
            } catch (error) {
                console.error('ë£¨í‹´ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
                showNotification('ë£¨í‹´ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ì„±ì·¨ í™•ì¸ ë° ì¶•í•˜
        async function checkForAchievements() {
            // í†µê³„ ë‹¤ì‹œ ë¡œë“œ
            await loadUserStats();
            
            // ìƒˆë¡œìš´ ìŠ¤íŠ¸ë¦­ ê¸°ë¡ ë‹¬ì„± ì‹œ
            if (userStats.currentStreak > 0 && userStats.currentStreak === userStats.bestStreak) {
                if (userStats.currentStreak % 7 === 0) { // 7ì¼ ë‹¨ìœ„ë¡œ ì¶•í•˜
                    showAchievementModal(
                        `ğŸ”¥ ${userStats.currentStreak}ì¼ ì—°ì† ë‹¬ì„±!`,
                        'ì •ë§ ëŒ€ë‹¨í•´ìš”! ê¾¸ì¤€í•¨ì´ ìŠµê´€ì´ ë˜ê³  ìˆì–´ìš”.'
                    );
                } else if ([3, 5, 10, 30, 100].includes(userStats.currentStreak)) {
                    showAchievementModal(
                        `ğŸ‰ ${userStats.currentStreak}ì¼ ì—°ì† ë‹¬ì„±!`,
                        'ë©‹ì§„ ê¸°ë¡ì´ì—ìš”! ê³„ì† ì´ì–´ë‚˜ê°€ì„¸ìš”.'
                    );
                }
            }
            
            // ì˜¤ëŠ˜ ëª¨ë“  ë£¨í‹´ ì™„ë£Œ ì‹œ
            const todayProgress = await calculateTodayProgress();
            if (todayProgress === 100) {
                setTimeout(() => {
                    showAchievementModal(
                        'ğŸ† ì˜¤ëŠ˜ì˜ ë¯¸ì…˜ ì™„ë£Œ!',
                        'ëª¨ë“  ë£¨í‹´ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. í›Œë¥­í•´ìš”!'
                    );
                }, 1000);
            }
        }

        // ì„±ì·¨ ëª¨ë‹¬ í‘œì‹œ
        function showAchievementModal(title, description) {
            const modal = document.getElementById('achievementModal');
            const titleEl = document.getElementById('achievementTitle');
            const descEl = document.getElementById('achievementDesc');
            
            if (titleEl) titleEl.textContent = title;
            if (descEl) descEl.textContent = description;
            
            modal.style.display = 'flex'; // Changed to flex
            
            setTimeout(() => {
                const content = modal.querySelector('.achievement-content');
                if (content) {
                    content.style.animation = 'fadeInUp 0.5s ease-out';
                }
            }, 10);
        }

        // ì„±ì·¨ ëª¨ë‹¬ ë‹«ê¸°
        function closeAchievementModal() {
            const modal = document.getElementById('achievementModal');
            const modalContent = modal.querySelector('.achievement-content');
            
            // ì• ë‹ˆë©”ì´ì…˜ ì—­ì¬ìƒ í›„ ìˆ¨ê¸°ê¸°
            if (modalContent) {
                modalContent.style.animation = 'fadeInUp 0.3s ease-out reverse forwards'; // 'forwards' ì¶”ê°€
            }
            
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300); // ì• ë‹ˆë©”ì´ì…˜ ì‹œê°„ê³¼ ì¼ì¹˜
        }

        // í†µê³„ í˜ì´ì§€ ë¡œë“œ
        function loadStatsPage() {
            console.log('ğŸ“ˆ í†µê³„ í˜ì´ì§€ ë¡œë“œ');
            loadUserStats();
            loadMonthlyHeatmap();
            loadRoutineStats();
        }

        // ì›”ê°„ íˆíŠ¸ë§µ ë¡œë“œ
        async function loadMonthlyHeatmap() {
            const container = document.getElementById('heatmapContainer');
            if (!container) return;

            container.innerHTML = '<div class="loading-message">íˆíŠ¸ë§µì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

            try {
                const today = new Date();
                const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);

                const heatmapHTML = [];
                const currentDate = new Date(firstDay);

                while (currentDate <= lastDay) {
                    const dateStr = currentDate.toISOString().split('T')[0];
                    const completionRate = await getDayCompletionRate(dateStr);
                    
                    let level = 0;
                    if (completionRate === 100) level = 100;
                    else if (completionRate >= 80) level = 80;
                    else if (completionRate > 0) level = 1;
                    else level = 0; // 0%

                    heatmapHTML.push(`
                        <div class="heatmap-day" data-level="${level}" title="${dateStr}: ${completionRate}%">
                            ${currentDate.getDate()}
                        </div>
                    `);

                    currentDate.setDate(currentDate.getDate() + 1);
                }

                container.innerHTML = `<div class="heatmap-grid">${heatmapHTML.join('')}</div>`;

            } catch (error) {
                console.error('âŒ íˆíŠ¸ë§µ ë¡œë“œ ì˜¤ë¥˜:', error);
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">âš ï¸</div><div class="empty-state-title">íˆíŠ¸ë§µì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div></div>';
            }
        }

        // ë£¨í‹´ë³„ í†µê³„ ë¡œë“œ
        async function loadRoutineStats() {
            const container = document.getElementById('routineStatsContainer');
            if (!container || !currentUser || !familyId) return;

            try {
                const routinesSnapshot = await db.collection('routines')
                    .where('userId', '==', currentUser.uid)
                    .where('familyId', '==', familyId)
                    .get();

                const statsHTML = [];

                for (const doc of routinesSnapshot.docs) {
                    const routine = doc.data();
                    const routineId = doc.id;

                    // ì§€ë‚œ 30ì¼ê°„ì˜ í•´ë‹¹ ë£¨í‹´ ì™„ë£Œìœ¨ ê³„ì‚° (ì¸ë±ìŠ¤ ì˜¤ë¥˜ ë°©ì§€ë¥¼ ìœ„í•´ ë‹¨ìˆœ ì¿¼ë¦¬ ì‚¬ìš©)
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    thirtyDaysAgo.setHours(0,0,0,0);
                    const thirtyDaysAgoStr = thirtyDaysAgo.toISOString().split('T')[0];

                    const logsSnapshot = await db.collection('routine_logs')
                        .where('routineId', '==', routineId)
                        .where('userId', '==', currentUser.uid)
                        .get();

                    let totalDays = 0;
                    let completedDays = 0;

                    // JavaScriptì—ì„œ ë‚ ì§œ í•„í„°ë§ ë° ë£¨í‹´ ì£¼ê¸° í™•ì¸
                    const todayDate = new Date();
                    for (let i = 0; i < 30; i++) { // ìµœê·¼ 30ì¼
                        const checkDate = new Date(todayDate);
                        checkDate.setDate(todayDate.getDate() - i);
                        checkDate.setHours(0,0,0,0);
                        const checkDateStr = checkDate.toISOString().split('T')[0];
                        
                        if (shouldShowRoutineToday(routine, checkDate)) { // í•´ë‹¹ ë‚ ì§œì— ë£¨í‹´ì´ í‘œì‹œë˜ì–´ì•¼ í•˜ëŠ”ì§€ í™•ì¸
                            totalDays++;
                            const logForDay = logsSnapshot.docs.find(logDoc => logDoc.data().date === checkDateStr);
                            if (logForDay && logForDay.data().completed) {
                                completedDays++;
                            }
                        }
                    }

                    const completionRate = totalDays > 0 ? Math.round((completedDays / totalDays) * 100) : 0;

                    statsHTML.push(`
                        <div class="routine-stat-card">
                            <div class="routine-stat-name">${routine.name}</div>
                            <div class="routine-stat-rate">${completionRate}%</div>
                            <div class="routine-stat-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${completionRate}%"></div>
                                </div>
                            </div>
                            <div class="routine-stat-detail">${completedDays}/${totalDays}ì¼ ì™„ë£Œ</div>
                        </div>
                    `);
                }

                container.innerHTML = statsHTML.join('');

            } catch (error) {
                console.error('âŒ ë£¨í‹´ë³„ í†µê³„ ë¡œë“œ ì˜¤ë¥˜:', error);
                if (error.code === 'permission-denied') {
                    console.warn('âš ï¸ Firebase ê¶Œí•œ ì˜¤ë¥˜ - Firestore ë³´ì•ˆ ê·œì¹™ì„ í™•ì¸í•˜ì„¸ìš”');
                }
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">âš ï¸</div><div class="empty-state-title">í†µê³„ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div></div>';
            }
        }

        // ê°€ì¡± í˜ì´ì§€ ì •ë³´ ë¡œë“œ
        async function loadFamilyPageInfo() {
            if (!currentUser || !familyId) {
                return;
            }

            try {
                if (userRole === 'parent') {
                    const familyDoc = await db.collection('families').doc(familyId).get();
                    if (familyDoc.exists) {
                        const familyData = familyDoc.data();
                        const familyCode = familyData.familyCode || familyId;
                        const memberCount = familyData.members ? familyData.members.length : 1;
                        const createdDate = familyData.createdAt ? familyData.createdAt.toDate().toLocaleDateString('ko-KR') : '-';
                        
                        const familyCodeCard = document.getElementById('familyCodeCard');
                        const familyCodeMain = document.getElementById('familyCodeMain');
                        const memberCountEl = document.getElementById('memberCount');
                        const familyCreatedDateEl = document.getElementById('familyCreatedDate');
                        
                        if (familyCodeCard && familyCodeMain) {
                            familyCodeMain.textContent = familyCode;
                            if (memberCountEl) memberCountEl.textContent = `${memberCount}ëª…`;
                            if (familyCreatedDateEl) familyCreatedDateEl.textContent = createdDate; 
                            familyCodeCard.classList.remove('hidden');
                            familyCodeCard.style.display = 'block';
                        }
                        
                        window.currentFamilyCode = familyCode;
                    }
                } else {
                    const familyCodeCard = document.getElementById('familyCodeCard');
                    if (familyCodeCard) {
                        familyCodeCard.classList.add('hidden');
                        familyCodeCard.style.display = 'none';
                    }
                }
                
                await loadFamilyMembers();
                
                // ê°€ì¡± í˜ì´ì§€ê°€ í™œì„±í™”ëœ ìƒíƒœì—ì„œëŠ” 30ì´ˆë§ˆë‹¤ ì •ë³´ ì—…ë°ì´íŠ¸
                startFamilyPageAutoRefresh();
                
            } catch (error) {
                console.error('âŒ ê°€ì¡± í˜ì´ì§€ ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ê°€ì¡± í˜ì´ì§€ ìë™ ìƒˆë¡œê³ ì¹¨
        let familyPageRefreshInterval = null;
        
        function startFamilyPageAutoRefresh() {
            // ê¸°ì¡´ ì¸í„°ë²Œ ì œê±°
            if (familyPageRefreshInterval) {
                clearInterval(familyPageRefreshInterval);
            }
            
            // 30ì´ˆë§ˆë‹¤ ê°€ì¡± êµ¬ì„±ì› ì •ë³´ ì—…ë°ì´íŠ¸
            familyPageRefreshInterval = setInterval(async () => {
                const familyPage = document.getElementById('familyPage');
                if (familyPage && familyPage.style.display === 'block') {
                    await loadFamilyMembers();
                }
            }, 30000); // 30ì´ˆë§ˆë‹¤
        }
        
        function stopFamilyPageAutoRefresh() {
            if (familyPageRefreshInterval) {
                clearInterval(familyPageRefreshInterval);
                familyPageRefreshInterval = null;
            }
        }

        // ê°€ì¡± êµ¬ì„±ì› ë¡œë“œ (ê°œì„ ëœ ë²„ì „)
        async function loadFamilyMembers() {
            if (!familyId) return;

            try {
                const familyDoc = await db.collection('families').doc(familyId).get();
                if (!familyDoc.exists) return;

                const familyData = familyDoc.data();
                const memberIds = familyData.members || [];
                
                const familyMembersContainer = document.getElementById('familyMembers');
                familyMembersContainer.innerHTML = '<div class="loading-message">ê°€ì¡± êµ¬ì„±ì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

                const memberCards = [];

                for (const memberId of memberIds) {
                    try {
                        const memberDoc = await db.collection('users').doc(memberId).get();
                        if (memberDoc.exists) {
                            const memberData = memberDoc.data();
                            
                            // í•´ë‹¹ êµ¬ì„±ì›ì˜ ì˜¤ëŠ˜ ì§„í–‰ìœ¨ ê³„ì‚°
                            const todayProgress = await calculateMemberTodayProgress(memberId);
                            
                            const memberCard = await createMemberCard(memberData, memberId, todayProgress);
                            memberCards.push(memberCard);
                        }
                    } catch (memberError) {
                        console.error('âŒ êµ¬ì„±ì› ë¡œë“œ ì˜¤ë¥˜ (' + memberId + '):', memberError);
                    }
                }

                familyMembersContainer.innerHTML = '';
                if (memberCards.length === 0) {
                    familyMembersContainer.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</div>
                            <div class="empty-state-title">ì•„ì§ ê°€ì¡± êµ¬ì„±ì›ì´ ì—†ìŠµë‹ˆë‹¤</div>
                            <div class="empty-state-description">ê°€ì¡± ì½”ë“œë¥¼ ê³µìœ í•˜ì—¬ ë‹¤ë¥¸ êµ¬ì„±ì›ì„ ì´ˆëŒ€í•˜ì„¸ìš”!</div>
                        </div>
                    `;
                } else {
                    memberCards.forEach(card => {
                        familyMembersContainer.appendChild(card);
                    });
                }

            } catch (error) {
                console.error('âŒ ê°€ì¡± êµ¬ì„±ì› ë¡œë“œ ì˜¤ë¥˜:', error);
                const familyMembersContainer = document.getElementById('familyMembers');
                familyMembersContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">âŒ</div>
                        <div class="empty-state-title">ê°€ì¡± êµ¬ì„±ì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>
                        <div class="empty-state-description">${error.message}</div>
                    </div>
                `;
            }
        }

        // ê°€ì¡± êµ¬ì„±ì›ì˜ ì˜¤ëŠ˜ ì§„í–‰ìœ¨ ê³„ì‚°
        async function calculateMemberTodayProgress(memberId) {
            try {
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                
                // í•´ë‹¹ êµ¬ì„±ì›ì˜ ë£¨í‹´ë“¤ ê°€ì ¸ì˜¤ê¸°
                const routinesSnapshot = await db.collection('routines')
                    .where('userId', '==', memberId)
                    .where('familyId', '==', familyId)
                    .get();

                let totalTodayRoutines = 0;
                const todayRoutines = [];
                
                routinesSnapshot.docs.forEach(doc => {
                    const routine = { id: doc.id, ...doc.data() };
                    if (shouldShowRoutineToday(routine, today)) { // Pass today's date for accurate filtering
                        totalTodayRoutines++;
                        todayRoutines.push(routine);
                    }
                });

                if (totalTodayRoutines === 0) {
                    return { percentage: 100, completed: 0, total: 0, routines: [] };
                }

                // ì˜¤ëŠ˜ ì™„ë£Œëœ ë£¨í‹´ë“¤ í™•ì¸
                const logsSnapshot = await db.collection('routine_logs')
                    .where('userId', '==', memberId)
                    .where('date', '==', todayStr)
                    .get();

                const completedRoutines = new Set();
                const routineResults = {};
                
                logsSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    routineResults[data.routineId] = data;
                    if (data.completed) {
                        completedRoutines.add(data.routineId);
                    }
                });

                const completedCount = completedRoutines.size;
                const percentage = Math.round((completedCount / totalTodayRoutines) * 100);

                return {
                    percentage,
                    completed: completedCount,
                    total: totalTodayRoutines,
                    routines: todayRoutines.map(routine => ({
                        ...routine,
                        result: routineResults[routine.id] || null
                    }))
                };

            } catch (error) {
                console.error('âŒ êµ¬ì„±ì› ì§„í–‰ìœ¨ ê³„ì‚° ì˜¤ë¥˜:', error);
                return { percentage: 0, completed: 0, total: 0, routines: [] };
            }
        }

        // ê°€ì¡± êµ¬ì„±ì› ì¹´ë“œ ìƒì„± (ê°œì„ ëœ ë²„ì „)
        async function createMemberCard(memberData, memberId, progress) {
            const card = document.createElement('div');
            card.className = 'member-card';
            
            const displayName = memberData.displayName || memberData.email.split('@')[0];
            const role = memberData.role === 'parent' ? 'ë¶€ëª¨' : 'ìë…€';
            const isOnline = memberId === currentUser?.uid;
            
            // ì§„í–‰ë¥ ì— ë”°ë¥¸ ìƒ‰ìƒ ê²°ì •
            let progressColor = 'var(--error)';
            if (progress.percentage >= 80) progressColor = 'var(--success)';
            else if (progress.percentage >= 60) progressColor = 'var(--warning)';
            else if (progress.percentage >= 40) progressColor = 'var(--primary-color)'; // Changed to primary-color

            card.innerHTML = `
                <div class="member-header">
                    <div class="member-info">
                        <div class="member-name">${displayName}</div>
                        <div class="member-role">${role}</div>
                    </div>
                    <div class="member-status ${isOnline ? 'online' : 'offline'}">
                        ${isOnline ? 'ONLINE' : 'OFFLINE'}
                    </div>
                </div>
                
                <div class="member-progress-summary">
                    <div class="progress-text">ì˜¤ëŠ˜ì˜ ì§„í–‰ ìƒí™©</div>
                    <div class="progress-percentage" style="color: ${progressColor}">
                        ${progress.percentage}%
                    </div>
                </div>
                
                <div class="routine-progress">
                    <div class="routine-badge completed">${progress.completed}ê°œ ì™„ë£Œ</div>
                    <div class="routine-badge pending">${progress.total - progress.completed}ê°œ ëŒ€ê¸°</div>
                    <div class="routine-badge" style="background: rgba(99, 102, 241, 0.1); color: var(--primary-color);">
                        ì´ ${progress.total}ê°œ
                    </div>
                </div>

                <div class="member-card-actions">
                    <button class="member-detail-btn touchable" data-member-id="${memberId}">
                        ğŸ“Š ìƒì„¸ë³´ê¸°
                    </button>
                </div>
            `;
            
            // ìƒì„¸ë³´ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ì¶”ê°€
            const detailBtn = card.querySelector('.member-detail-btn');
            if (detailBtn) {
                addTouchEventListener(detailBtn, function() {
                    const memberId = this.getAttribute('data-member-id');
                    showMemberDetail(memberId, memberData, progress);
                });
            }
            
            return card;
        }

        // ê°€ì¡± êµ¬ì„±ì› ìƒì„¸ë³´ê¸° ëª¨ë‹¬
        async function showMemberDetail(memberId, memberData, progress) {
            const modal = document.getElementById('memberDetailModal');
            const avatar = document.getElementById('memberDetailAvatar');
            const name = document.getElementById('memberDetailName');
            const role = document.getElementById('memberDetailRole');
            const progressRing = document.getElementById('memberProgressRing');
            const progressText = document.getElementById('memberProgressText');
            const totalRoutines = document.getElementById('memberTotalRoutines');
            const completedRoutines = document.getElementById('memberCompletedRoutines');
            const pendingRoutines = document.getElementById('memberPendingRoutines');
            const routinesList = document.getElementById('memberRoutinesList');

            // ê¸°ë³¸ ì •ë³´ ì„¤ì •
            const displayName = memberData.displayName || memberData.email.split('@')[0];
            const memberRole = memberData.role === 'parent' ? 'ë¶€ëª¨' : 'ìë…€';
            
            avatar.textContent = displayName.charAt(0).toUpperCase();
            name.textContent = displayName;
            role.textContent = memberRole;
            
            // í†µê³„ ì„¤ì •
            totalRoutines.textContent = progress.total;
            completedRoutines.textContent = progress.completed;
            pendingRoutines.textContent = progress.total - progress.completed;
            
            // ì§„í–‰ë¥  ë§ ì„¤ì •
            const circumference = 2 * Math.PI * 28; // r=28
            const strokeDasharray = (progress.percentage / 100) * circumference;
            progressRing.style.strokeDasharray = `${strokeDasharray} ${circumference}`;
            progressText.textContent = `${progress.percentage}%`;
            
            // ë£¨í‹´ ëª©ë¡ ìƒì„±
            routinesList.innerHTML = '';
            
            if (progress.routines.length === 0) {
                routinesList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“…</div>
                        <div class="empty-state-title">ì˜¤ëŠ˜ í•  ë£¨í‹´ì´ ì—†ìŠµë‹ˆë‹¤</div>
                    </div>
                `;
            } else {
                progress.routines.forEach(routine => {
                    const result = routine.result;
                    const routineItem = createRoutineResultItem(routine, result);
                    routinesList.appendChild(routineItem);
                });
            }
            
            modal.style.display = 'flex'; // Changed to flex
            
            setTimeout(() => {
                const content = modal.querySelector('.modal-content');
                if (content) {
                    content.style.animation = 'fadeInUp 0.3s ease-out';
                }
            }, 10);
        }

        // ë£¨í‹´ ê²°ê³¼ ì•„ì´í…œ ìƒì„±
        function createRoutineResultItem(routine, result) {
            const item = document.createElement('div');
            item.className = 'routine-result-item';
            
            let status = 'pending';
            let statusText = 'ëŒ€ê¸°ì¤‘';
            let valueText = '';
            let timeText = '';
            
            if (result) {
                if (result.completed && result.value !== false) {
                    status = 'completed';
                    statusText = 'ì™„ë£Œë¨';
                    
                    if (routine.type === 'task') {
                        valueText = 'âœ… ì™„ë£Œ';
                    } else if (routine.type === 'number') {
                        valueText = `ğŸ“Š ${result.value} ${routine.unit || ''}`;
                    } else if (routine.type === 'timestamp') {
                        valueText = `â° ${result.value}`;
                    } else if (routine.type === 'timer') {
                        valueText = `â±ï¸ ${routine.unit}ë¶„ ì™„ë£Œ`;
                    }
                } else {
                    status = 'skipped';
                    statusText = 'ê±´ë„ˆëœ€';
                }
                
                if (result.timestamp && result.timestamp.toDate) {
                    timeText = result.timestamp.toDate().toLocaleTimeString('ko-KR');
                }
            }
            
            item.classList.add(status);
            
            item.innerHTML = `
                <div class="routine-result-header">
                    <div class="routine-result-name">${routine.name}</div>
                    <div class="routine-result-status ${status}">${statusText}</div>
                </div>
                ${valueText ? `<div class="routine-result-value">${valueText}</div>` : ''}
                ${timeText ? `<div class="routine-result-time">ì™„ë£Œ ì‹œê°„: ${timeText}</div>` : ''}
            `;
            
            return item;
        }

        // êµ¬ì„±ì› ìƒì„¸ ëª¨ë‹¬ ë‹«ê¸°
        function closeMemberDetail() {
            const modal = document.getElementById('memberDetailModal');
            modal.style.display = 'none';
        }

        // ê°€ì¡± ì½”ë“œ ë³µì‚¬
        async function copyFamilyCode() {
            const familyCode = window.currentFamilyCode || document.getElementById('familyCodeMain').textContent;
            
            if (!familyCode || familyCode === '-') {
                showNotification('ë³µì‚¬í•  ê°€ì¡± ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            
            try {
                // navigator.clipboard.writeTextëŠ” iframeì—ì„œ ë³´ì•ˆ ë¬¸ì œë¡œ ë™ì‘í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ
                // ëŒ€ì‹  execCommandë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜, ì‚¬ìš©ìì—ê²Œ ì§ì ‘ ë³µì‚¬í•˜ë„ë¡ ì•ˆë‚´
                const tempInput = document.createElement('textarea');
                tempInput.value = familyCode;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);

                showNotification(`ğŸ‰ ê°€ì¡± ì½”ë“œ "${familyCode}"ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                
                const copyBtn = document.getElementById('copyFamilyCodeBtn');
                if (copyBtn) {
                    const originalText = copyBtn.textContent;
                    copyBtn.textContent = 'âœ… ë³µì‚¬ë¨!';
                    copyBtn.style.background = 'rgba(16, 185, 129, 0.3)';
                    
                    setTimeout(() => {
                        copyBtn.textContent = originalText;
                        copyBtn.style.background = 'rgba(255, 255, 255, 0.2)';
                    }, 2000);
                }
                
            } catch (error) {
                console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', error);
                
                const codeElement = document.getElementById('familyCodeMain');
                if (codeElement) {
                    const range = document.createRange();
                    range.selectNode(codeElement);
                    window.getSelection().removeAllRanges();
                    window.getSelection().addRange(range);
                    showNotification('ê°€ì¡± ì½”ë“œê°€ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤. Ctrl+Cë¡œ ë³µì‚¬í•˜ì„¸ìš”!', 'warning');
                }
            }
        }

        // ì¸ì¦ ì²˜ë¦¬ (ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸)
        async function handleAuth(type) {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const familyCode = document.getElementById('familyCode').value;

            if (!email || !password) {
                showNotification('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (userRole === 'child' && type === 'register' && !familyCode) {
                showNotification('ê°€ì¡± ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                let userCredential;
                
                if (type === 'login') {
                    userCredential = await auth.signInWithEmailAndPassword(email, password);
                } else {
                    userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    await createUserProfile(userCredential.user, familyCode);
                }

                showNotification('âœ¨ ì„±ê³µì ìœ¼ë¡œ ' + (type === 'login' ? 'ë¡œê·¸ì¸' : 'íšŒì›ê°€ì…') + 'ë˜ì—ˆìŠµë‹ˆë‹¤!');
                
            } catch (error) {
                console.error('ì¸ì¦ ì˜¤ë¥˜:', error);
                showNotification('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            }
        }

        // ì‚¬ìš©ì í”„ë¡œí•„ ìƒì„±
        async function createUserProfile(user, familyCode = null) {
            const userData = {
                email: user.email,
                role: userRole,
                authProvider: 'email',
                points: 0, // ì´ˆê¸° í¬ì¸íŠ¸ ì„¤ì •
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                lastActive: firebase.firestore.FieldValue.serverTimestamp()
            };

            if (userRole === 'parent') {
                const newFamilyId = generateFamilyCode();
                userData.familyId = newFamilyId;
                userData.isParent = true;

                await db.collection('families').doc(newFamilyId).set({
                    parentId: user.uid,
                    parentName: user.email.split('@')[0],
                    members: [user.uid],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    familyCode: newFamilyId
                });

                setTimeout(() => {
                    document.getElementById('generatedFamilyCode').textContent = newFamilyId;
                    document.getElementById('familyCodeDisplay').classList.remove('hidden');
                    document.getElementById('familyCodeDisplay').style.display = 'block';
                    showNotification(`ğŸ”‘ ê°€ì¡± ì½”ë“œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤: ${newFamilyId}`);
                }, 1000);
                
            } else {
                if (familyCode) {
                    const familyDoc = await db.collection('families').doc(familyCode).get();
                    if (familyDoc.exists) {
                        userData.familyId = familyCode;
                        userData.isParent = false;

                        await db.collection('families').doc(familyCode).update({
                            members: firebase.firestore.FieldValue.arrayUnion(user.uid)
                        });
                    } else {
                        throw new Error('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê°€ì¡± ì½”ë“œì…ë‹ˆë‹¤.');
                    }
                }
            }

            await db.collection('users').doc(user.uid).set(userData);
            await createDefaultRoutines(user.uid, userData.familyId);
        }

        // ê¸°ë³¸ ë£¨í‹´ ìƒì„±
        async function createDefaultRoutines(userId, familyId) {
            const defaultRoutines = [
                { name: 'ğŸŒ™ ì·¨ì¹¨ ì‹œê°„', type: 'timestamp', time: 'evening', frequency: 'daily', order: 1, unit: '' },
                { name: 'ğŸŒ… ê¸°ìƒ ì‹œê°„', type: 'timestamp', time: 'morning', frequency: 'daily', order: 2, unit: '' },
                { name: 'ğŸ’ª ìš´ë™í•˜ê¸°', type: 'task', time: 'morning', frequency: 'daily', order: 3, unit: '' },
                { name: 'ğŸ’§ ë¬¼ ë§ˆì‹œê¸° (ì”)', type: 'number', time: 'afternoon', frequency: 'daily', order: 4, unit: 'ì”' },
                { name: 'ğŸ“š ì±… ì½ê¸° (ë¶„)', type: 'timer', time: 'evening', frequency: 'daily', order: 5, unit: '30' }
            ];

            const batch = db.batch();
            defaultRoutines.forEach((routine) => {
                const routineRef = db.collection('routines').doc();
                batch.set(routineRef, {
                    ...routine,
                    userId: userId,
                    familyId: familyId,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            });

            await batch.commit();
        }

        // ë£¨í‹´ ì¶”ê°€
        async function addRoutine() {
            if (!currentUser) {
                showNotification('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
                return;
            }
            
            if (!familyId) {
                try {
                    await loadUserProfile();
                } catch (error) {
                    console.error('âŒ í”„ë¡œí•„ ì¬ë¡œë“œ ì‹¤íŒ¨:', error);
                }
            }
            
            const nameInput = document.getElementById('routineName');
            const typeInput = document.getElementById('routineType');
            const timeInput = document.getElementById('routineTime');
            const freqInput = document.getElementById('routineFreq');
            const unitInput = document.getElementById('routineUnit');
            const durationInput = document.getElementById('routineDuration');
            
            if (!nameInput) {
                showNotification('ì…ë ¥ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            
            const name = nameInput.value;
            const type = typeInput ? typeInput.value : 'task'; // Default to task
            const time = timeInput ? timeInput.value : 'morning'; // Default to morning
            const frequency = freqInput ? freqInput.value : 'daily'; // Default to daily
            let unit = '';
            if (type === 'number') {
                unit = unitInput ? unitInput.value : '';
            } else if (type === 'timer') {
                unit = durationInput ? durationInput.value : '';
            }
            
            if (!name.trim()) {
                showNotification('ë£¨í‹´ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            let userFamilyId = familyId;
            if (!userFamilyId) {
                try {
                    const userDoc = await db.collection('users').doc(currentUser.uid).get();
                    if (userDoc.exists) {
                        userFamilyId = userDoc.data().familyId;
                        familyId = userFamilyId;
                    }
                } catch (error) {
                    console.error('âŒ familyId ì¡°íšŒ ì‹¤íŒ¨:', error);
                    if (error.code === 'permission-denied') {
                        showNotification('âš ï¸ Firebase ê¶Œí•œ ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
                        return;
                    }
                }
            }

            if (!userFamilyId) {
                showNotification('ê°€ì¡± ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                const routineData = {
                    name: name.trim(),
                    type: type,
                    time: time,
                    frequency: frequency,
                    order: Date.now(), // Use timestamp for order
                    userId: currentUser.uid,
                    familyId: userFamilyId,
                    unit: unit, // Add unit to routine data
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                // For 'none' frequency, add the current date to the routine
                if (frequency === 'none') {
                    routineData.date = new Date().toISOString().split('T')[0];
                }
                
                const docRef = await db.collection('routines').add(routineData);
                
                showNotification(`âœ¨ ìƒˆ ë£¨í‹´ "${name}"ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                closeModal();
                nameInput.value = '';
                if (unitInput) unitInput.value = '';
                if (durationInput) durationInput.value = '';
                
                setTimeout(() => {
                    loadUserRoutines();
                    if (document.getElementById('page-today').classList.contains('active')) { // Check if home page is active
                        loadHomeRoutines();
                    }
                }, 500);
                
            } catch (error) {
                console.error('âŒ ë£¨í‹´ ì¶”ê°€ ì˜¤ë¥˜:', error);
                if (error.code === 'permission-denied') {
                    showNotification('âš ï¸ Firebase ê¶Œí•œ ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
                } else {
                    showNotification('ë£¨í‹´ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
                }
            }
        }

        // ì‚¬ìš©ì ë£¨í‹´ ë¡œë“œ (ê´€ë¦¬ í˜ì´ì§€ìš©)
        async function loadUserRoutines() {
            if (!currentUser || !familyId) {
                return;
            }
            
            try {
                const routinesSnapshot = await db.collection('routines')
                    .where('userId', '==', currentUser.uid)
                    .where('familyId', '==', familyId)
                    .get();

                const manageList = document.getElementById('manageRoutineList');
                if (!manageList) {
                    return;
                }
                
                manageList.innerHTML = '';

                if (routinesSnapshot.empty) {
                    manageList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“</div>
                            <div class="empty-state-title">ì•„ì§ ì¶”ê°€ëœ ë£¨í‹´ì´ ì—†ìŠµë‹ˆë‹¤</div>
                            <div class="empty-state-description">ìœ„ì˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì²« ë²ˆì§¸ ë£¨í‹´ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!</div>
                        </div>
                    `;
                    return;
                }

                const routines = [];
                routinesSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    routines.push({
                        id: doc.id,
                        ...data,
                        createdAt: data.createdAt?.toDate() || new Date()
                    });
                });

                // Sort by creation date for manage page, newest first
                routines.sort((a, b) => b.createdAt.getTime() - a.createdAt.getTime());

                routines.forEach((routine, index) => {
                    const routineEl = document.createElement('div');
                    routineEl.className = 'repeating-routine-item'; // Use repeating-routine-item style
                    routineEl.style.animationDelay = `${index * 0.1}s`;
                    
                    const typeMap = {
                        'task': 'íƒœìŠ¤í¬',
                        'number': 'ìˆ«ì',
                        'timestamp': 'ì‹œê°„',
                        'timer': 'íƒ€ì´ë¨¸'
                    };
                    
                    const timeMap = {
                        'morning': 'ğŸŒ… ì•„ì¹¨',
                        'afternoon': 'ğŸŒ ì ì‹¬',
                        'evening': 'ğŸŒ™ ì €ë…'
                    };
                    
                    const freqMap = {
                        'daily': 'ë§¤ì¼',
                        'weekday': 'í‰ì¼',
                        'weekend': 'ì£¼ë§',
                        'none': 'ë°˜ë³µ ì—†ìŒ'
                    };
                    
                    routineEl.innerHTML = `
                        <div class="routine-name-wrapper">
                            <i class="fas fa-grip-vertical drag-handle"></i>
                            <span class="time-emoji">${timeMap[routine.time] || 'â°'}</span>
                            <span>${routine.name} (${freqMap[routine.frequency]})</span>
                        </div>
                        <div>
                            <button class="edit-rule-btn btn-icon touchable" style="background:none; border:none; color: var(--text-secondary-color); font-size: 1.1rem; margin-right: 0.5rem;"><i class="fas fa-pencil-alt"></i></button>
                            <label class="switch">
                                <input type="checkbox" ${routine.status === 'í™œì„±' ? 'checked' : ''}>
                                <span class="slider round"></span>
                            </label>
                        </div>
                    `;
                    // Edit button click event
                    routineEl.querySelector('.edit-rule-btn').addEventListener('click', () => showEditRuleModal(routine));
                    // Checkbox change event
                    routineEl.querySelector('input[type="checkbox"]').addEventListener('change', (e) => {
                        handleRuleStatusToggle(routine.id, routine.status);
                    });
                    manageList.appendChild(routineEl);
                });
                
            } catch (error) {
                console.error('âŒ ë£¨í‹´ ë¡œë“œ ì˜¤ë¥˜:', error);
                
                const manageList = document.getElementById('manageRoutineList');
                if (manageList) {
                    manageList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">âš ï¸</div>
                            <div class="empty-state-title">ë£¨í‹´ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</div>
                        </div>
                    `;
                }
            }
        }

        // ë£¨í‹´ ì¶”ê°€ ëª¨ë‹¬ ê´€ë ¨
        function openAddRoutineModal() {
            const modal = document.getElementById('addRoutineModal');
            modal.style.display = 'flex'; // Changed to flex
            
            // Reset form fields
            document.getElementById('routineName').value = '';
            document.getElementById('routineType').value = 'task';
            document.getElementById('routineTime').value = 'morning';
            document.getElementById('routineFreq').value = 'daily';
            document.getElementById('routineUnit').value = '';
            document.getElementById('routineDuration').value = '';
            document.getElementById('routineUnitContainer').style.display = 'none';
            document.getElementById('routineDurationContainer').style.display = 'none';

            // Event listener for routineType change in add routine modal
            document.getElementById('routineType').onchange = function() {
                const selectedType = this.value;
                document.getElementById('routineUnitContainer').style.display = selectedType === 'number' ? 'block' : 'none';
                document.getElementById('routineDurationContainer').style.display = selectedType === 'timer' ? 'block' : 'none';
            };

            setTimeout(() => {
                const modalContent = modal.querySelector('.modal'); // Changed to .modal
                if (modalContent) {
                    modalContent.style.animation = 'fadeInUp 0.3s ease-out';
                }
            }, 10);
        }

        function closeModal() {
            const modal = document.getElementById('addRoutineModal');
            const modalContent = modal.querySelector('.modal'); // Changed to .modal
            
            if (modalContent) {
                modalContent.style.animation = 'fadeInUp 0.3s ease-out reverse';
            }
            
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }

        // ë³´ìƒ ì¶”ê°€ ëª¨ë‹¬ ê´€ë ¨
        function openAddRewardModal() {
            const modal = document.getElementById('addRewardModal');
            modal.style.display = 'flex'; // Changed to flex
            document.getElementById('rewardName').value = '';
            document.getElementById('rewardCost').value = 100;
            document.getElementById('rewardEmoji').value = '';
            
            setTimeout(() => {
                const modalContent = modal.querySelector('.modal'); // Changed to .modal
                if (modalContent) {
                    modalContent.style.animation = 'fadeInUp 0.3s ease-out';
                }
            }, 10);
        }

        function closeAddRewardModal() {
            const modal = document.getElementById('addRewardModal');
            const modalContent = modal.querySelector('.modal'); // Changed to .modal
            
            if (modalContent) {
                modalContent.style.animation = 'fadeInUp 0.3s ease-out reverse';
            }
            
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        window.addEventListener('click', function(event) {
            const addRoutineModal = document.getElementById('addRoutineModal');
            const addRewardModal = document.getElementById('addRewardModal');
            const achievementModal = document.getElementById('achievementModal');
            const memberDetailModal = document.getElementById('memberDetailModal');
            const numberInputModal = document.getElementById('numberInputModal');
            const timeInputModal = document.getElementById('timeInputModal');
            const timerModal = document.getElementById('timerModal');
            const dayDetailModal = document.getElementById('dayDetailModal');
            const editRuleModal = document.getElementById('editRuleModal');
            const confirmModal = document.getElementById('confirmModal');
            
            if (event.target === addRoutineModal) {
                closeModal();
            }
            
            if (event.target === addRewardModal) {
                closeAddRewardModal();
            }

            if (event.target === achievementModal) {
                closeAchievementModal();
            }
            
            if (event.target === memberDetailModal) {
                closeMemberDetail();
            }

            if (event.target === numberInputModal) {
                hideNumberInputModal();
            }
            if (event.target === timeInputModal) {
                hideTimeInputModal();
            }
            if (event.target === timerModal) {
                hideTimerModal();
            }
            if (event.target === dayDetailModal) {
                hideDayDetailModal();
            }
            if (event.target === editRuleModal) {
                hideEditRuleModal();
            }
            if (event.target === confirmModal) {
                // Confirm modal is handled by promise, no direct close
            }
        });

        // ë¡œê·¸ì•„ì›ƒ
        async function logout() {
            try {
                await auth.signOut();
                showNotification('ğŸ‘‹ ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (error) {
                console.error('ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', error);
                showNotification('ë¡œê·¸ì•„ì›ƒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // Google í”„ë¡œí•„ ìƒì„±
        async function createUserProfileFromGoogle(user, familyCode) {
            try {
                const userData = {
                    email: user.email,
                    displayName: user.displayName,
                    photoURL: user.photoURL,
                    role: userRole,
                    authProvider: 'google',
                    points: 0, // ì´ˆê¸° í¬ì¸íŠ¸ ì„¤ì •
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastActive: firebase.firestore.FieldValue.serverTimestamp()
                };

                if (userRole === 'parent') {
                    const newFamilyId = generateFamilyCode();
                    userData.familyId = newFamilyId;
                    userData.isParent = true;

                    await db.collection('families').doc(newFamilyId).set({
                        parentId: user.uid,
                        parentName: user.displayName || user.email.split('@')[0],
                        members: [user.uid],
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        familyCode: newFamilyId
                    });

                    setTimeout(() => {
                        document.getElementById('generatedFamilyCode').textContent = newFamilyId;
                        document.getElementById('familyCodeDisplay').classList.remove('hidden');
                        document.getElementById('familyCodeDisplay').style.display = 'block';
                        showNotification(`ğŸ”‘ ê°€ì¡± ì½”ë“œ: ${newFamilyId}`);
                    }, 1000);
                    
                } else if (familyCode) {
                    try {
                        const familyDoc = await db.collection('families').doc(familyCode).get();
                        
                        if (familyDoc.exists) {
                            userData.familyId = familyCode;
                            userData.isParent = false;

                            await db.collection('families').doc(familyCode).update({
                                members: firebase.firestore.FieldValue.arrayUnion(user.uid)
                            });
                            
                            showNotification(`ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ê°€ì¡±ì— ì°¸ì—¬í–ˆìŠµë‹ˆë‹¤! ì½”ë“œ: ${familyCode}`);
                        } else {
                            throw new Error('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê°€ì¡± ì½”ë“œì…ë‹ˆë‹¤. ë¶€ëª¨ë‹˜ê»˜ ì •í™•í•œ ì½”ë“œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
                        }
                    } catch (familyError) {
                        console.error('âŒ ê°€ì¡± ì°¸ì—¬ ì˜¤ë¥˜:', familyError);
                        
                        if (familyError.code === 'permission-denied') {
                            showNotification('âš ï¸ ê°€ì¡± ì°¸ì—¬ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
                        } else if (familyError.message.includes('ì¡´ì¬í•˜ì§€ ì•ŠëŠ”')) {
                            showNotification(familyError.message, 'error');
                        } else {
                            showNotification('ê°€ì¡± ì°¸ì—¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + familyError.message, 'error');
                        }
                        throw familyError;
                    }
                } else {
                    throw new Error('ìë…€ ê³„ì •ì€ ê°€ì¡± ì½”ë“œê°€ í•„ìš”í•©ë‹ˆë‹¤.');
                }

                await db.collection('users').doc(user.uid).set(userData);
                await createDefaultRoutines(user.uid, userData.familyId);
                
            } catch (error) {
                console.error('âŒ Google í”„ë¡œí•„ ìƒì„± ì˜¤ë¥˜:', error);
                if (error.code === 'permission-denied') {
                    showNotification('âš ï¸ Firebase ê¶Œí•œ ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
                }
                throw error;
            }
        }

        // ìƒˆ ì‚¬ìš©ì ì²˜ë¦¬
        async function handleNewUser(user) {
            try {
                // ì„ì‹œë¡œ ê¸°ë³¸ê°’ ì„¤ì •
                userRole = userRole || 'parent'; // ê¸°ë³¸ê°’ì€ ë¶€ëª¨
                
                // ì‚¬ìš©ì í”„ë¡œí•„ ìƒì„±
                const userData = {
                    email: user.email,
                    displayName: user.displayName || user.email.split('@')[0],
                    photoURL: user.photoURL,
                    role: userRole,
                    authProvider: user.providerData[0]?.providerId === 'google.com' ? 'google' : 'email',
                    points: 0, // ì´ˆê¸° í¬ì¸íŠ¸ ì„¤ì •
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastActive: firebase.firestore.FieldValue.serverTimestamp()
                };

                if (userRole === 'parent') {
                    const newFamilyId = generateFamilyCode();
                    userData.familyId = newFamilyId;
                    userData.isParent = true;
                    familyId = newFamilyId;

                    // ê°€ì¡± ë¬¸ì„œ ìƒì„±
                    await db.collection('families').doc(newFamilyId).set({
                        parentId: user.uid,
                        parentName: userData.displayName,
                        members: [user.uid],
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        familyCode: newFamilyId
                    });

                } else {
                    // ìë…€ì˜ ê²½ìš° ê°€ì¡± ì½”ë“œê°€ í•„ìš”í•˜ì§€ë§Œ, ì¼ë‹¨ ì„ì‹œë¡œ ì²˜ë¦¬
                    userData.familyId = null;
                    userData.isParent = false;
                }

                // ì‚¬ìš©ì ë¬¸ì„œ ìƒì„±
                await db.collection('users').doc(user.uid).set(userData);
                
                // ê¸°ë³¸ ë£¨í‹´ ìƒì„± (ë¶€ëª¨ì¸ ê²½ìš°ë§Œ)
                if (userData.familyId) {
                    await createDefaultRoutines(user.uid, userData.familyId);
                }
                
                showNotification('ìƒˆ ê³„ì •ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰');
                
                // ë©”ì¸ ì•±ìœ¼ë¡œ ì „í™˜
                showMainApp();
                
            } catch (error) {
                console.error('âŒ ìƒˆ ì‚¬ìš©ì ì²˜ë¦¬ ì‹¤íŒ¨:', error);
                showNotification('ê³„ì • ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
                
                // ì‹¤íŒ¨í•´ë„ ë©”ì¸ ì•±ìœ¼ë¡œ ì „í™˜ (ìµœì†Œí•œì˜ ê¸°ëŠ¥ì´ë¼ë„ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡)
                showMainApp();
            }
        }

        async function loadUserProfile() {
            if (!currentUser) {
                throw new Error('ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
            }
            
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    
                    userRole = userData.role || 'parent';
                    familyId = userData.familyId;
                    userPoints = userData.points || 0; // ì‚¬ìš©ì í¬ì¸íŠ¸ ë¡œë“œ
                    
                    const displayName = userData.displayName || currentUser.displayName || currentUser.email.split('@')[0];
                    const userEmailEl = document.getElementById('userEmail');
                    const userRoleEl = document.getElementById('userRole');
                    
                    if (userEmailEl) {
                        userEmailEl.textContent = displayName;
                    }
                    if (userRoleEl) {
                        userRoleEl.textContent = userRole === 'parent' ? 'ë¶€ëª¨' : 'ìë…€';
                    }
                    
                    // ë¶€ëª¨ì´ê³  ê°€ì¡± IDê°€ ìˆìœ¼ë©´ ê°€ì¡± ì½”ë“œ í‘œì‹œ
                    if (userRole === 'parent' && familyId) {
                        try {
                            const familyDoc = await db.collection('families').doc(familyId).get();
                            if (familyDoc.exists) {
                                const familyData = familyDoc.data();
                                const familyCode = familyData.familyCode || familyId;
                                
                                window.currentFamilyCode = familyCode;
                            }
                        } catch (familyError) {
                            console.warn('âš ï¸ ê°€ì¡± ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', familyError);
                        }
                    }

                    // ë³´ìƒ ì¶”ê°€ ë²„íŠ¼ ê°€ì‹œì„± ì œì–´
                    const addRewardBtn = document.getElementById('addRewardBtn');
                    if (addRewardBtn) {
                        if (userRole === 'parent') {
                            addRewardBtn.classList.remove('hidden');
                        } else {
                            addRewardBtn.classList.add('hidden');
                        }
                    }

                    // ë³´ìƒ ìš”ì²­ ë‚´ë¹„ê²Œì´ì…˜ ì•„ì´í…œ ê°€ì‹œì„± ì œì–´
                    const rewardRequestsNavItem = document.getElementById('nav-reward-requests'); // Changed ID
                    if (rewardRequestsNavItem) {
                        if (userRole === 'parent') {
                            rewardRequestsNavItem.classList.remove('hidden');
                        } else {
                            rewardRequestsNavItem.classList.add('hidden');
                        }
                    }
                    
                    showNotification(`ì•ˆë…•í•˜ì„¸ìš”, ${displayName}ë‹˜! ğŸ‘‹`);
                } else {
                    throw new Error('ì‚¬ìš©ì í”„ë¡œí•„ì´ ì—†ìŠµë‹ˆë‹¤');
                }
            } catch (error) {
                console.error('âŒ í”„ë¡œí•„ ë¡œë“œ ì˜¤ë¥˜:', error);
                
                if (error.code === 'permission-denied') {
                    showNotification('âš ï¸ ë°ì´í„°ë² ì´ìŠ¤ ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'warning');
                    
                    // ê¶Œí•œ ë¬¸ì œì—¬ë„ ê¸°ë³¸ ì •ë³´ë¡œ ì•± ì‚¬ìš© ê°€ëŠ¥í•˜ë„ë¡
                    const displayName = currentUser.displayName || currentUser.email.split('@')[0];
                    const userEmailEl = document.getElementById('userEmail');
                    if (userEmailEl) {
                        userEmailEl.textContent = displayName;
                    }
                    
                    // ê¸°ë³¸ê°’ ì„¤ì •
                    userRole = 'parent';
                    familyId = generateFamilyCode();
                    
                    showNotification('ì„ì‹œ ëª¨ë“œë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤. ì¼ë¶€ ê¸°ëŠ¥ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'warning');
                    return; // ì—ëŸ¬ë¥¼ ë˜ì§€ì§€ ì•Šê³  ê³„ì† ì§„í–‰
                }
                
                throw error; // ë‹¤ë¥¸ ì—ëŸ¬ëŠ” ìƒˆ ì‚¬ìš©ì ì²˜ë¦¬ë¡œ ë„˜ê¹€
            }
        }

        function startRealtimeListeners() {
            // ì‚¬ìš©ì í¬ì¸íŠ¸ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ë¦¬ìŠ¤ë„ˆ
            if (currentUser && db) {
                db.collection('users').doc(currentUser.uid)
                    .onSnapshot((doc) => {
                        if (doc.exists) {
                            const newPoints = doc.data().points || 0;
                            if (newPoints !== userPoints) {
                                userPoints = newPoints;
                                updateStatsUI(); // UIì— ë°˜ì˜
                            }
                        }
                    }, (error) => {
                        console.error('âŒ ì‚¬ìš©ì í¬ì¸íŠ¸ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì˜¤ë¥˜:', error);
                    });
            }

            // ë¶€ëª¨ ê³„ì •ì¸ ê²½ìš° ë³´ìƒ ìš”ì²­ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            if (currentUser && db && userRole === 'parent' && familyId) {
                db.collection('reward_redemptions')
                    .where('familyId', '==', familyId)
                    .where('status', '==', 'requested')
                    .onSnapshot((snapshot) => {
                        console.log('ğŸ”” ìƒˆë¡œìš´ ë³´ìƒ ìš”ì²­ ê°ì§€ë¨!');
                        // Only reload if the reward requests page is active
                        if (document.getElementById('page-reward-requests').classList.contains('active')) {
                            loadRewardRequests(); 
                        } else {
                            // Optionally show a small notification badge on the "ìš”ì²­" tab
                            const requestsNavItem = document.getElementById('nav-reward-requests');
                            if (requestsNavItem && !requestsNavItem.querySelector('.notification-badge')) {
                                const badge = document.createElement('span');
                                badge.className = 'notification-badge'
                                badge.style = 'position: absolute; top: 5px; right: 5px; background-color: var(--danger-color); color: white; border-radius: 50%; width: 15px; height: 15px; font-size: 0.7rem; display: flex; align-items: center; justify-content: center;';
                                badge.textContent = snapshot.size;
                                requestsNavItem.appendChild(badge);
                            } else if (requestsNavItem) {
                                requestsNavItem.querySelector('.notification-badge').textContent = snapshot.size;
                            }
                        }
                    }, (error) => {
                        console.error('âŒ ë³´ìƒ ìš”ì²­ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì˜¤ë¥˜:', error);
                    });
            }
        }

        // ë³´ìƒ í˜ì´ì§€ ë¡œë“œ
        async function loadRewardsPage() {
            const rewardsListContainer = document.getElementById('rewardsList');
            const rewardPointsDisplay = document.getElementById('rewardPointsDisplay');
            const addRewardBtn = document.getElementById('addRewardBtn');

            if (!rewardsListContainer || !currentUser || !familyId) {
                rewardsListContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ”’</div>
                        <div class="empty-state-title">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</div>
                        <div class="empty-state-description">ë³´ìƒ ëª©ë¡ì„ í™•ì¸í•˜ë ¤ë©´ ë¡œê·¸ì¸í•˜ê±°ë‚˜ ê°€ì¡±ì— ì°¸ì—¬í•´ì£¼ì„¸ìš”.</div>
                    </div>
                `;
                if (addRewardBtn) addRewardBtn.classList.add('hidden');
                return;
            }

            // ë¶€ëª¨ë§Œ ë³´ìƒ ì¶”ê°€ ë²„íŠ¼ ë³´ì´ê¸°
            if (userRole === 'parent') {
                if (addRewardBtn) addRewardBtn.classList.remove('hidden');
            } else {
                if (addRewardBtn) addRewardBtn.classList.add('hidden');
            }

            rewardsListContainer.innerHTML = '<div class="loading-message">ë³´ìƒ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
            rewardPointsDisplay.textContent = userPoints; // í˜„ì¬ í¬ì¸íŠ¸ ì¦‰ì‹œ ë°˜ì˜

            try {
                const rewardsSnapshot = await db.collection('families').doc(familyId).collection('rewards').get();
                rewardsListContainer.innerHTML = '';

                if (rewardsSnapshot.empty) {
                    rewardsListContainer.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">âœ¨</div>
                            <div class="empty-state-title">ì•„ì§ ë³´ìƒì´ ì—†ìŠµë‹ˆë‹¤</div>
                            <div class="empty-state-description">ë¶€ëª¨ë‹˜ ê³„ì •ìœ¼ë¡œ ìƒˆë¡œìš´ ë³´ìƒì„ ì¶”ê°€í•´ë³´ì„¸ìš”!</div>
                        </div>
                    `;
                    return;
                }

                rewardsSnapshot.docs.forEach(doc => {
                    const reward = { id: doc.id, ...doc.data() };
                    const rewardItem = document.createElement('div');
                    rewardItem.className = 'reward-item';
                    
                    const canAfford = userPoints >= reward.cost;
                    const buttonText = canAfford ? `${reward.cost} í¬ì¸íŠ¸ êµí™˜` : `${reward.cost} í¬ì¸íŠ¸ ë¶€ì¡±`;

                    rewardItem.innerHTML = `
                        <div class="reward-info">
                            <div class="reward-emoji">${reward.emoji || 'ğŸ'}</div>
                            <div class="reward-details">
                                <h4>${reward.name}</h4>
                                <p>${reward.cost} í¬ì¸íŠ¸</p>
                            </div>
                        </div>
                        <button class="reward-btn touchable" data-reward-id="${reward.id}" data-reward-cost="${reward.cost}" ${!canAfford ? 'disabled' : ''}>
                            ${buttonText}
                        </button>
                    `;
                    rewardsListContainer.appendChild(rewardItem);

                    const redeemButton = rewardItem.querySelector('.reward-btn');
                    if (redeemButton) {
                        addTouchEventListener(redeemButton, async function() {
                            const rId = this.getAttribute('data-reward-id');
                            const rCost = parseInt(this.getAttribute('data-reward-cost'));
                            await redeemReward(rId, rCost);
                        });
                    }
                });

            } catch (error) {
                console.error('âŒ ë³´ìƒ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                rewardsListContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">âš ï¸</div>
                        <div class="empty-state-title">ë³´ìƒ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>
                        <div class="empty-state-description">${error.message}</div>
                    </div>
                `;
            }
        }

        // ë³´ìƒ êµí™˜ (ìë…€ìš©)
        async function redeemReward(rewardId, rewardCost) {
            if (!currentUser || userRole === 'parent') {
                showNotification('ë³´ìƒì€ ìë…€ ê³„ì •ìœ¼ë¡œë§Œ êµí™˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            if (userPoints < rewardCost) {
                showNotification('í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!', 'error');
                return;
            }

            // ì‚¬ìš©ì í¬ì¸íŠ¸ ì°¨ê° ë° ë³´ìƒ ë¡œê·¸ ê¸°ë¡
            const userRef = db.collection('users').doc(currentUser.uid);
            const rewardLogRef = db.collection('reward_redemptions').doc(); // ìƒˆ ë¬¸ì„œ ID ìƒì„±

            try {
                await db.runTransaction(async (transaction) => {
                    const userDoc = await transaction.get(userRef);
                    if (!userDoc.exists) {
                        throw "User does not exist!";
                    }
                    const currentPoints = userDoc.data().points || 0;

                    if (currentPoints < rewardCost) {
                        throw "Not enough points to redeem this reward.";
                    }

                    // í¬ì¸íŠ¸ ì°¨ê°
                    transaction.update(userRef, {
                        points: currentPoints - rewardCost
                    });

                    // ë³´ìƒ êµí™˜ ë¡œê·¸ ê¸°ë¡
                    transaction.set(rewardLogRef, {
                        userId: currentUser.uid,
                        familyId: familyId,
                        rewardId: rewardId,
                        cost: rewardCost,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        status: 'requested' // ë¶€ëª¨ê°€ í™•ì¸ í›„ 'fulfilled'ë¡œ ë³€ê²½ ê°€ëŠ¥
                    });
                });

                showNotification(`ğŸ‰ ë³´ìƒì„ êµí™˜í–ˆìŠµë‹ˆë‹¤! ${rewardCost} í¬ì¸íŠ¸ ì°¨ê°.`);
                userPoints -= rewardCost; // UI ë³€ìˆ˜ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                updateStatsUI(); // í™ˆ í™”ë©´ í¬ì¸íŠ¸ ì—…ë°ì´íŠ¸
                loadRewardsPage(); // ë³´ìƒ ëª©ë¡ ìƒˆë¡œê³ ì¹¨

            } catch (error) {
                console.error('ë³´ìƒ êµí™˜ ì˜¤ë¥˜:', error);
                showNotification('ë³´ìƒ êµí™˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            }
        }

        // ìƒˆ ë³´ìƒ ì¶”ê°€ (ë¶€ëª¨ìš©)
        async function addReward() {
            if (!currentUser || userRole !== 'parent') {
                showNotification('ìƒˆ ë³´ìƒì€ ë¶€ëª¨ ê³„ì •ìœ¼ë¡œë§Œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            if (!familyId) {
                showNotification('ê°€ì¡± ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            const rewardName = document.getElementById('rewardName').value.trim();
            const rewardCost = parseInt(document.getElementById('rewardCost').value);
            const rewardEmoji = document.getElementById('rewardEmoji').value.trim();

            if (!rewardName) {
                showNotification('ë³´ìƒ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            if (isNaN(rewardCost) || rewardCost <= 0) {
                showNotification('ìœ íš¨í•œ í•„ìš” í¬ì¸íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                await db.collection('families').doc(familyId).collection('rewards').add({
                    name: rewardName,
                    cost: rewardCost,
                    emoji: rewardEmoji || 'ğŸ',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showNotification(`âœ¨ ìƒˆ ë³´ìƒ "${rewardName}"ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                closeAddRewardModal();
                loadRewardsPage(); // ë³´ìƒ ëª©ë¡ ìƒˆë¡œê³ ì¹¨

            } catch (error) {
                console.error('ë³´ìƒ ì¶”ê°€ ì˜¤ë¥˜:', error);
                showNotification('ë³´ìƒ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            }
        }

        // ë³´ìƒ ìš”ì²­ ê´€ë¦¬ í˜ì´ì§€ ë¡œë“œ (ë¶€ëª¨ìš©)
        async function loadRewardRequests() {
            const rewardRequestsList = document.getElementById('rewardRequestsList');
            if (!rewardRequestsList || !currentUser || userRole !== 'parent' || !familyId) {
                if (rewardRequestsList) {
                    rewardRequestsList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ”’</div>
                            <div class="empty-state-title">ë¶€ëª¨ ê³„ì •ì—ì„œë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤</div>
                            <div class="empty-state-description">ìë…€ì˜ ë³´ìƒ ìš”ì²­ì„ ê´€ë¦¬í•˜ë ¤ë©´ ë¶€ëª¨ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.</div>
                        </div>
                    `;
                }
                return;
            }

            rewardRequestsList.innerHTML = '<div class="loading-message">ë³´ìƒ ìš”ì²­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

            try {
                const requestsSnapshot = await db.collection('reward_redemptions')
                    .where('familyId', '==', familyId)
                    .where('status', '==', 'requested')
                    .get();

                rewardRequestsList.innerHTML = '';

                if (requestsSnapshot.empty) {
                    rewardRequestsList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ‰</div>
                            <div class="empty-state-title">í˜„ì¬ ë³´ìƒ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤</div>
                            <div class="empty-state-description">ìë…€ë“¤ì´ ë£¨í‹´ì„ ì™„ë£Œí•˜ê³  ë³´ìƒì„ êµí™˜í•  ë•Œ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
                        </div>
                    `;
                    // Remove notification badge if no pending requests
                    const requestsNavItem = document.getElementById('nav-reward-requests');
                    const badge = requestsNavItem ? requestsNavItem.querySelector('.notification-badge') : null;
                    if (badge) badge.remove();
                    return;
                }

                for (const doc of requestsSnapshot.docs) {
                    const request = { id: doc.id, ...doc.data() };
                    
                    // ìš”ì²­í•œ ìë…€ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                    const childDoc = await db.collection('users').doc(request.userId).get();
                    const childName = childDoc.exists ? (childDoc.data().displayName || childDoc.data().email.split('@')[0]) : 'ì•Œ ìˆ˜ ì—†ëŠ” ìë…€';

                    // ë³´ìƒ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                    const rewardDoc = await db.collection('families').doc(familyId).collection('rewards').doc(request.rewardId).get();
                    const rewardName = rewardDoc.exists ? rewardDoc.data().name : 'ì•Œ ìˆ˜ ì—†ëŠ” ë³´ìƒ';
                    const rewardEmoji = rewardDoc.exists ? rewardDoc.data().emoji : 'ğŸ';

                    const requestItem = document.createElement('div');
                    requestItem.className = 'reward-request-item';
                    requestItem.innerHTML = `
                        <div class="request-header">
                            <span>${rewardEmoji} ${rewardName}</span>
                            <span>${request.cost} í¬ì¸íŠ¸</span>
                        </div>
                        <div class="request-details">
                            ${childName}ë‹˜ì´ ${request.timestamp.toDate().toLocaleDateString('ko-KR')} ${request.timestamp.toDate().toLocaleTimeString('ko-KR')}ì— ìš”ì²­
                        </div>
                        <div class="request-actions">
                            <button class="request-btn approve touchable" data-request-id="${request.id}" data-child-id="${request.userId}" data-reward-cost="${request.cost}">ìŠ¹ì¸</button>
                            <button class="request-btn reject touchable" data-request-id="${request.id}" data-child-id="${request.userId}" data-reward-cost="${request.cost}">ê±°ì ˆ</button>
                        </div>
                    `;
                    rewardRequestsList.appendChild(requestItem);

                    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                    addTouchEventListener(requestItem.querySelector('.approve'), async function() {
                        const requestId = this.getAttribute('data-request-id');
                        const childId = this.getAttribute('data-child-id');
                        await approveRewardRequest(requestId, childId);
                    });
                    addTouchEventListener(requestItem.querySelector('.reject'), async function() {
                        const requestId = this.getAttribute('data-request-id');
                        const childId = this.getAttribute('data-child-id');
                        const rewardCost = parseInt(this.getAttribute('data-reward-cost'));
                        await rejectRewardRequest(requestId, childId, rewardCost);
                    });
                }

                // Update notification badge count
                const requestsNavItem = document.getElementById('nav-reward-requests');
                let badge = requestsNavItem ? requestsNavItem.querySelector('.notification-badge') : null;
                if (requestsSnapshot.size > 0) {
                    if (!badge) {
                        badge = document.createElement('span');
                        badge.className = 'notification-badge'
                        badge.style = 'position: absolute; top: 5px; right: 5px; background-color: var(--danger-color); color: white; border-radius: 50%; width: 15px; height: 15px; font-size: 0.7rem; display: flex; align-items: center; justify-content: center;';
                        requestsNavItem.appendChild(badge);
                    }
                    badge.textContent = requestsSnapshot.size;
                } else {
                    if (badge) badge.remove();
                }


            } catch (error) {
                console.error('âŒ ë³´ìƒ ìš”ì²­ ë¡œë“œ ì˜¤ë¥˜:', error);
                rewardRequestsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">âš ï¸</div>
                        <div class="empty-state-title">ë³´ìƒ ìš”ì²­ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>
                        <div class="empty-state-description">${error.message}</div>
                    </div>
                `;
            }
        }

        // ë³´ìƒ ìš”ì²­ ìŠ¹ì¸
        async function approveRewardRequest(requestId, childUserId) {
            if (!currentUser || userRole !== 'parent') {
                showNotification('ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            const requestRef = db.collection('reward_redemptions').doc(requestId);
            try {
                await requestRef.update({
                    status: 'fulfilled',
                    processedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    processedBy: currentUser.uid
                });
                showNotification('âœ… ë³´ìƒ ìš”ì²­ì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!');
                loadRewardRequests(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            } catch (error) {
                console.error('ë³´ìƒ ìš”ì²­ ìŠ¹ì¸ ì˜¤ë¥˜:', error);
                showNotification('ë³´ìƒ ìš”ì²­ ìŠ¹ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ë³´ìƒ ìš”ì²­ ê±°ì ˆ
        async function rejectRewardRequest(requestId, childUserId, rewardCost) {
            if (!currentUser || userRole !== 'parent') {
                showNotification('ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            const requestRef = db.collection('reward_redemptions').doc(requestId);
            const childUserRef = db.collection('users').doc(childUserId);

            try {
                await db.runTransaction(async (transaction) => {
                    const childDoc = await transaction.get(childUserRef);
                    if (!childDoc.exists) {
                        throw "Child user does not exist!";
                    }
                    const currentChildPoints = childDoc.data().points || 0;

                    // í¬ì¸íŠ¸ í™˜ë¶ˆ
                    transaction.update(childUserRef, {
                        points: currentChildPoints + rewardCost
                    });

                    // ìš”ì²­ ìƒíƒœ ì—…ë°ì´íŠ¸
                    transaction.update(requestRef, {
                        status: 'rejected',
                        processedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        processedBy: currentUser.uid
                    });
                });

                showNotification(`âŒ ë³´ìƒ ìš”ì²­ì´ ê±°ì ˆë˜ì—ˆìŠµë‹ˆë‹¤. ${rewardCost} í¬ì¸íŠ¸ê°€ í™˜ë¶ˆë˜ì—ˆìŠµë‹ˆë‹¤.`);
                loadRewardRequests(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                // No need to update parent's stats, as only child's points changed
            } catch (error) {
                console.error('ë³´ìƒ ìš”ì²­ ê±°ì ˆ ì˜¤ë¥˜:', error);
                showNotification('ë³´ìƒ ìš”ì²­ ê±°ì ˆì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            }
        }

        // Helper for routine value display
        function getRoutineValueDisplay(routine) {
            if (routine.routineType === 'number') {
                return routine.value !== null ? `${routine.value} ${routine.unit || ''}` : 'ë¯¸ì™„ë£Œ';
            }
            if (routine.routineType === 'timestamp') return routine.value || 'ë¯¸ì™„ë£Œ';
            if (routine.routineType === 'timer') {
                return routine.value ? 'ì™„ë£Œ' : `${routine.unit || 0}ë¶„`;
            }
            return '';
        }

        // Swipe events for routine items
        let activeSwipeElement = null; // Track the currently swiped element
        function addSwipeEvents(wrapper) {
            let startX = 0;
            let deltaX = 0;
            let isSwiping = false;

            const item = wrapper.querySelector('.routine-item');
            const actions = wrapper.querySelector('.routine-item-actions');

            const handleGestureStart = (e) => {
                if (activeSwipeElement && activeSwipeElement !== wrapper) {
                    activeSwipeElement.classList.remove('swiped');
                }
                startX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
                isSwiping = true;
                item.style.transition = 'none';
                actions.style.transition = 'none';
            };

            const handleGestureMove = (e) => {
                if (!isSwiping) return;
                const currentX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
                deltaX = currentX - startX;

                // Only allow swipe left, and limit the swipe distance
                if (deltaX < 0 && deltaX > -actions.offsetWidth - 10) { // -10 for a small buffer
                    item.style.transform = `translateX(${deltaX}px)`;
                } else if (deltaX >= 0) { // Prevent swiping right
                    item.style.transform = `translateX(0px)`;
                    deltaX = 0;
                }
            };

            const handleGestureEnd = () => {
                if (!isSwiping) return;
                isSwiping = false;
                item.style.transition = '';
                actions.style.transition = '';
                
                if (deltaX < -actions.offsetWidth / 2) { // If swiped more than half
                    item.style.transform = `translateX(-${actions.offsetWidth}px)`;
                    wrapper.classList.add('swiped');
                    activeSwipeElement = wrapper;
                } else {
                    item.style.transform = `translateX(0px)`;
                    wrapper.classList.remove('swiped');
                    if (activeSwipeElement === wrapper) {
                        activeSwipeElement = null;
                    }
                }
                deltaX = 0;
            };

            item.addEventListener('mousedown', handleGestureStart);
            item.addEventListener('mousemove', handleGestureMove);
            item.addEventListener('mouseup', handleGestureEnd);
            item.addEventListener('mouseleave', handleGestureEnd); // Reset on mouse leave

            item.addEventListener('touchstart', handleGestureStart, { passive: true });
            item.addEventListener('touchmove', handleGestureMove, { passive: true });
            item.addEventListener('touchend', handleGestureEnd);

            // Close swipe on any click outside
            document.addEventListener('click', (e) => {
                if (activeSwipeElement && !activeSwipeElement.contains(e.target)) {
                    activeSwipeElement.classList.remove('swiped');
                    activeSwipeElement.querySelector('.routine-item').style.transform = 'translateX(0px)';
                    activeSwipeElement = null;
                }
            });
        }


        // DOM ë¡œë“œ ì™„ë£Œ í›„ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            showStatus('ì•± ì´ˆê¸°í™” ì¤‘...', 2000);
            
            // ê¸°ë³¸ UI ìš”ì†Œ í™•ì¸
            const loginPage = document.getElementById('loginPage');
            const mainApp = document.getElementById('mainApp');
            const googleBtn = document.getElementById('googleSignInBtn');
            
            if (!loginPage || !mainApp || !googleBtn) {
                console.error('âŒ í•„ìˆ˜ UI ìš”ì†Œê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤!');
                showStatus('UI ë¡œë“œ ì˜¤ë¥˜', 5000);
                return;
            }
            
            updateCurrentDate();
            updateDailyQuote(); // Call once on load

            // Attach event listeners for AI goal suggestion and save AI settings
            const aiGoalSuggestionBtn = document.getElementById('ai-goal-suggestion-btn');
            if (aiGoalSuggestionBtn) {
                aiGoalSuggestionBtn.addEventListener('click', handleGetAiGoals);
            }
            const aiSettingsForm = document.getElementById('aiSettingsForm');
            if (aiSettingsForm) {
                aiSettingsForm.addEventListener('submit', handleSaveAiSettings);
            }
            const generatePromptBtn = document.getElementById('generatePromptBtn');
            if (generatePromptBtn) {
                generatePromptBtn.addEventListener('click', handleGeneratePrompt);
            }
            const editRuleType = document.getElementById('editRuleType');
            if (editRuleType) {
                editRuleType.addEventListener('change', function() {
                    const selectedType = this.value;
                    const unitContainer = document.getElementById('editRuleUnitContainer');
                    const isVisible = selectedType === 'number' || selectedType === 'timer';
                    unitContainer.style.display = isVisible ? 'block' : 'none';
                    if (isVisible) {
                        const label = unitContainer.querySelector('label');
                        label.textContent = selectedType === 'timer' ? 'ì‹œê°„ (ë¶„)' : 'ë‹¨ìœ„';
                    }
                });
            }
            const addRoutineType = document.getElementById('routineType');
            if (addRoutineType) {
                addRoutineType.addEventListener('change', function() {
                    const selectedType = this.value;
                    document.getElementById('routineUnitContainer').style.display = selectedType === 'number' ? 'block' : 'none';
                    document.getElementById('routineDurationContainer').style.display = selectedType === 'timer' ? 'block' : 'none';
                });
            }

            // í„°ì¹˜ ì´ë²¤íŠ¸ë¥¼ ë¨¼ì € ì´ˆê¸°í™”
            initializeTouchEvents();
            
            // Firebase ì´ˆê¸°í™” ì „ ì²´í¬
            setTimeout(() => {
                if (typeof firebase !== 'undefined') {
                    const initResult = initializeFirebase();
                    if (initResult) {
                        // Firebase ì´ˆê¸°í™” ì„±ê³µ
                    } else {
                        // Firebase ì´ˆê¸°í™” ì‹¤íŒ¨
                    }
                } else {
                    showStatus('Firebase ë¡œë“œ ì‹¤íŒ¨ - ì¬ì‹œë„ ì¤‘...', 3000);
                    
                    setTimeout(() => {
                        if (typeof firebase !== 'undefined') {
                            initializeFirebase();
                        } else {
                            showStatus('Firebase SDK ë¡œë“œ ì‹¤íŒ¨', 5000);
                        }
                    }, 1000);
                }
            }, 100);
            
        });
    </script>
</body>
</html>
ï¿½
