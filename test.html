<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Auth 최종 테스트</title>
    <style>
        body { font-family: sans-serif; padding: 2rem; background-color: #111827; color: #f3f4f6; }
        #status { font-size: 1.2rem; font-weight: bold; margin-bottom: 1rem; }
        #login-btn, #logout-btn { padding: 1rem; font-size: 1rem; cursor: pointer; }
        .success { color: #22c55e; }
        .error { color: #ef4444; }
        .info { color: #3b82f6; }
    </style>
</head>
<body>
    <h1>Firebase 인증 기능 최종 심문</h1>
    <p>이 페이지는 오직 Firebase Auth 라이브러리가 아이폰 환경에서 정상 작동하는지 확인하기 위한 것입니다.</p>
    <hr style="margin: 1rem 0;">

    <div id="status">상태: 확인 중...</div>
    <button id="login-btn" style="display: none;">Google 로그인</button>
    <button id="logout-btn" style="display: none;">로그아웃</button>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <script>
        // --- 1. Firebase 초기화 (사령관님의 설정으로 교체해주세요) ---
        const firebaseConfig = {
            apiKey: "AIzaSyC6bvEaHsxpLtPv5zM99PmgAwOnRXnhkBM",
            authDomain: "habit-dc62a.firebaseapp.com",
            projectId: "habit-dc62a",
            storageBucket: "habit-dc62a.firebasestorage.app",
            messagingSenderId: "668374525477",
            appId: "1:668374525477:web:ecbecd95ec631fb82cc1cc",
            measurementId: "G-DV5Z9YVTZG"
        };
        firebase.initializeApp(firebaseConfig);
        console.log("✅ Firebase App 초기화 완료.");

        // --- 2. 변수 및 UI 요소 ---
        const statusDiv = document.getElementById('status');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const provider = new firebase.auth.GoogleAuthProvider();

        // --- 3. 이벤트 리스너 ---
        loginBtn.addEventListener('click', () => {
            statusDiv.className = 'info';
            statusDiv.textContent = 'Google 로그인 시도 중...';
            firebase.auth().signInWithRedirect(provider);
        });

        logoutBtn.addEventListener('click', () => {
            firebase.auth().signOut();
        });

        // --- 4. 핵심 심문: onAuthStateChanged ---
        console.log("⏳ onAuthStateChanged 감시자 배치를 시도합니다...");
        try {
            firebase.auth().onAuthStateChanged(user => {
                console.log("🎉 onAuthStateChanged가 성공적으로 발동되었습니다!");
                if (user) {
                    // 로그인 성공
                    statusDiv.className = 'success';
                    statusDiv.textContent = `로그인 성공: ${user.displayName} (${user.uid})`;
                    loginBtn.style.display = 'none';
                    logoutBtn.style.display = 'inline-block';
                    console.log("사용자 정보:", user);
                } else {
                    // 로그아웃 상태
                    statusDiv.className = 'error';
                    statusDiv.textContent = '상태: 로그아웃됨';
                    loginBtn.style.display = 'inline-block';
                    logoutBtn.style.display = 'none';
                    console.log("사용자 없음 (로그아웃 상태).");
                }
            });
            console.log("✅ onAuthStateChanged 감시자 배치가 오류 없이 완료되었습니다.");
        } catch (error) {
            console.error("💣 CRITICAL: onAuthStateChanged 배치 중 치명적 오류 발생!", error);
            statusDiv.className = 'error';
            statusDiv.textContent = '치명적 오류 발생! 콘솔을 확인하십시오.';
        }
        
        // --- 5. 리다이렉트 결과 처리 ---
        firebase.auth().getRedirectResult()
          .catch(error => console.error("getRedirectResult 오류:", error));

    </script>
</body>
</html>