<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°€ì¡± ë£¨í‹´ íŠ¸ë˜ì»¤</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <!-- ë¡œê·¸ì¸ í˜ì´ì§€ -->
        <div id="loginPage" class="login-page">
            <div class="login-form">
                <h1 class="app-title">ğŸŒ… ë£¨í‹´ íŠ¸ë˜ì»¤</h1>
                
                <!-- ì—­í•  ì„ íƒ -->
                <div class="role-selector">
                    <div class="role-btn active" onclick="selectRole('parent')">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ë¶€ëª¨</div>
                    <div class="role-btn" onclick="selectRole('child')">ğŸ‘¶ ìë…€</div>
                </div>

                <!-- ê°€ì¡± ì½”ë“œ ì…ë ¥ (ìë…€ìš©) -->
                <div id="familyCodeInput" class="input-group family-code-input">
                    <label for="familyCode">ê°€ì¡± ì½”ë“œ</label>
                    <input type="text" id="familyCode" placeholder="ê°€ì¡± ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                </div>

                <!-- Google ë¡œê·¸ì¸ ë²„íŠ¼ -->
                <button class="btn google-btn" onclick="signInWithGoogle()">
                    <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google" class="google-icon">
                    Googleë¡œ ì‹œì‘í•˜ê¸°
                </button>

                <!-- êµ¬ë¶„ì„  -->
                <div class="divider">
                    <span>ë˜ëŠ”</span>
                </div>

                <!-- ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ ë¡œê·¸ì¸ (ì„ íƒì‚¬í•­) -->
                <div class="email-login-section collapsed" id="emailLoginSection">
                    <div class="input-group">
                        <label for="email">ì´ë©”ì¼</label>
                        <input type="email" id="email" placeholder="your@email.com">
                    </div>
                    <div class="input-group">
                        <label for="password">ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
                    </div>
                    <button class="btn" id="loginBtn" onclick="handleAuth('login')">ë¡œê·¸ì¸</button>
                    <button class="btn btn-secondary" onclick="handleAuth('register')">íšŒì›ê°€ì…</button>
                </div>

                <button class="btn-text" onclick="toggleEmailLogin()">ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸</button>

                <!-- ê°€ì¡± ì½”ë“œ í‘œì‹œ (ë¶€ëª¨ìš© íšŒì›ê°€ì… í›„) -->
                <div id="familyCodeDisplay" class="family-code-display hidden">
                    <div>ê°€ì¡± ì½”ë“œ</div>
                    <div class="family-code" id="generatedFamilyCode"></div>
                    <div style="font-size: 0.75rem; margin-top: 0.75rem; color: var(--text-secondary);">
                        ìë…€ì—ê²Œ ì´ ì½”ë“œë¥¼ ì•Œë ¤ì£¼ì„¸ìš”
                    </div>
                </div>
            </div>
        </div>

        <!-- ë©”ì¸ ì•± -->
        <div id="mainApp" class="main-app">
            <!-- í—¤ë” -->
            <div class="header">
                <div class="user-info">
                    <span id="userEmail"></span>
                    <span class="user-role" id="userRole"></span>
                    <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
                <h1>ì˜¤ëŠ˜ì˜ ë£¨í‹´</h1>
                <div id="currentDate"></div>
            </div>

            <!-- ë©”ì¸ í˜ì´ì§€ -->
            <div id="homePage" class="page">
                <!-- ìŠ¤íŠ¸ë¦­ ëŒ€ì‹œë³´ë“œ -->
                <div class="streak-dashboard">
                    <div class="streak-card">
                        <div class="streak-icon">ğŸ”¥</div>
                        <div class="streak-info">
                            <div class="streak-number" id="currentStreak">0</div>
                            <div class="streak-label">ì—°ì† ì¼ìˆ˜</div>
                        </div>
                    </div>
                    <div class="streak-card">
                        <div class="streak-icon">ğŸ¯</div>
                        <div class="streak-info">
                            <div class="streak-number" id="todayProgress">0%</div>
                            <div class="streak-label">ì˜¤ëŠ˜ ì§„í–‰ë¥ </div>
                        </div>
                    </div>
                    <div class="streak-card">
                        <div class="streak-icon">â­</div>
                        <div class="streak-info">
                            <div class="streak-number" id="weeklyScore">0</div>
                            <div class="streak-label">ì£¼ê°„ ì ìˆ˜</div>
                        </div>
                    </div>
                </div>

                <!-- ì£¼ê°„ ì§„í–‰ ìƒí™© -->
                <div class="weekly-progress">
                    <h3>ì´ë²ˆ ì£¼ ì§„í–‰ ìƒí™©</h3>
                    <div class="week-calendar" id="weekCalendar">
                        <!-- 7ì¼ê°„ì˜ ì§„í–‰ ìƒí™©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                </div>

                <!-- ìˆ˜ë©´ ì •ë³´ -->
                <div class="sleep-info">
                    <div class="sleep-hours" id="sleepHours">-</div>
                    <div>ì–´ì ¯ë°¤ ìˆ˜ë©´ì‹œê°„</div>
                </div>

                <!-- ì˜¤ëŠ˜ì˜ ëª…ì–¸ -->
                <div class="quote" id="dailyQuote">
                    "ì„±ê³µì€ ë§¤ì¼ì˜ ì‘ì€ ë…¸ë ¥ë“¤ì´ ìŒ“ì—¬ì„œ ë§Œë“¤ì–´ì§„ë‹¤."
                </div>

                <!-- ë£¨í‹´ ëª©ë¡ -->
                <div class="routine-list" id="routineList">
                    <!-- ë£¨í‹´ ì•„ì´í…œë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
            </div>

            <!-- ê°€ì¡± í˜ì´ì§€ -->
            <div id="familyPage" class="page family-page">
                <div class="page-title">ê°€ì¡± ë£¨í‹´ í˜„í™©</div>
                
                <!-- ê°€ì¡± ì½”ë“œ í‘œì‹œ ì¹´ë“œ (ë¶€ëª¨ë§Œ) -->
                <div id="familyCodeCard" class="family-code-card hidden">
                    <div class="card-header">
                        <h3>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ê°€ì¡± ì½”ë“œ</h3>
                        <div class="card-subtitle">ìë…€ë“¤ì´ ê°€ì¡±ì— ì°¸ì—¬í•  ë•Œ í•„ìš”í•œ ì½”ë“œì…ë‹ˆë‹¤</div>
                    </div>
                    <div class="family-code-display-main">
                        <div class="family-code-large" id="familyCodeMain">-</div>
                        <button class="copy-btn" onclick="copyFamilyCode()">ğŸ“‹ ë³µì‚¬</button>
                    </div>
                    <div class="family-info">
                        <div class="info-item">
                            <span class="info-label">ê°€ì¡± êµ¬ì„±ì›:</span>
                            <span class="info-value" id="memberCount">-ëª…</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">ìƒì„±ì¼:</span>
                            <span class="info-value" id="familyCreatedDate">-</span>
                        </div>
                    </div>
                </div>

                <!-- ê°€ì¡± êµ¬ì„±ì› ëª©ë¡ -->
                <div id="familyMembers" class="family-members">
                    <!-- ê°€ì¡± êµ¬ì„±ì›ë“¤ì˜ ë£¨í‹´ í˜„í™© -->
                </div>
            </div>

            <!-- ê´€ë¦¬ í˜ì´ì§€ -->
            <div id="managePage" class="page manage-page">
                <div class="page-title">ë£¨í‹´ ê´€ë¦¬</div>
                <button class="add-routine-btn" onclick="openAddRoutineModal()">âœ¨ ìƒˆ ë£¨í‹´ ì¶”ê°€</button>
                <div id="manageRoutineList">
                    <!-- ê´€ë¦¬ìš© ë£¨í‹´ ëª©ë¡ -->
                </div>
            </div>

            <!-- í†µê³„ í˜ì´ì§€ -->
            <div id="statsPage" class="page stats-page">
                <div class="page-title">ğŸ“ˆ ë‚˜ì˜ í†µê³„</div>
                
                <!-- ì „ì²´ í†µê³„ ì¹´ë“œ -->
                <div class="stats-overview">
                    <div class="stat-card">
                        <div class="stat-number" id="totalDays">0</div>
                        <div class="stat-label">ì´ í™œë™ ì¼ìˆ˜</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="bestStreak">0</div>
                        <div class="stat-label">ìµœê³  ì—°ì† ê¸°ë¡</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="completionRate">0%</div>
                        <div class="stat-label">í‰ê·  ì™„ë£Œìœ¨</div>
                    </div>
                </div>

                <!-- ì›”ê°„ íˆíŠ¸ë§µ -->
                <div class="monthly-heatmap">
                    <h3>ì›”ê°„ í™œë™ íˆíŠ¸ë§µ</h3>
                    <div class="heatmap-container" id="heatmapContainer">
                        <!-- ì›”ê°„ íˆíŠ¸ë§µì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                    <div class="heatmap-legend">
                        <span>ì ìŒ</span>
                        <div class="legend-colors">
                            <div class="legend-color" data-level="0"></div>
                            <div class="legend-color" data-level="1"></div>
                            <div class="legend-color" data-level="2"></div>
                            <div class="legend-color" data-level="3"></div>
                            <div class="legend-color" data-level="4"></div>
                        </div>
                        <span>ë§ìŒ</span>
                    </div>
                </div>

                <!-- ë£¨í‹´ë³„ ì„±ê³¼ -->
                <div class="routine-stats">
                    <h3>ë£¨í‹´ë³„ ì„±ê³¼</h3>
                    <div id="routineStatsContainer">
                        <!-- ë£¨í‹´ë³„ í†µê³„ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                </div>
            </div>

            <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
            <div class="bottom-nav">
                <div class="nav-item active" onclick="showPage('home')">
                    <i>ğŸ </i>
                    <span>í™ˆ</span>
                </div>
                <div class="nav-item" onclick="showPage('manage')">
                    <i>âš™ï¸</i>
                    <span>ê´€ë¦¬</span>
                </div>
                <div class="nav-item" onclick="showPage('stats')">
                    <i>ğŸ“ˆ</i>
                    <span>í†µê³„</span>
                </div>
                <div class="nav-item" onclick="showPage('review')">
                    <i>ğŸ“Š</i>
                    <span>ë¦¬ë·°</span>
                </div>
                <div class="nav-item" onclick="showPage('family')">
                    <i>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</i>
                    <span>ê°€ì¡±</span>
                </div>
            </div>
        </div>

        <!-- ë£¨í‹´ ì¶”ê°€ ëª¨ë‹¬ -->
        <div id="addRoutineModal" class="modal">
            <div class="modal-content">
                <button class="close-btn" onclick="closeModal()">&times;</button>
                <div class="modal-header">âœ¨ ìƒˆ ë£¨í‹´ ì¶”ê°€</div>
                
                <div class="form-group">
                    <label for="routineName">ë£¨í‹´ ì´ë¦„</label>
                    <input type="text" id="routineName" placeholder="ë£¨í‹´ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>

                <div class="form-group">
                    <label for="routineType">ë£¨í‹´ íƒ€ì…</label>
                    <select id="routineType">
                        <option value="yesno">ì˜ˆ/ì•„ë‹ˆì˜¤</option>
                        <option value="number">ìˆ«ì ì…ë ¥</option>
                        <option value="time">ì‹œê°„ ì…ë ¥</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="routineTime">ì‹œì </label>
                    <select id="routineTime">
                        <option value="morning">ğŸŒ… ì•„ì¹¨</option>
                        <option value="afternoon">ğŸŒ ì ì‹¬</option>
                        <option value="evening">ğŸŒ™ ì €ë…</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="routineFreq">ì£¼ê¸°</label>
                    <select id="routineFreq">
                        <option value="daily">ë§¤ì¼</option>
                        <option value="weekday">í‰ì¼</option>
                        <option value="weekend">ì£¼ë§</option>
                    </select>
                </div>

                <div class="btn-group">
                    <button class="btn btn-cancel" onclick="closeModal()">ì·¨ì†Œ</button>
                    <button class="btn" onclick="addRoutine()">ì¶”ê°€</button>
                </div>
            </div>
        </div>

        <!-- ì„±ì·¨ ì¶•í•˜ ëª¨ë‹¬ -->
        <div id="achievementModal" class="modal achievement-modal">
            <div class="modal-content achievement-content">
                <div class="achievement-animation">
                    <div class="celebration-emoji">ğŸ‰</div>
                    <div class="achievement-title" id="achievementTitle">ì¶•í•˜í•©ë‹ˆë‹¤!</div>
                    <div class="achievement-description" id="achievementDesc">ìƒˆë¡œìš´ ê¸°ë¡ì„ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤!</div>
                    <button class="btn celebration-btn" onclick="closeAchievementModal()">ê³„ì†í•˜ê¸°</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <!-- JavaScript ì½”ë“œ -->
    <script>
        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyC6bvEaHsxpLtPv5zM99PmgAwOnRXnhkBM",
            authDomain: "habit-dc62a.firebaseapp.com",
            projectId: "habit-dc62a",
            storageBucket: "habit-dc62a.firebasestorage.app",
            messagingSenderId: "668374525477",
            appId: "1:668374525477:web:ecbecd95ec631fb82cc1cc"
        };

        // ì „ì—­ ë³€ìˆ˜
        let currentUser = null;
        let userRole = 'parent';
        let familyId = null;
        let routines = [];
        let familyMembers = [];
        let auth, db;
        let todayCompletedRoutines = new Set();
        let userStats = {
            currentStreak: 0,
            bestStreak: 0,
            totalDays: 0,
            weeklyScore: 0,
            completionRate: 0
        };

        // ê¸°ë³¸ ëª…ì–¸ë“¤
        const quotes = [
            "ì„±ê³µì€ ë§¤ì¼ì˜ ì‘ì€ ë…¸ë ¥ë“¤ì´ ìŒ“ì—¬ì„œ ë§Œë“¤ì–´ì§„ë‹¤.",
            "ì˜¤ëŠ˜ í•˜ë£¨ë„ ìµœì„ ì„ ë‹¤í•˜ëŠ” í•˜ë£¨ê°€ ë˜ê¸¸.",
            "ì‘ì€ ìŠµê´€ì´ í° ë³€í™”ë¥¼ ë§Œë“ ë‹¤.",
            "ê¾¸ì¤€í•¨ì´ ì²œì¬ë¥¼ ì´ê¸´ë‹¤.",
            "ë§¤ì¼ ì¡°ê¸ˆì”© ë‚˜ì•„ì§€ëŠ” ê²ƒì´ ì¤‘ìš”í•˜ë‹¤.",
            "ëª©í‘œë¥¼ í–¥í•œ ì²« ê±¸ìŒì´ ê°€ì¥ ì¤‘ìš”í•˜ë‹¤.",
            "ì™„ë²½í•˜ì§€ ì•Šì•„ë„ ì‹œì‘í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•˜ë‹¤.",
            "ì˜¤ëŠ˜ì˜ ë‚˜ëŠ” ì–´ì œì˜ ë‚˜ë³´ë‹¤ ì¡°ê¸ˆ ë” ë‚˜ì€ ì‚¬ëŒì´ë‹¤.",
            "ë£¨í‹´ì€ ê¿ˆì„ í˜„ì‹¤ë¡œ ë§Œë“œëŠ” ë‹¤ë¦¬ë‹¤.",
            "ì‘ì€ ì‹¤ì²œì´ í° ê¸°ì ì„ ë§Œë“ ë‹¤."
        ];

        // Firebase ì´ˆê¸°í™”
        function initializeFirebase() {
            try {
                console.log('ğŸ”¥ Firebase ì´ˆê¸°í™” ì‹œì‘...');
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                
                console.log('âœ… Firebase ì´ˆê¸°í™” ì„±ê³µ!');
                
                // ì¸ì¦ ìƒíƒœ ë³€ê²½ ê°ì§€
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        currentUser = user;
                        await loadUserProfile();
                        showMainApp();
                        startRealtimeListeners();
                    } else {
                        currentUser = null;
                        showLoginPage();
                    }
                });
                
                return true;
            } catch (error) {
                console.error('âŒ Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                return false;
            }
        }

        // ì• ë‹ˆë©”ì´ì…˜ íŠ¸ë¦¬ê±° í•¨ìˆ˜ë“¤
        function triggerAnimation(element, animationClass) {
            element.classList.add(animationClass);
            setTimeout(() => {
                element.classList.remove(animationClass);
            }, 600);
        }

        function addRippleEffect(button, event) {
            const ripple = document.createElement('span');
            const rect = button.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            const x = event.clientX - rect.left - size / 2;
            const y = event.clientY - rect.top - size / 2;
            
            ripple.style.width = ripple.style.height = size + 'px';
            ripple.style.left = x + 'px';
            ripple.style.top = y + 'px';
            ripple.classList.add('ripple');
            
            button.appendChild(ripple);
            
            setTimeout(() => {
                ripple.remove();
            }, 600);
        }

        // ì—­í•  ì„ íƒ
        function selectRole(role) {
            userRole = role;
            document.querySelectorAll('.role-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const familyCodeInput = document.getElementById('familyCodeInput');
            if (role === 'child') {
                familyCodeInput.style.display = 'block';
                familyCodeInput.style.animation = 'fadeInUp 0.3s ease-out';
            } else {
                familyCodeInput.style.display = 'none';
            }
        }

        // Google ë¡œê·¸ì¸
        async function signInWithGoogle() {
            const familyCode = document.getElementById('familyCode').value;
            
            if (userRole === 'child' && !familyCode) {
                showNotification('ìë…€ëŠ” ê°€ì¡± ì½”ë“œë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (!auth) {
                showNotification('Firebaseê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            setLoading(true, 'google');
            
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                provider.addScope('email');
                provider.addScope('profile');
                
                const result = await auth.signInWithPopup(provider);
                const user = result.user;
                
                console.log('âœ… Google ë¡œê·¸ì¸ ì„±ê³µ:', user.email);
                
                // ê¸°ì¡´ ì‚¬ìš©ìì¸ì§€ í™•ì¸
                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    
                    if (!userDoc.exists) {
                        console.log('ğŸ†• ìƒˆ ì‚¬ìš©ì - í”„ë¡œí•„ ìƒì„± ì‹œì‘');
                        await createUserProfileFromGoogle(user, familyCode);
                        showNotification('Google ê³„ì •ìœ¼ë¡œ ì„±ê³µì ìœ¼ë¡œ ê°€ì…ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰');
                    } else {
                        console.log('ğŸ‘¤ ê¸°ì¡´ ì‚¬ìš©ì - ë¡œê·¸ì¸ ì™„ë£Œ');
                        showNotification('Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‘‹');
                    }
                } catch (permissionError) {
                    if (permissionError.code === 'permission-denied') {
                        console.log('âš ï¸ ê¶Œí•œ ì˜¤ë¥˜ - ìƒˆ ì‚¬ìš©ìë¡œ ì²˜ë¦¬');
                        await createUserProfileFromGoogle(user, familyCode);
                        showNotification('ìƒˆ ê³„ì •ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰');
                    } else {
                        throw permissionError;
                    }
                }
                
            } catch (error) {
                console.error('Google ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
                
                if (error.code === 'auth/popup-closed-by-user') {
                    showNotification('ë¡œê·¸ì¸ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'error');
                } else if (error.code === 'auth/popup-blocked') {
                    showNotification('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. íŒì—…ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.', 'error');
                } else if (error.code === 'permission-denied') {
                    showNotification('âš ï¸ Firebase ê¶Œí•œ ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”. Firestore ë³´ì•ˆ ê·œì¹™ì„ ì—…ë°ì´íŠ¸í•˜ì„¸ìš”.', 'error');
                } else {
                    showNotification('Google ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
                }
            } finally {
                setLoading(false, 'google');
            }
        }

        // ì´ë©”ì¼ ë¡œê·¸ì¸ í† ê¸€
        function toggleEmailLogin() {
            const section = document.getElementById('emailLoginSection');
            const button = event.target;
            
            if (section.classList.contains('collapsed')) {
                section.classList.remove('collapsed');
                button.textContent = 'ê°„í¸ ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°';
            } else {
                section.classList.add('collapsed');
                button.textContent = 'ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸';
            }
        }

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function generateFamilyCode() {
            return Math.random().toString(36).substr(2, 8).toUpperCase();
        }

        function showNotification(message, type = 'success') {
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease-out forwards';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }, 4000);
        }

        function setLoading(loading, type = 'email') {
            if (type === 'google') {
                const googleBtn = document.querySelector('.google-btn');
                if (googleBtn) {
                    if (loading) {
                        googleBtn.disabled = true;
                        googleBtn.innerHTML = `
                            <div style="width: 20px; height: 20px; border: 2px solid #f3f3f3; border-top: 2px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                            Google ë¡œê·¸ì¸ ì¤‘...
                        `;
                    } else {
                        googleBtn.disabled = false;
                        googleBtn.innerHTML = `
                            <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google" class="google-icon">
                            Googleë¡œ ì‹œì‘í•˜ê¸°
                        `;
                    }
                }
            }
        }

        function showLoginPage() {
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
        }

        function showMainApp() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            const mainApp = document.getElementById('mainApp');
            mainApp.style.animation = 'fadeInUp 0.6s ease-out';
        }

        // í˜„ì¬ ë‚ ì§œ ì—…ë°ì´íŠ¸
        function updateCurrentDate() {
            const today = new Date();
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                weekday: 'long'
            };
            document.getElementById('currentDate').textContent = 
                today.toLocaleDateString('ko-KR', options);
        }

        // ì¼ì¼ ëª…ì–¸ ì—…ë°ì´íŠ¸
        function updateDailyQuote() {
            const today = new Date();
            const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
            const quoteIndex = dayOfYear % quotes.length;
            document.getElementById('dailyQuote').textContent = quotes[quoteIndex];
        }

        // í˜ì´ì§€ ì „í™˜
        function showPage(page) {
            // ëª¨ë“  í˜ì´ì§€ ìˆ¨ê¸°ê¸°
            document.querySelectorAll('.page').forEach(p => {
                p.style.display = 'none';
            });
            
            // ëª¨ë“  ë„¤ë¹„ê²Œì´ì…˜ í•­ëª© ë¹„í™œì„±í™”
            document.querySelectorAll('.nav-item').forEach(nav => {
                nav.classList.remove('active');
            });
            
            // ì„ íƒëœ í˜ì´ì§€ ë° ë„¤ë¹„ê²Œì´ì…˜ í™œì„±í™”
            if (page === 'home') {
                document.getElementById('homePage').style.display = 'block';
                document.querySelectorAll('.nav-item')[0].classList.add('active');
                loadHomeRoutines();
            } else if (page === 'manage') {
                document.getElementById('managePage').style.display = 'block';
                document.querySelectorAll('.nav-item')[1].classList.add('active');
                loadUserRoutines();
            } else if (page === 'stats') {
                document.getElementById('statsPage').style.display = 'block';
                document.querySelectorAll('.nav-item')[2].classList.add('active');
                loadStatsPage();
            } else if (page === 'family') {
                document.getElementById('familyPage').style.display = 'block';
                document.querySelectorAll('.nav-item')[4].classList.add('active');
                loadFamilyPageInfo();
            } else if (page === 'review') {
                showNotification('ğŸ“Š ë¦¬ë·° í˜ì´ì§€ëŠ” ê³§ ì¤€ë¹„ë©ë‹ˆë‹¤!', 'warning');
            }

            // í˜ì´ì§€ ì „í™˜ ì• ë‹ˆë©”ì´ì…˜
            const activePage = document.querySelector('.page[style*="block"]');
            if (activePage) {
                activePage.style.animation = 'fadeInUp 0.4s ease-out';
            }
        }

        // ìŠ¤íŠ¸ë¦­ ë° í†µê³„ ë¡œë“œ
        async function loadUserStats() {
            if (!currentUser || !familyId) return;

            try {
                console.log('ğŸ“Š ì‚¬ìš©ì í†µê³„ ë¡œë“œ ì‹œì‘...');

                // ì§€ë‚œ 30ì¼ê°„ì˜ ë£¨í‹´ ë¡œê·¸ ê°€ì ¸ì˜¤ê¸° (orderBy ì œê±°)
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                const thirtyDaysAgoStr = thirtyDaysAgo.toISOString().split('T')[0];

                const logsSnapshot = await db.collection('routine_logs')
                    .where('userId', '==', currentUser.uid)
                    .where('date', '>=', thirtyDaysAgoStr)
                    .get();

                // ë‚ ì§œë³„ ì™„ë£Œ ë°ì´í„° ì •ë¦¬
                const dailyCompletions = {};
                const totalRoutinesPerDay = {};

                logsSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const date = data.date;
                    
                    if (!dailyCompletions[date]) {
                        dailyCompletions[date] = 0;
                        totalRoutinesPerDay[date] = 0;
                    }
                    
                    totalRoutinesPerDay[date]++;
                    if (data.completed) {
                        dailyCompletions[date]++;
                    }
                });

                // ì—°ì† ì¼ìˆ˜ ê³„ì‚°
                userStats.currentStreak = calculateCurrentStreak(dailyCompletions, totalRoutinesPerDay);
                userStats.bestStreak = calculateBestStreak(dailyCompletions, totalRoutinesPerDay);
                userStats.totalDays = Object.keys(dailyCompletions).length;

                // ì£¼ê°„ ì ìˆ˜ ê³„ì‚° (ì´ë²ˆ ì£¼)
                userStats.weeklyScore = calculateWeeklyScore(dailyCompletions, totalRoutinesPerDay);

                // ì „ì²´ ì™„ë£Œìœ¨ ê³„ì‚°
                let totalCompleted = 0;
                let totalPossible = 0;
                Object.keys(dailyCompletions).forEach(date => {
                    totalCompleted += dailyCompletions[date];
                    totalPossible += totalRoutinesPerDay[date];
                });
                userStats.completionRate = totalPossible > 0 ? Math.round((totalCompleted / totalPossible) * 100) : 0;

                // UI ì—…ë°ì´íŠ¸
                updateStatsUI();

                console.log('âœ… ì‚¬ìš©ì í†µê³„ ë¡œë“œ ì™„ë£Œ:', userStats);

            } catch (error) {
                console.error('âŒ í†µê³„ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // í˜„ì¬ ì—°ì† ì¼ìˆ˜ ê³„ì‚°
        function calculateCurrentStreak(dailyCompletions, totalRoutinesPerDay) {
            const today = new Date();
            let streak = 0;
            
            for (let i = 0; i < 30; i++) {
                const checkDate = new Date(today);
                checkDate.setDate(today.getDate() - i);
                const dateStr = checkDate.toISOString().split('T')[0];
                
                if (dailyCompletions[dateStr] && totalRoutinesPerDay[dateStr]) {
                    const completionRate = dailyCompletions[dateStr] / totalRoutinesPerDay[dateStr];
                    if (completionRate >= 0.8) { // 80% ì´ìƒ ì™„ë£Œ ì‹œ ì„±ê³µí•œ ë‚ ë¡œ ê°„ì£¼
                        streak++;
                    } else {
                        break;
                    }
                } else if (i === 0) {
                    // ì˜¤ëŠ˜ ì•„ë¬´ê²ƒë„ ì•ˆ í–ˆìœ¼ë©´ ìŠ¤íŠ¸ë¦­ 0
                    break;
                } else {
                    // ê³¼ê±° ë‚ ì§œì— ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ìŠ¤íŠ¸ë¦­ ì¤‘ë‹¨
                    break;
                }
            }
            
            return streak;
        }

        // ìµœê³  ì—°ì† ì¼ìˆ˜ ê³„ì‚°
        function calculateBestStreak(dailyCompletions, totalRoutinesPerDay) {
            const dates = Object.keys(dailyCompletions).sort(); // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì •ë ¬
            let bestStreak = 0;
            let currentStreak = 0;
            
            dates.forEach(date => {
                const completionRate = dailyCompletions[date] / totalRoutinesPerDay[date];
                if (completionRate >= 0.8) {
                    currentStreak++;
                    bestStreak = Math.max(bestStreak, currentStreak);
                } else {
                    currentStreak = 0;
                }
            });
            
            return bestStreak;
        }

        // ì£¼ê°„ ì ìˆ˜ ê³„ì‚°
        function calculateWeeklyScore(dailyCompletions, totalRoutinesPerDay) {
            const today = new Date();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay()); // ì´ë²ˆ ì£¼ ì¼ìš”ì¼
            
            let weekScore = 0;
            for (let i = 0; i < 7; i++) {
                const checkDate = new Date(startOfWeek);
                checkDate.setDate(startOfWeek.getDate() + i);
                const dateStr = checkDate.toISOString().split('T')[0];
                
                if (dailyCompletions[dateStr] && totalRoutinesPerDay[dateStr]) {
                    const completionRate = dailyCompletions[dateStr] / totalRoutinesPerDay[dateStr];
                    weekScore += Math.round(completionRate * 100);
                }
            }
            
            return Math.round(weekScore / 7); // ì£¼ê°„ í‰ê· 
        }

        // í†µê³„ UI ì—…ë°ì´íŠ¸
        function updateStatsUI() {
            const currentStreakEl = document.getElementById('currentStreak');
            const todayProgressEl = document.getElementById('todayProgress');
            const weeklyScoreEl = document.getElementById('weeklyScore');

            if (currentStreakEl) currentStreakEl.textContent = userStats.currentStreak;
            if (weeklyScoreEl) weeklyScoreEl.textContent = userStats.weeklyScore;

            // ì˜¤ëŠ˜ ì§„í–‰ë¥  ê³„ì‚°
            calculateTodayProgress().then(progress => {
                if (todayProgressEl) todayProgressEl.textContent = `${progress}%`;
            });

            // í†µê³„ í˜ì´ì§€ ì—…ë°ì´íŠ¸
            const totalDaysEl = document.getElementById('totalDays');
            const bestStreakEl = document.getElementById('bestStreak');
            const completionRateEl = document.getElementById('completionRate');

            if (totalDaysEl) totalDaysEl.textContent = userStats.totalDays;
            if (bestStreakEl) bestStreakEl.textContent = userStats.bestStreak;
            if (completionRateEl) completionRateEl.textContent = `${userStats.completionRate}%`;
        }

        // ì˜¤ëŠ˜ ì§„í–‰ë¥  ê³„ì‚° (ë‹¨ìˆœí•œ ì¿¼ë¦¬ ì‚¬ìš©)
        async function calculateTodayProgress() {
            if (!currentUser || !familyId) return 0;

            try {
                // ì˜¤ëŠ˜ í•´ì•¼ í•  ë£¨í‹´ë“¤ ê°€ì ¸ì˜¤ê¸° (ë‹¨ìˆœí•œ ì¿¼ë¦¬)
                const routinesSnapshot = await db.collection('routines')
                    .where('userId', '==', currentUser.uid)
                    .where('familyId', '==', familyId)
                    .get();

                let totalTodayRoutines = 0;
                routinesSnapshot.docs.forEach(doc => {
                    const routine = doc.data();
                    if (shouldShowRoutineToday(routine)) {
                        totalTodayRoutines++;
                    }
                });

                if (totalTodayRoutines === 0) return 100;

                const completedCount = todayCompletedRoutines.size;
                return Math.round((completedCount / totalTodayRoutines) * 100);

            } catch (error) {
                console.error('âŒ ì˜¤ëŠ˜ ì§„í–‰ë¥  ê³„ì‚° ì˜¤ë¥˜:', error);
                return 0;
            }
        }

        // ì£¼ê°„ ìº˜ë¦°ë” ìƒì„±
        async function loadWeekCalendar() {
            const weekCalendar = document.getElementById('weekCalendar');
            if (!weekCalendar) return;

            const today = new Date();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay()); // ì´ë²ˆ ì£¼ ì¼ìš”ì¼

            weekCalendar.innerHTML = '';

            const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];

            for (let i = 0; i < 7; i++) {
                const date = new Date(startOfWeek);
                date.setDate(startOfWeek.getDate() + i);
                const dateStr = date.toISOString().split('T')[0];
                const isToday = dateStr === today.toISOString().split('T')[0];

                // í•´ë‹¹ ë‚ ì§œì˜ ì™„ë£Œìœ¨ ê³„ì‚°
                const completionRate = await getDayCompletionRate(dateStr);

                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';
                if (isToday) dayEl.classList.add('today');

                let levelClass = 'level-0';
                if (completionRate >= 80) levelClass = 'level-4';
                else if (completionRate >= 60) levelClass = 'level-3';
                else if (completionRate >= 40) levelClass = 'level-2';
                else if (completionRate > 0) levelClass = 'level-1';

                dayEl.innerHTML = `
                    <div class="day-name">${dayNames[i]}</div>
                    <div class="day-number">${date.getDate()}</div>
                    <div class="day-progress ${levelClass}"></div>
                `;

                weekCalendar.appendChild(dayEl);
            }
        }

        // íŠ¹ì • ë‚ ì§œì˜ ì™„ë£Œìœ¨ ê³„ì‚°
        async function getDayCompletionRate(dateStr) {
            if (!currentUser || !familyId) return 0;

            try {
                // ë‹¨ìˆœí•œ ì¿¼ë¦¬ ì‚¬ìš©
                const logsSnapshot = await db.collection('routine_logs')
                    .where('userId', '==', currentUser.uid)
                    .where('date', '==', dateStr)
                    .get();

                let totalRoutines = 0;
                let completedRoutines = 0;

                logsSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    totalRoutines++;
                    if (data.completed) {
                        completedRoutines++;
                    }
                });

                return totalRoutines > 0 ? Math.round((completedRoutines / totalRoutines) * 100) : 0;

            } catch (error) {
                console.error('âŒ ë‚ ì§œë³„ ì™„ë£Œìœ¨ ê³„ì‚° ì˜¤ë¥˜:', error);
                return 0;
            }
        }

        // í™ˆ í˜ì´ì§€ ë£¨í‹´ ë¡œë“œ
        async function loadHomeRoutines() {
            console.log('ğŸ  í™ˆ í˜ì´ì§€ ë£¨í‹´ ë¡œë“œ ì‹œì‘');
            
            if (!currentUser || !familyId) {
                console.log('âŒ ì‚¬ìš©ì ë˜ëŠ” ê°€ì¡± ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤');
                return;
            }

            try {
                const routineList = document.getElementById('routineList');
                routineList.innerHTML = '<div class="loading-message">ë£¨í‹´ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

                // ì‚¬ìš©ìì˜ ë£¨í‹´ë“¤ ê°€ì ¸ì˜¤ê¸° (orderBy ì œê±°ë¡œ ì¸ë±ìŠ¤ ìš”êµ¬ì‚¬í•­ í•´ê²°)
                const routinesSnapshot = await db.collection('routines')
                    .where('userId', '==', currentUser.uid)
                    .where('familyId', '==', familyId)
                    .get();

                console.log('ğŸ“Š ì¡°íšŒëœ ë£¨í‹´ ìˆ˜:', routinesSnapshot.size);

                // ì˜¤ëŠ˜ ì™„ë£Œëœ ë£¨í‹´ë“¤ í™•ì¸
                await loadTodayCompletedRoutines();

                // í†µê³„ ë¡œë“œ
                await loadUserStats();

                // ì£¼ê°„ ìº˜ë¦°ë” ë¡œë“œ
                await loadWeekCalendar();

                routineList.innerHTML = '';

                if (routinesSnapshot.empty) {
                    routineList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“</div>
                            <div class="empty-state-title">ì•„ì§ ë£¨í‹´ì´ ì—†ìŠµë‹ˆë‹¤</div>
                            <div class="empty-state-description">ê´€ë¦¬ íƒ­ì—ì„œ ìƒˆë¡œìš´ ë£¨í‹´ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!</div>
                        </div>
                    `;
                    return;
                }

                // ì‹œê°„ëŒ€ë³„ë¡œ ë£¨í‹´ ì •ë¦¬
                const routinesByTime = {
                    morning: [],
                    afternoon: [],
                    evening: []
                };

                // ë£¨í‹´ì„ order í•„ë“œë¡œ ì •ë ¬
                const sortedRoutines = [];
                routinesSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    sortedRoutines.push({
                        id: doc.id,
                        ...data
                    });
                });

                // order í•„ë“œë¡œ ì •ë ¬ (í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ)
                sortedRoutines.sort((a, b) => (a.order || 0) - (b.order || 0));

                sortedRoutines.forEach(routine => {
                    // ì£¼ê¸° í™•ì¸ (ì˜¤ëŠ˜ì´ í•´ë‹¹ ë£¨í‹´ì„ í•´ì•¼ í•˜ëŠ” ë‚ ì¸ì§€)
                    if (shouldShowRoutineToday(routine)) {
                        routinesByTime[routine.time].push(routine);
                    }
                });

                // ì‹œê°„ëŒ€ë³„ë¡œ ë Œë”ë§
                const timeLabels = {
                    morning: 'ğŸŒ… ì•„ì¹¨ ë£¨í‹´',
                    afternoon: 'ğŸŒ ì ì‹¬ ë£¨í‹´', 
                    evening: 'ğŸŒ™ ì €ë… ë£¨í‹´'
                };

                for (const [timeSlot, routines] of Object.entries(routinesByTime)) {
                    if (routines.length > 0) {
                        // ì‹œê°„ëŒ€ ì œëª© ì¶”ê°€
                        const timeHeader = document.createElement('div');
                        timeHeader.className = 'time-header';
                        timeHeader.innerHTML = `
                            <h3 style="margin: 2rem 0 1rem 0; padding: 0 0.5rem; color: var(--primary); font-weight: 800; font-size: 1.25rem;">
                                ${timeLabels[timeSlot]}
                            </h3>
                        `;
                        routineList.appendChild(timeHeader);

                        // í•´ë‹¹ ì‹œê°„ëŒ€ì˜ ë£¨í‹´ë“¤ ì¶”ê°€
                        routines.forEach((routine, index) => {
                            const routineElement = createRoutineElement(routine, index);
                            routineList.appendChild(routineElement);
                        });
                    }
                }

                console.log('âœ… í™ˆ ë£¨í‹´ ë¡œë“œ ì™„ë£Œ');

            } catch (error) {
                console.error('âŒ í™ˆ ë£¨í‹´ ë¡œë“œ ì˜¤ë¥˜:', error);
                const routineList = document.getElementById('routineList');
                routineList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">âš ï¸</div>
                        <div class="empty-state-title">ë£¨í‹´ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</div>
                    </div>
                `;
            }
        }

        // ì˜¤ëŠ˜ ì™„ë£Œëœ ë£¨í‹´ë“¤ ë¡œë“œ (ë‹¨ìˆœí•œ ì¿¼ë¦¬ ì‚¬ìš©)
        async function loadTodayCompletedRoutines() {
            const today = new Date().toISOString().split('T')[0];
            
            try {
                const logsSnapshot = await db.collection('routine_logs')
                    .where('userId', '==', currentUser.uid)
                    .where('date', '==', today)
                    .get();

                todayCompletedRoutines.clear();
                logsSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    if (data.completed) {
                        todayCompletedRoutines.add(data.routineId);
                    }
                });

                console.log('ğŸ“‹ ì˜¤ëŠ˜ ì™„ë£Œëœ ë£¨í‹´ë“¤:', Array.from(todayCompletedRoutines));
            } catch (error) {
                console.error('âŒ ì™„ë£Œëœ ë£¨í‹´ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ë£¨í‹´ì´ ì˜¤ëŠ˜ í‘œì‹œë˜ì–´ì•¼ í•˜ëŠ”ì§€ í™•ì¸
        function shouldShowRoutineToday(routine) {
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0: ì¼ìš”ì¼, 1: ì›”ìš”ì¼, ..., 6: í† ìš”ì¼
            
            switch (routine.frequency) {
                case 'daily':
                    return true;
                case 'weekday':
                    return dayOfWeek >= 1 && dayOfWeek <= 5; // ì›”-ê¸ˆ
                case 'weekend':
                    return dayOfWeek === 0 || dayOfWeek === 6; // í† -ì¼
                default:
                    return true;
            }
        }

        // ë£¨í‹´ ìš”ì†Œ ìƒì„±
        function createRoutineElement(routine, index) {
            const routineDiv = document.createElement('div');
            routineDiv.className = 'routine-item';
            routineDiv.style.animationDelay = `${index * 0.1}s`;
            
            const isCompleted = todayCompletedRoutines.has(routine.id);
            
            let controlsHTML = '';
            
            switch (routine.type) {
                case 'yesno':
                    controlsHTML = `
                        <div class="yes-no-btns">
                            <button class="yes-btn ${isCompleted ? 'active' : ''}" 
                                    onclick="updateRoutine('${routine.id}', true)"
                                    ${isCompleted ? 'disabled' : ''}>
                                âœ… ì™„ë£Œ
                            </button>
                            <button class="no-btn" onclick="updateRoutine('${routine.id}', false)">
                                âŒ ê±´ë„ˆë›°ê¸°
                            </button>
                        </div>
                    `;
                    break;
                    
                case 'number':
                    controlsHTML = `
                        <input type="number" class="number-input" 
                               placeholder="ìˆ«ì ì…ë ¥" min="0" 
                               ${isCompleted ? 'disabled' : ''}>
                        <button class="yes-btn ${isCompleted ? 'active' : ''}" 
                                onclick="updateRoutineNumber('${routine.id}')"
                                ${isCompleted ? 'disabled' : ''}>
                            ì €ì¥
                        </button>
                    `;
                    break;
                    
                case 'time':
                    controlsHTML = `
                        <input type="time" class="time-input" 
                               ${isCompleted ? 'disabled' : ''}>
                        <button class="yes-btn ${isCompleted ? 'active' : ''}" 
                                onclick="updateRoutineTime('${routine.id}')"
                                ${isCompleted ? 'disabled' : ''}>
                            ì €ì¥
                        </button>
                    `;
                    break;
            }

            routineDiv.innerHTML = `
                <div class="routine-title">
                    ${routine.name}
                    ${isCompleted ? '<span style="color: var(--success); margin-left: 0.5rem;">âœ…</span>' : ''}
                </div>
                <div class="routine-controls">
                    ${controlsHTML}
                </div>
            `;

            return routineDiv;
        }

        // ìˆ«ì ë£¨í‹´ ì—…ë°ì´íŠ¸
        async function updateRoutineNumber(routineId) {
            const input = event.target.parentElement.querySelector('.number-input');
            const value = input.value;
            
            if (!value || value === '') {
                showNotification('ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            await updateRoutine(routineId, parseInt(value));
        }

        // ì‹œê°„ ë£¨í‹´ ì—…ë°ì´íŠ¸
        async function updateRoutineTime(routineId) {
            const input = event.target.parentElement.querySelector('.time-input');
            const value = input.value;
            
            if (!value || value === '') {
                showNotification('ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            await updateRoutine(routineId, value);
        }

        // ë£¨í‹´ ì—…ë°ì´íŠ¸
        async function updateRoutine(routineId, value) {
            if (!currentUser) return;
            
            const today = new Date().toISOString().split('T')[0];
            const logData = {
                routineId: routineId,
                userId: currentUser.uid,
                familyId: familyId,
                value: value,
                completed: value !== false, // falseê°€ ì•„ë‹ˆë©´ ì™„ë£Œë¡œ ê°„ì£¼
                date: today,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection('routine_logs').doc(`${routineId}_${currentUser.uid}_${today}`).set(logData);
                
                if (value !== false) {
                    showNotification('âœ… ë£¨í‹´ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                    todayCompletedRoutines.add(routineId);
                    
                    // ìŠ¤íŠ¸ë¦­ ì²´í¬ ë° ì¶•í•˜ ë©”ì‹œì§€
                    checkForAchievements();
                } else {
                    showNotification('ğŸ“ ë£¨í‹´ì„ ê±´ë„ˆë›°ì—ˆìŠµë‹ˆë‹¤.');
                    todayCompletedRoutines.delete(routineId);
                }
                
                // UI ì—…ë°ì´íŠ¸
                loadHomeRoutines();
                
                // ì„±ê³µ ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼
                const targetElement = event.target;
                if (targetElement.classList.contains('yes-btn') || targetElement.classList.contains('no-btn')) {
                    triggerAnimation(targetElement, 'bounce');
                }
            } catch (error) {
                console.error('ë£¨í‹´ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
                showNotification('ë£¨í‹´ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ì„±ì·¨ í™•ì¸ ë° ì¶•í•˜
        async function checkForAchievements() {
            // í†µê³„ ë‹¤ì‹œ ë¡œë“œ
            await loadUserStats();
            
            // ìƒˆë¡œìš´ ìŠ¤íŠ¸ë¦­ ê¸°ë¡ ë‹¬ì„± ì‹œ
            if (userStats.currentStreak > 0 && userStats.currentStreak === userStats.bestStreak) {
                if (userStats.currentStreak % 7 === 0) { // 7ì¼ ë‹¨ìœ„ë¡œ ì¶•í•˜
                    showAchievementModal(
                        `ğŸ”¥ ${userStats.currentStreak}ì¼ ì—°ì† ë‹¬ì„±!`,
                        'ì •ë§ ëŒ€ë‹¨í•´ìš”! ê¾¸ì¤€í•¨ì´ ìŠµê´€ì´ ë˜ê³  ìˆì–´ìš”.'
                    );
                } else if ([3, 5, 10, 30, 100].includes(userStats.currentStreak)) {
                    showAchievementModal(
                        `ğŸ‰ ${userStats.currentStreak}ì¼ ì—°ì† ë‹¬ì„±!`,
                        'ë©‹ì§„ ê¸°ë¡ì´ì—ìš”! ê³„ì† ì´ì–´ë‚˜ê°€ì„¸ìš”.'
                    );
                }
            }
            
            // ì˜¤ëŠ˜ ëª¨ë“  ë£¨í‹´ ì™„ë£Œ ì‹œ
            const todayProgress = await calculateTodayProgress();
            if (todayProgress === 100) {
                setTimeout(() => {
                    showAchievementModal(
                        'ğŸ† ì˜¤ëŠ˜ì˜ ë¯¸ì…˜ ì™„ë£Œ!',
                        'ëª¨ë“  ë£¨í‹´ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. í›Œë¥­í•´ìš”!'
                    );
                }, 1000);
            }
        }

        // ì„±ì·¨ ëª¨ë‹¬ í‘œì‹œ
        function showAchievementModal(title, description) {
            const modal = document.getElementById('achievementModal');
            const titleEl = document.getElementById('achievementTitle');
            const descEl = document.getElementById('achievementDesc');
            
            if (titleEl) titleEl.textContent = title;
            if (descEl) descEl.textContent = description;
            
            modal.style.display = 'block';
            
            setTimeout(() => {
                const content = modal.querySelector('.achievement-content');
                if (content) {
                    content.style.animation = 'fadeInUp 0.5s ease-out';
                }
            }, 10);
        }

        // ì„±ì·¨ ëª¨ë‹¬ ë‹«ê¸°
        function closeAchievementModal() {
            const modal = document.getElementById('achievementModal');
            modal.style.display = 'none';
        }

        // í†µê³„ í˜ì´ì§€ ë¡œë“œ
        function loadStatsPage() {
            console.log('ğŸ“ˆ í†µê³„ í˜ì´ì§€ ë¡œë“œ');
            loadUserStats();
            loadMonthlyHeatmap();
            loadRoutineStats();
        }

        // ì›”ê°„ íˆíŠ¸ë§µ ë¡œë“œ
        async function loadMonthlyHeatmap() {
            const container = document.getElementById('heatmapContainer');
            if (!container) return;

            container.innerHTML = 'íˆíŠ¸ë§µì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';

            try {
                const today = new Date();
                const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);

                const heatmapHTML = [];
                const currentDate = new Date(firstDay);

                while (currentDate <= lastDay) {
                    const dateStr = currentDate.toISOString().split('T')[0];
                    const completionRate = await getDayCompletionRate(dateStr);
                    
                    let level = 0;
                    if (completionRate >= 80) level = 4;
                    else if (completionRate >= 60) level = 3;
                    else if (completionRate >= 40) level = 2;
                    else if (completionRate > 0) level = 1;

                    heatmapHTML.push(`
                        <div class="heatmap-day" data-level="${level}" title="${dateStr}: ${completionRate}%">
                            ${currentDate.getDate()}
                        </div>
                    `);

                    currentDate.setDate(currentDate.getDate() + 1);
                }

                container.innerHTML = `<div class="heatmap-grid">${heatmapHTML.join('')}</div>`;

            } catch (error) {
                console.error('âŒ íˆíŠ¸ë§µ ë¡œë“œ ì˜¤ë¥˜:', error);
                container.innerHTML = 'íˆíŠ¸ë§µì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
            }
        }

        // ë£¨í‹´ë³„ í†µê³„ ë¡œë“œ
        async function loadRoutineStats() {
            const container = document.getElementById('routineStatsContainer');
            if (!container || !currentUser || !familyId) return;

            try {
                const routinesSnapshot = await db.collection('routines')
                    .where('userId', '==', currentUser.uid)
                    .where('familyId', '==', familyId)
                    .get();

                const statsHTML = [];

                for (const doc of routinesSnapshot.docs) {
                    const routine = doc.data();
                    const routineId = doc.id;

                    // ì§€ë‚œ 30ì¼ê°„ì˜ í•´ë‹¹ ë£¨í‹´ ì™„ë£Œìœ¨ ê³„ì‚° (ë‹¨ìˆœí•œ ì¿¼ë¦¬ ì‚¬ìš©)
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    const thirtyDaysAgoStr = thirtyDaysAgo.toISOString().split('T')[0];

                    const logsSnapshot = await db.collection('routine_logs')
                        .where('routineId', '==', routineId)
                        .where('userId', '==', currentUser.uid)
                        .get();

                    // ë‚ ì§œ í•„í„°ë§ì„ í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œì—ì„œ ì²˜ë¦¬
                    let totalDays = 0;
                    let completedDays = 0;

                    logsSnapshot.docs.forEach(doc => {
                        const data = doc.data();
                        if (data.date >= thirtyDaysAgoStr) {
                            totalDays++;
                            if (data.completed) {
                                completedDays++;
                            }
                        }
                    });

                    const completionRate = totalDays > 0 ? Math.round((completedDays / totalDays) * 100) : 0;

                    statsHTML.push(`
                        <div class="routine-stat-card">
                            <div class="routine-stat-name">${routine.name}</div>
                            <div class="routine-stat-rate">${completionRate}%</div>
                            <div class="routine-stat-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${completionRate}%"></div>
                                </div>
                            </div>
                            <div class="routine-stat-detail">${completedDays}/${totalDays}ì¼ ì™„ë£Œ</div>
                        </div>
                    `);
                }

                container.innerHTML = statsHTML.join('');

            } catch (error) {
                console.error('âŒ ë£¨í‹´ë³„ í†µê³„ ë¡œë“œ ì˜¤ë¥˜:', error);
                container.innerHTML = 'í†µê³„ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
            }
        }

        // ë‚˜ë¨¸ì§€ ê¸°ì¡´ í•¨ìˆ˜ë“¤... (ê°€ì¡± í˜ì´ì§€, ê´€ë¦¬ í˜ì´ì§€, ë¡œê·¸ì¸ ë“±)
        
        // ê°€ì¡± í˜ì´ì§€ ì •ë³´ ë¡œë“œ
        async function loadFamilyPageInfo() {
            console.log('ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ê°€ì¡± í˜ì´ì§€ ì •ë³´ ë¡œë“œ');
            
            if (!currentUser || !familyId) {
                console.log('âŒ ì‚¬ìš©ì ë˜ëŠ” ê°€ì¡± ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤');
                return;
            }

            try {
                if (userRole === 'parent') {
                    const familyDoc = await db.collection('families').doc(familyId).get();
                    if (familyDoc.exists) {
                        const familyData = familyDoc.data();
                        const familyCode = familyData.familyCode || familyId;
                        const memberCount = familyData.members ? familyData.members.length : 1;
                        const createdDate = familyData.createdAt ? familyData.createdAt.toDate().toLocaleDateString('ko-KR') : '-';
                        
                        const familyCodeCard = document.getElementById('familyCodeCard');
                        const familyCodeMain = document.getElementById('familyCodeMain');
                        const memberCountEl = document.getElementById('memberCount');
                        const familyCreatedDateEl = document.getElementById('familyCreatedDate');
                        
                        if (familyCodeCard && familyCodeMain) {
                            familyCodeMain.textContent = familyCode;
                            if (memberCountEl) memberCountEl.textContent = `${memberCount}ëª…`;
                            if (familyCreatedDateEl) familyCreatedDateEl.textContent = createdDate;
                            
                            familyCodeCard.classList.remove('hidden');
                            familyCodeCard.style.display = 'block';
                        }
                        
                        window.currentFamilyCode = familyCode;
                    }
                } else {
                    const familyCodeCard = document.getElementById('familyCodeCard');
                    if (familyCodeCard) {
                        familyCodeCard.classList.add('hidden');
                        familyCodeCard.style.display = 'none';
                    }
                }
                
                await loadFamilyMembers();
                
            } catch (error) {
                console.error('âŒ ê°€ì¡± í˜ì´ì§€ ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ê°€ì¡± êµ¬ì„±ì› ë¡œë“œ
        async function loadFamilyMembers() {
            if (!familyId) return;

            try {
                const familyDoc = await db.collection('families').doc(familyId).get();
                if (!familyDoc.exists) return;

                const familyData = familyDoc.data();
                const memberIds = familyData.members || [];

                const familyMembersContainer = document.getElementById('familyMembers');
                familyMembersContainer.innerHTML = '';

                for (const memberId of memberIds) {
                    const memberDoc = await db.collection('users').doc(memberId).get();
                    if (memberDoc.exists) {
                        const memberData = memberDoc.data();
                        const memberCard = createMemberCard(memberData, memberId);
                        familyMembersContainer.appendChild(memberCard);
                    }
                }
            } catch (error) {
                console.error('âŒ ê°€ì¡± êµ¬ì„±ì› ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ê°€ì¡± êµ¬ì„±ì› ì¹´ë“œ ìƒì„±
        function createMemberCard(memberData, memberId) {
            const card = document.createElement('div');
            card.className = 'member-card';
            
            const displayName = memberData.displayName || memberData.email.split('@')[0];
            const role = memberData.role === 'parent' ? 'ë¶€ëª¨' : 'ìë…€';
            const isOnline = memberId === currentUser?.uid;
            
            card.innerHTML = `
                <div class="member-header">
                    <div class="member-info">
                        <div class="member-name">${displayName}</div>
                        <div class="member-role">${role}</div>
                    </div>
                    <div class="member-status ${isOnline ? 'online' : 'offline'}">
                        ${isOnline ? 'ONLINE' : 'OFFLINE'}
                    </div>
                </div>
                <div class="routine-progress">
                    <div class="routine-badge completed">ìš´ë™ ì™„ë£Œ</div>
                    <div class="routine-badge pending">ë¬¼ë§ˆì‹œê¸° ëŒ€ê¸°</div>
                    <div class="routine-badge completed">ìˆ˜ë©´ì‹œê°„ ê¸°ë¡</div>
                </div>
            `;
            
            return card;
        }

        // ê°€ì¡± ì½”ë“œ ë³µì‚¬
        async function copyFamilyCode() {
            const familyCode = window.currentFamilyCode || document.getElementById('familyCodeMain').textContent;
            
            if (!familyCode || familyCode === '-') {
                showNotification('ë³µì‚¬í•  ê°€ì¡± ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            
            try {
                await navigator.clipboard.writeText(familyCode);
                showNotification(`ğŸ‰ ê°€ì¡± ì½”ë“œ "${familyCode}"ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                
                const copyBtn = document.querySelector('.copy-btn');
                if (copyBtn) {
                    const originalText = copyBtn.textContent;
                    copyBtn.textContent = 'âœ… ë³µì‚¬ë¨!';
                    copyBtn.style.background = 'rgba(16, 185, 129, 0.3)';
                    
                    setTimeout(() => {
                        copyBtn.textContent = originalText;
                        copyBtn.style.background = 'rgba(255, 255, 255, 0.2)';
                    }, 2000);
                }
                
            } catch (error) {
                console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', error);
                
                const codeElement = document.getElementById('familyCodeMain');
                if (codeElement) {
                    const range = document.createRange();
                    range.selectNode(codeElement);
                    window.getSelection().removeAllRanges();
                    window.getSelection().addRange(range);
                    showNotification('ê°€ì¡± ì½”ë“œê°€ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤. Ctrl+Cë¡œ ë³µì‚¬í•˜ì„¸ìš”!');
                }
            }
        }

        // ì¸ì¦ ì²˜ë¦¬ (ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸)
        async function handleAuth(type) {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const familyCode = document.getElementById('familyCode').value;

            if (!email || !password) {
                showNotification('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (userRole === 'child' && type === 'register' && !familyCode) {
                showNotification('ê°€ì¡± ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                let userCredential;
                
                if (type === 'login') {
                    userCredential = await auth.signInWithEmailAndPassword(email, password);
                } else {
                    userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    await createUserProfile(userCredential.user, familyCode);
                }

                showNotification('âœ¨ ì„±ê³µì ìœ¼ë¡œ ' + (type === 'login' ? 'ë¡œê·¸ì¸' : 'íšŒì›ê°€ì…') + 'ë˜ì—ˆìŠµë‹ˆë‹¤!');
                
            } catch (error) {
                console.error('ì¸ì¦ ì˜¤ë¥˜:', error);
                showNotification('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            }
        }

        // ì‚¬ìš©ì í”„ë¡œí•„ ìƒì„±
        async function createUserProfile(user, familyCode = null) {
            const userData = {
                email: user.email,
                role: userRole,
                authProvider: 'email',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                lastActive: firebase.firestore.FieldValue.serverTimestamp()
            };

            if (userRole === 'parent') {
                const newFamilyId = generateFamilyCode();
                userData.familyId = newFamilyId;
                userData.isParent = true;

                await db.collection('families').doc(newFamilyId).set({
                    parentId: user.uid,
                    parentName: user.email.split('@')[0],
                    members: [user.uid],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    familyCode: newFamilyId
                });

                setTimeout(() => {
                    document.getElementById('generatedFamilyCode').textContent = newFamilyId;
                    document.getElementById('familyCodeDisplay').classList.remove('hidden');
                    showNotification(`ğŸ”‘ ê°€ì¡± ì½”ë“œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤: ${newFamilyId}`);
                }, 1000);
                
            } else {
                if (familyCode) {
                    const familyDoc = await db.collection('families').doc(familyCode).get();
                    if (familyDoc.exists) {
                        userData.familyId = familyCode;
                        userData.isParent = false;

                        await db.collection('families').doc(familyCode).update({
                            members: firebase.firestore.FieldValue.arrayUnion(user.uid)
                        });
                    } else {
                        throw new Error('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê°€ì¡± ì½”ë“œì…ë‹ˆë‹¤.');
                    }
                }
            }

            await db.collection('users').doc(user.uid).set(userData);
            await createDefaultRoutines(user.uid, userData.familyId);
        }

        // ê¸°ë³¸ ë£¨í‹´ ìƒì„±
        async function createDefaultRoutines(userId, familyId) {
            const defaultRoutines = [
                { name: 'ğŸŒ™ ì·¨ì¹¨ ì‹œê°„', type: 'time', time: 'evening', frequency: 'daily', order: 1 },
                { name: 'ğŸŒ… ê¸°ìƒ ì‹œê°„', type: 'time', time: 'morning', frequency: 'daily', order: 2 },
                { name: 'ğŸ’ª ìš´ë™í•˜ê¸°', type: 'yesno', time: 'morning', frequency: 'daily', order: 3 },
                { name: 'ğŸ’§ ë¬¼ ë§ˆì‹œê¸° (ì”)', type: 'number', time: 'evening', frequency: 'daily', order: 4 }
            ];

            const batch = db.batch();
            defaultRoutines.forEach((routine) => {
                const routineRef = db.collection('routines').doc();
                batch.set(routineRef, {
                    ...routine,
                    userId: userId,
                    familyId: familyId,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            });

            await batch.commit();
        }

        // ë£¨í‹´ ì¶”ê°€
        async function addRoutine() {
            console.log('ğŸ”§ ë£¨í‹´ ì¶”ê°€ ì‹œì‘');
            
            if (!currentUser) {
                showNotification('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
                return;
            }
            
            if (!familyId) {
                try {
                    await loadUserProfile();
                } catch (error) {
                    console.error('âŒ í”„ë¡œí•„ ì¬ë¡œë“œ ì‹¤íŒ¨:', error);
                }
            }
            
            const nameInput = document.getElementById('routineName');
            const typeInput = document.getElementById('routineType');
            const timeInput = document.getElementById('routineTime');
            const freqInput = document.getElementById('routineFreq');
            
            if (!nameInput) {
                showNotification('ì…ë ¥ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            
            const name = nameInput.value;
            const type = typeInput ? typeInput.value : 'yesno';
            const time = timeInput ? timeInput.value : 'morning';
            const frequency = freqInput ? freqInput.value : 'daily';
            
            if (!name.trim()) {
                showNotification('ë£¨í‹´ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            let userFamilyId = familyId;
            if (!userFamilyId) {
                try {
                    const userDoc = await db.collection('users').doc(currentUser.uid).get();
                    if (userDoc.exists) {
                        userFamilyId = userDoc.data().familyId;
                        familyId = userFamilyId;
                    }
                } catch (error) {
                    console.error('âŒ familyId ì¡°íšŒ ì‹¤íŒ¨:', error);
                    if (error.code === 'permission-denied') {
                        showNotification('âš ï¸ Firebase ê¶Œí•œ ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
                        return;
                    }
                }
            }

            if (!userFamilyId) {
                showNotification('ê°€ì¡± ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                const routineData = {
                    name: name.trim(),
                    type: type,
                    time: time,
                    frequency: frequency,
                    order: Date.now(),
                    userId: currentUser.uid,
                    familyId: userFamilyId,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                const docRef = await db.collection('routines').add(routineData);
                
                showNotification(`âœ¨ ìƒˆ ë£¨í‹´ "${name}"ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                closeModal();
                nameInput.value = '';
                
                setTimeout(() => {
                    loadUserRoutines();
                    if (document.getElementById('homePage').style.display === 'block') {
                        loadHomeRoutines();
                    }
                }, 500);
                
            } catch (error) {
                console.error('âŒ ë£¨í‹´ ì¶”ê°€ ì˜¤ë¥˜:', error);
                if (error.code === 'permission-denied') {
                    showNotification('âš ï¸ Firebase ê¶Œí•œ ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
                } else {
                    showNotification('ë£¨í‹´ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
                }
            }
        }

        // ì‚¬ìš©ì ë£¨í‹´ ë¡œë“œ (ê´€ë¦¬ í˜ì´ì§€ìš©)
        async function loadUserRoutines() {
            if (!currentUser || !familyId) {
                console.log('âŒ ë£¨í‹´ ë¡œë“œ ì¡°ê±´ ë¶ˆì¶©ì¡±');
                return;
            }
            
            try {
                const routinesSnapshot = await db.collection('routines')
                    .where('userId', '==', currentUser.uid)
                    .where('familyId', '==', familyId)
                    .get();

                const manageList = document.getElementById('manageRoutineList');
                if (!manageList) {
                    return;
                }
                
                manageList.innerHTML = '';

                if (routinesSnapshot.empty) {
                    manageList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“</div>
                            <div class="empty-state-title">ì•„ì§ ì¶”ê°€ëœ ë£¨í‹´ì´ ì—†ìŠµë‹ˆë‹¤</div>
                            <div class="empty-state-description">ìœ„ì˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì²« ë²ˆì§¸ ë£¨í‹´ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!</div>
                        </div>
                    `;
                    return;
                }

                // ìƒì„± ì‹œê°„ ìˆœìœ¼ë¡œ ì •ë ¬ (í´ë¼ì´ì–¸íŠ¸ì—ì„œ)
                const routines = [];
                routinesSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    routines.push({
                        id: doc.id,
                        ...data,
                        createdAt: data.createdAt?.toDate() || new Date()
                    });
                });

                routines.sort((a, b) => b.createdAt.getTime() - a.createdAt.getTime());

                routines.forEach((routine, index) => {
                    const routineEl = document.createElement('div');
                    routineEl.className = 'routine-item';
                    routineEl.style.animationDelay = `${index * 0.1}s`;
                    
                    const typeMap = {
                        'yesno': 'ì˜ˆ/ì•„ë‹ˆì˜¤',
                        'number': 'ìˆ«ì ì…ë ¥',
                        'time': 'ì‹œê°„ ì…ë ¥'
                    };
                    
                    const timeMap = {
                        'morning': 'ğŸŒ… ì•„ì¹¨',
                        'afternoon': 'ğŸŒ ì ì‹¬',
                        'evening': 'ğŸŒ™ ì €ë…'
                    };
                    
                    const freqMap = {
                        'daily': 'ë§¤ì¼',
                        'weekday': 'í‰ì¼',
                        'weekend': 'ì£¼ë§'
                    };
                    
                    routineEl.innerHTML = `
                        <div class="routine-title">${routine.name}</div>
                        <div style="font-size: 0.875rem; color: var(--text-secondary); margin: 0.75rem 0;">
                            <span style="background: rgba(99, 102, 241, 0.1); color: var(--primary); padding: 0.25rem 0.5rem; border-radius: 0.5rem; margin-right: 0.5rem; font-weight: 600;">${typeMap[routine.type]}</span>
                            <span style="background: rgba(236, 72, 153, 0.1); color: var(--secondary); padding: 0.25rem 0.5rem; border-radius: 0.5rem; margin-right: 0.5rem; font-weight: 600;">${timeMap[routine.time]}</span>
                            <span style="background: rgba(16, 185, 129, 0.1); color: var(--success); padding: 0.25rem 0.5rem; border-radius: 0.5rem; font-weight: 600;">${freqMap[routine.frequency]}</span>
                        </div>
                        <div style="font-size: 0.75rem; color: var(--gray-400);">
                            ìƒì„±ì¼: ${routine.createdAt.toLocaleDateString('ko-KR')}
                        </div>
                    `;
                    manageList.appendChild(routineEl);
                });
                
            } catch (error) {
                console.error('âŒ ë£¨í‹´ ë¡œë“œ ì˜¤ë¥˜:', error);
                
                const manageList = document.getElementById('manageRoutineList');
                if (manageList) {
                    manageList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">âš ï¸</div>
                            <div class="empty-state-title">ë£¨í‹´ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</div>
                        </div>
                    `;
                }
            }
        }

        // ëª¨ë‹¬ ê´€ë ¨
        function openAddRoutineModal() {
            const modal = document.getElementById('addRoutineModal');
            modal.style.display = 'block';
            
            setTimeout(() => {
                const modalContent = modal.querySelector('.modal-content');
                if (modalContent) {
                    modalContent.style.animation = 'fadeInUp 0.3s ease-out';
                }
            }, 10);
        }

        function closeModal() {
            const modal = document.getElementById('addRoutineModal');
            const modalContent = modal.querySelector('.modal-content');
            
            if (modalContent) {
                modalContent.style.animation = 'fadeInUp 0.3s ease-out reverse';
            }
            
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }

        window.onclick = function(event) {
            const modal = document.getElementById('addRoutineModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // ë¡œê·¸ì•„ì›ƒ
        async function logout() {
            try {
                await auth.signOut();
                showNotification('ğŸ‘‹ ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (error) {
                console.error('ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', error);
                showNotification('ë¡œê·¸ì•„ì›ƒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // Google í”„ë¡œí•„ ìƒì„±
        async function createUserProfileFromGoogle(user, familyCode) {
            console.log('ğŸ†• Google í”„ë¡œí•„ ìƒì„± ì‹œì‘:', user.email);
            
            try {
                const userData = {
                    email: user.email,
                    displayName: user.displayName,
                    photoURL: user.photoURL,
                    role: userRole,
                    authProvider: 'google',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastActive: firebase.firestore.FieldValue.serverTimestamp()
                };

                if (userRole === 'parent') {
                    const newFamilyId = generateFamilyCode();
                    userData.familyId = newFamilyId;
                    userData.isParent = true;

                    await db.collection('families').doc(newFamilyId).set({
                        parentId: user.uid,
                        parentName: user.displayName || user.email.split('@')[0],
                        members: [user.uid],
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        familyCode: newFamilyId
                    });

                    setTimeout(() => {
                        const codeElement = document.getElementById('generatedFamilyCode');
                        const displayElement = document.getElementById('familyCodeDisplay');
                        if (codeElement && displayElement) {
                            codeElement.textContent = newFamilyId;
                            displayElement.classList.remove('hidden');
                            displayElement.style.display = 'block';
                        }
                        showNotification(`ğŸ”‘ ê°€ì¡± ì½”ë“œ: ${newFamilyId}`);
                    }, 1000);
                    
                } else if (familyCode) {
                    try {
                        const familyDoc = await db.collection('families').doc(familyCode).get();
                        
                        if (familyDoc.exists) {
                            userData.familyId = familyCode;
                            userData.isParent = false;

                            await db.collection('families').doc(familyCode).update({
                                members: firebase.firestore.FieldValue.arrayUnion(user.uid)
                            });
                            
                            showNotification(`ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ê°€ì¡±ì— ì°¸ì—¬í–ˆìŠµë‹ˆë‹¤! ì½”ë“œ: ${familyCode}`);
                        } else {
                            throw new Error('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê°€ì¡± ì½”ë“œì…ë‹ˆë‹¤. ë¶€ëª¨ë‹˜ê»˜ ì •í™•í•œ ì½”ë“œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
                        }
                    } catch (familyError) {
                        console.error('âŒ ê°€ì¡± ì°¸ì—¬ ì˜¤ë¥˜:', familyError);
                        
                        if (familyError.code === 'permission-denied') {
                            showNotification('âš ï¸ ê°€ì¡± ì°¸ì—¬ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
                        } else if (familyError.message.includes('ì¡´ì¬í•˜ì§€ ì•ŠëŠ”')) {
                            showNotification(familyError.message, 'error');
                        } else {
                            showNotification('ê°€ì¡± ì°¸ì—¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + familyError.message, 'error');
                        }
                        throw familyError;
                    }
                } else {
                    throw new Error('ìë…€ ê³„ì •ì€ ê°€ì¡± ì½”ë“œê°€ í•„ìš”í•©ë‹ˆë‹¤.');
                }

                await db.collection('users').doc(user.uid).set(userData);
                await createDefaultRoutines(user.uid, userData.familyId);
                
            } catch (error) {
                console.error('âŒ Google í”„ë¡œí•„ ìƒì„± ì˜¤ë¥˜:', error);
                if (error.code === 'permission-denied') {
                    showNotification('âš ï¸ Firebase ê¶Œí•œ ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
                }
                throw error;
            }
        }

        async function loadUserProfile() {
            console.log('ğŸ‘¤ ì‚¬ìš©ì í”„ë¡œí•„ ë¡œë“œ ì‹œì‘');
            
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    userRole = userData.role;
                    familyId = userData.familyId;
                    
                    const displayName = userData.displayName || currentUser.displayName || currentUser.email.split('@')[0];
                    const userEmailEl = document.getElementById('userEmail');
                    const userRoleEl = document.getElementById('userRole');
                    
                    if (userEmailEl) userEmailEl.textContent = displayName;
                    if (userRoleEl) userRoleEl.textContent = userRole === 'parent' ? 'ë¶€ëª¨' : 'ìë…€';
                    
                    if (userRole === 'parent' && familyId) {
                        try {
                            const familyDoc = await db.collection('families').doc(familyId).get();
                            if (familyDoc.exists) {
                                const familyData = familyDoc.data();
                                const familyCode = familyData.familyCode || familyId;
                                
                                const codeElement = document.getElementById('generatedFamilyCode');
                                const displayElement = document.getElementById('familyCodeDisplay');
                                
                                if (codeElement && displayElement) {
                                    codeElement.textContent = familyCode;
                                    displayElement.classList.remove('hidden');
                                    displayElement.style.display = 'block';
                                    
                                    showNotification(`ğŸ”‘ ê°€ì¡± ì½”ë“œ: ${familyCode} (ìë…€ì—ê²Œ ê³µìœ í•˜ì„¸ìš”!)`);
                                }
                            }
                        } catch (familyError) {
                            console.error('âŒ ê°€ì¡± ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', familyError);
                        }
                    }
                    
                    showNotification(`ì•ˆë…•í•˜ì„¸ìš”, ${displayName}ë‹˜! ğŸ‘‹`);
                } else {
                    showNotification('ì‚¬ìš©ì ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ê°€ì…í•´ì£¼ì„¸ìš”.', 'warning');
                    setTimeout(() => {
                        auth.signOut();
                    }, 2000);
                }
            } catch (error) {
                console.error('âŒ í”„ë¡œí•„ ë¡œë“œ ì˜¤ë¥˜:', error);
                if (error.code === 'permission-denied') {
                    showNotification('âš ï¸ Firebase ê¶Œí•œ ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
                } else {
                    showNotification('í”„ë¡œí•„ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
                }
            }
        }

        function startRealtimeListeners() {
            console.log('ğŸ”„ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì‹œì‘');
        }

        // ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ì— ë¦¬í”Œ íš¨ê³¼ ì¶”ê°€
        document.addEventListener('DOMContentLoaded', function() {
            document.addEventListener('click', function(e) {
                if (e.target.matches('.btn') || e.target.matches('.yes-btn') || e.target.matches('.no-btn')) {
                    addRippleEffect(e.target, e);
                }
            });
        });

        // DOM ë¡œë“œ ì™„ë£Œ í›„ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ“„ DOM ë¡œë“œ ì™„ë£Œ');
            updateCurrentDate();
            updateDailyQuote();
            
            setTimeout(() => {
                if (typeof firebase !== 'undefined') {
                    initializeFirebase();
                } else {
                    console.error('âŒ Firebase SDKê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                    setTimeout(initializeFirebase, 1000);
                }
            }, 100);
        });
    </script>
</body>
</html>