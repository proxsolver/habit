<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>가족 루틴 트래커</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <!-- 로그인 페이지 -->
        <div id="loginPage" class="login-page">
            <div class="login-form">
                <h1 class="app-title">🌅 루틴 트래커</h1>
                
                <!-- 역할 선택 -->
                <div class="role-selector">
                    <div class="role-btn active" onclick="selectRole('parent')">👨‍👩‍👧‍👦 부모</div>
                    <div class="role-btn" onclick="selectRole('child')">👶 자녀</div>
                </div>

                <!-- 가족 코드 입력 (자녀용) -->
                <div id="familyCodeInput" class="input-group family-code-input">
                    <label for="familyCode">가족 코드</label>
                    <input type="text" id="familyCode" placeholder="가족 코드를 입력하세요">
                </div>

                <!-- Google 로그인 버튼 -->
                <button class="btn google-btn" onclick="signInWithGoogle()">
                    <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google" class="google-icon">
                    Google로 시작하기
                </button>

                <!-- 구분선 -->
                <div class="divider">
                    <span>또는</span>
                </div>

                <!-- 이메일/비밀번호 로그인 (선택사항) -->
                <div class="email-login-section collapsed" id="emailLoginSection">
                    <div class="input-group">
                        <label for="email">이메일</label>
                        <input type="email" id="email" placeholder="your@email.com">
                    </div>
                    <div class="input-group">
                        <label for="password">비밀번호</label>
                        <input type="password" id="password" placeholder="비밀번호 입력">
                    </div>
                    <button class="btn" id="loginBtn" onclick="handleAuth('login')">로그인</button>
                    <button class="btn btn-secondary" onclick="handleAuth('register')">회원가입</button>
                </div>

                <button class="btn-text" onclick="toggleEmailLogin()">이메일로 로그인</button>

                <!-- 가족 코드 표시 (부모용 회원가입 후) -->
                <div id="familyCodeDisplay" class="family-code-display hidden">
                    <div>가족 코드</div>
                    <div class="family-code" id="generatedFamilyCode"></div>
                    <div style="font-size: 0.75rem; margin-top: 0.75rem; color: var(--text-secondary);">
                        자녀에게 이 코드를 알려주세요
                    </div>
                </div>
            </div>
        </div>

        <!-- 메인 앱 -->
        <div id="mainApp" class="main-app">
            <!-- 헤더 -->
            <div class="header">
                <div class="user-info">
                    <span id="userEmail"></span>
                    <span class="user-role" id="userRole"></span>
                    <button class="logout-btn" onclick="logout()">로그아웃</button>
                </div>
                <h1>오늘의 루틴</h1>
                <div id="currentDate"></div>
            </div>

            <!-- 메인 페이지 -->
            <div id="homePage" class="page">
                <!-- 수면 정보 -->
                <div class="sleep-info">
                    <div class="sleep-hours" id="sleepHours">-</div>
                    <div>어젯밤 수면시간</div>
                </div>

                <!-- 오늘의 명언 -->
                <div class="quote" id="dailyQuote">
                    "성공은 매일의 작은 노력들이 쌓여서 만들어진다."
                </div>

                <!-- 루틴 목록 -->
                <div class="routine-list" id="routineList">
                    <!-- 루틴 아이템들이 여기에 동적으로 추가됩니다 -->
                </div>
            </div>

            <!-- 가족 페이지 -->
            <div id="familyPage" class="page family-page">
                <div class="page-title">가족 루틴 현황</div>
                
                <!-- 가족 코드 표시 카드 (부모만) -->
                <div id="familyCodeCard" class="family-code-card hidden">
                    <div class="card-header">
                        <h3>👨‍👩‍👧‍👦 가족 코드</h3>
                        <div class="card-subtitle">자녀들이 가족에 참여할 때 필요한 코드입니다</div>
                    </div>
                    <div class="family-code-display-main">
                        <div class="family-code-large" id="familyCodeMain">-</div>
                        <button class="copy-btn" onclick="copyFamilyCode()">📋 복사</button>
                    </div>
                    <div class="family-info">
                        <div class="info-item">
                            <span class="info-label">가족 구성원:</span>
                            <span class="info-value" id="memberCount">-명</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">생성일:</span>
                            <span class="info-value" id="familyCreatedDate">-</span>
                        </div>
                    </div>
                </div>

                <!-- 가족 구성원 목록 -->
                <div id="familyMembers" class="family-members">
                    <!-- 가족 구성원들의 루틴 현황 -->
                </div>
            </div>

            <!-- 관리 페이지 -->
            <div id="managePage" class="page manage-page">
                <div class="page-title">루틴 관리</div>
                <button class="add-routine-btn" onclick="openAddRoutineModal()">✨ 새 루틴 추가</button>
                <div id="manageRoutineList">
                    <!-- 관리용 루틴 목록 -->
                </div>
            </div>

            <!-- 하단 네비게이션 -->
            <div class="bottom-nav">
                <div class="nav-item active" onclick="showPage('home')">
                    <i>🏠</i>
                    <span>홈</span>
                </div>
                <div class="nav-item" onclick="showPage('manage')">
                    <i>⚙️</i>
                    <span>관리</span>
                </div>
                <div class="nav-item" onclick="showPage('review')">
                    <i>📊</i>
                    <span>리뷰</span>
                </div>
                <div class="nav-item" onclick="showPage('stats')">
                    <i>📈</i>
                    <span>통계</span>
                </div>
                <div class="nav-item" onclick="showPage('family')">
                    <i>👨‍👩‍👧‍👦</i>
                    <span>가족</span>
                </div>
            </div>
        </div>

        <!-- 루틴 추가 모달 -->
        <div id="addRoutineModal" class="modal">
            <div class="modal-content">
                <button class="close-btn" onclick="closeModal()">&times;</button>
                <div class="modal-header">✨ 새 루틴 추가</div>
                
                <div class="form-group">
                    <label for="routineName">루틴 이름</label>
                    <input type="text" id="routineName" placeholder="루틴 이름을 입력하세요">
                </div>

                <div class="form-group">
                    <label for="routineType">루틴 타입</label>
                    <select id="routineType">
                        <option value="yesno">예/아니오</option>
                        <option value="number">숫자 입력</option>
                        <option value="time">시간 입력</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="routineTime">시점</label>
                    <select id="routineTime">
                        <option value="morning">🌅 아침</option>
                        <option value="afternoon">🌞 점심</option>
                        <option value="evening">🌙 저녁</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="routineFreq">주기</label>
                    <select id="routineFreq">
                        <option value="daily">매일</option>
                        <option value="weekday">평일</option>
                        <option value="weekend">주말</option>
                    </select>
                </div>

                <div class="btn-group">
                    <button class="btn btn-cancel" onclick="closeModal()">취소</button>
                    <button class="btn" onclick="addRoutine()">추가</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <!-- JavaScript 코드 -->
    <script>
        // Firebase 설정
        const firebaseConfig = {
            apiKey: "AIzaSyC6bvEaHsxpLtPv5zM99PmgAwOnRXnhkBM",
            authDomain: "habit-dc62a.firebaseapp.com",
            projectId: "habit-dc62a",
            storageBucket: "habit-dc62a.firebasestorage.app",
            messagingSenderId: "668374525477",
            appId: "1:668374525477:web:ecbecd95ec631fb82cc1cc"
        };

        // 전역 변수
        let currentUser = null;
        let userRole = 'parent';
        let familyId = null;
        let routines = [];
        let familyMembers = [];
        let auth, db;

        // 기본 명언들
        const quotes = [
            "성공은 매일의 작은 노력들이 쌓여서 만들어진다.",
            "오늘 하루도 최선을 다하는 하루가 되길.",
            "작은 습관이 큰 변화를 만든다.",
            "꾸준함이 천재를 이긴다.",
            "매일 조금씩 나아지는 것이 중요하다.",
            "목표를 향한 첫 걸음이 가장 중요하다.",
            "완벽하지 않아도 시작하는 것이 중요하다.",
            "오늘의 나는 어제의 나보다 조금 더 나은 사람이다.",
            "루틴은 꿈을 현실로 만드는 다리다.",
            "작은 실천이 큰 기적을 만든다."
        ];

        // Firebase 초기화
        function initializeFirebase() {
            try {
                console.log('🔥 Firebase 초기화 시작...');
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                
                console.log('✅ Firebase 초기화 성공!');
                console.log('🔥 Auth:', auth);
                console.log('🗃️ DB:', db);
                
                // 인증 상태 변경 감지
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        currentUser = user;
                        await loadUserProfile();
                        showMainApp();
                        startRealtimeListeners();
                    } else {
                        currentUser = null;
                        showLoginPage();
                    }
                });
                
                return true;
            } catch (error) {
                console.error('❌ Firebase 초기화 실패:', error);
                return false;
            }
        }

        // 애니메이션 트리거 함수들
        function triggerAnimation(element, animationClass) {
            element.classList.add(animationClass);
            setTimeout(() => {
                element.classList.remove(animationClass);
            }, 600);
        }

        function addRippleEffect(button, event) {
            const ripple = document.createElement('span');
            const rect = button.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            const x = event.clientX - rect.left - size / 2;
            const y = event.clientY - rect.top - size / 2;
            
            ripple.style.width = ripple.style.height = size + 'px';
            ripple.style.left = x + 'px';
            ripple.style.top = y + 'px';
            ripple.classList.add('ripple');
            
            button.appendChild(ripple);
            
            setTimeout(() => {
                ripple.remove();
            }, 600);
        }

        // 역할 선택
        function selectRole(role) {
            userRole = role;
            document.querySelectorAll('.role-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const familyCodeInput = document.getElementById('familyCodeInput');
            if (role === 'child') {
                familyCodeInput.style.display = 'block';
                familyCodeInput.style.animation = 'fadeInUp 0.3s ease-out';
            } else {
                familyCodeInput.style.display = 'none';
            }
        }

        // Google 로그인
        async function signInWithGoogle() {
            const familyCode = document.getElementById('familyCode').value;
            
            if (userRole === 'child' && !familyCode) {
                showNotification('자녀는 가족 코드를 먼저 입력해주세요.', 'error');
                return;
            }

            if (!auth) {
                showNotification('Firebase가 아직 로드되지 않았습니다. 잠시 후 다시 시도해주세요.', 'error');
                return;
            }

            setLoading(true, 'google');
            
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                provider.addScope('email');
                provider.addScope('profile');
                
                const result = await auth.signInWithPopup(provider);
                const user = result.user;
                
                console.log('✅ Google 로그인 성공:', user.email);
                
                // 기존 사용자인지 확인
                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    
                    if (!userDoc.exists) {
                        console.log('🆕 새 사용자 - 프로필 생성 시작');
                        // 새 사용자라면 프로필 생성
                        await createUserProfileFromGoogle(user, familyCode);
                        showNotification('Google 계정으로 성공적으로 가입되었습니다! 🎉');
                    } else {
                        console.log('👤 기존 사용자 - 로그인 완료');
                        // 기존 사용자라면 로그인
                        showNotification('Google 계정으로 로그인되었습니다! 👋');
                    }
                } catch (permissionError) {
                    if (permissionError.code === 'permission-denied') {
                        console.log('⚠️ 권한 오류 - 새 사용자로 처리');
                        // 권한 오류라면 새 사용자로 간주하고 프로필 생성
                        await createUserProfileFromGoogle(user, familyCode);
                        showNotification('새 계정이 생성되었습니다! 🎉');
                    } else {
                        throw permissionError;
                    }
                }
                
            } catch (error) {
                console.error('Google 로그인 오류:', error);
                
                if (error.code === 'auth/popup-closed-by-user') {
                    showNotification('로그인이 취소되었습니다.', 'error');
                } else if (error.code === 'auth/popup-blocked') {
                    showNotification('팝업이 차단되었습니다. 팝업을 허용해주세요.', 'error');
                } else if (error.code === 'permission-denied') {
                    showNotification('⚠️ Firebase 권한 설정을 확인해주세요. Firestore 보안 규칙을 업데이트하세요.', 'error');
                } else {
                    showNotification('Google 로그인에 실패했습니다: ' + error.message, 'error');
                }
            } finally {
                setLoading(false, 'google');
            }
        }

        // 이메일 로그인 토글
        function toggleEmailLogin() {
            const section = document.getElementById('emailLoginSection');
            const button = event.target;
            
            if (section.classList.contains('collapsed')) {
                section.classList.remove('collapsed');
                button.textContent = '간편 로그인으로 돌아가기';
            } else {
                section.classList.add('collapsed');
                button.textContent = '이메일로 로그인';
            }
        }

        // 유틸리티 함수들
        function generateFamilyCode() {
            return Math.random().toString(36).substr(2, 8).toUpperCase();
        }

        function showNotification(message, type = 'success') {
            // 기존 알림 제거
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            // 자동 제거
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease-out forwards';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }, 4000);
        }

        function setLoading(loading, type = 'email') {
            if (type === 'google') {
                const googleBtn = document.querySelector('.google-btn');
                if (googleBtn) {
                    if (loading) {
                        googleBtn.disabled = true;
                        googleBtn.innerHTML = `
                            <div style="width: 20px; height: 20px; border: 2px solid #f3f3f3; border-top: 2px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                            Google 로그인 중...
                        `;
                    } else {
                        googleBtn.disabled = false;
                        googleBtn.innerHTML = `
                            <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google" class="google-icon">
                            Google로 시작하기
                        `;
                    }
                }
            }
        }

        function showLoginPage() {
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
        }

        function showMainApp() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            // 메인 앱 표시 시 애니메이션
            const mainApp = document.getElementById('mainApp');
            mainApp.style.animation = 'fadeInUp 0.6s ease-out';
        }

        // 현재 날짜 업데이트
        function updateCurrentDate() {
            const today = new Date();
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                weekday: 'long'
            };
            document.getElementById('currentDate').textContent = 
                today.toLocaleDateString('ko-KR', options);
        }

        // 일일 명언 업데이트
        function updateDailyQuote() {
            const today = new Date();
            const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
            const quoteIndex = dayOfYear % quotes.length;
            document.getElementById('dailyQuote').textContent = quotes[quoteIndex];
        }

        // 페이지 전환
        function showPage(page) {
            // 모든 페이지 숨기기
            document.querySelectorAll('.page').forEach(p => {
                p.style.display = 'none';
            });
            
            // 모든 네비게이션 항목 비활성화
            document.querySelectorAll('.nav-item').forEach(nav => {
                nav.classList.remove('active');
            });
            
            // 선택된 페이지 및 네비게이션 활성화
            if (page === 'home') {
                document.getElementById('homePage').style.display = 'block';
                document.querySelectorAll('.nav-item')[0].classList.add('active');
            } else if (page === 'manage') {
                document.getElementById('managePage').style.display = 'block';
                document.querySelectorAll('.nav-item')[1].classList.add('active');
                loadUserRoutines();
            } else if (page === 'family') {
                document.getElementById('familyPage').style.display = 'block';
                document.querySelectorAll('.nav-item')[4].classList.add('active');
                loadFamilyPageInfo();
            } else if (page === 'review') {
                showNotification('📊 리뷰 페이지는 곧 준비됩니다!', 'warning');
            } else if (page === 'stats') {
                showNotification('📈 통계 페이지는 곧 준비됩니다!', 'warning');
            }

            // 페이지 전환 애니메이션
            const activePage = document.querySelector('.page[style*="block"]');
            if (activePage) {
                activePage.style.animation = 'fadeInUp 0.4s ease-out';
            }
        }

        // 가족 페이지 정보 로드
        async function loadFamilyPageInfo() {
            console.log('👨‍👩‍👧‍👦 가족 페이지 정보 로드');
            
            if (!currentUser || !familyId) {
                console.log('❌ 사용자 또는 가족 정보가 없습니다');
                return;
            }

            try {
                // 부모인 경우 가족 코드 카드 표시
                if (userRole === 'parent') {
                    const familyDoc = await db.collection('families').doc(familyId).get();
                    if (familyDoc.exists) {
                        const familyData = familyDoc.data();
                        const familyCode = familyData.familyCode || familyId;
                        const memberCount = familyData.members ? familyData.members.length : 1;
                        const createdDate = familyData.createdAt ? familyData.createdAt.toDate().toLocaleDateString('ko-KR') : '-';
                        
                        console.log('📋 가족 정보:', { familyCode, memberCount, createdDate });
                        
                        // 가족 코드 카드 표시
                        const familyCodeCard = document.getElementById('familyCodeCard');
                        const familyCodeMain = document.getElementById('familyCodeMain');
                        const memberCountEl = document.getElementById('memberCount');
                        const familyCreatedDateEl = document.getElementById('familyCreatedDate');
                        
                        if (familyCodeCard && familyCodeMain) {
                            familyCodeMain.textContent = familyCode;
                            if (memberCountEl) memberCountEl.textContent = `${memberCount}명`;
                            if (familyCreatedDateEl) familyCreatedDateEl.textContent = createdDate;
                            
                            familyCodeCard.classList.remove('hidden');
                            familyCodeCard.style.display = 'block';
                            
                            console.log('✅ 가족 코드 카드 표시 완료');
                        }
                        
                        // 전역 변수에 저장 (복사 기능용)
                        window.currentFamilyCode = familyCode;
                    }
                } else {
                    // 자녀인 경우 가족 코드 카드 숨기기
                    const familyCodeCard = document.getElementById('familyCodeCard');
                    if (familyCodeCard) {
                        familyCodeCard.classList.add('hidden');
                        familyCodeCard.style.display = 'none';
                    }
                }
                
                // 가족 구성원 정보 로드
                await loadFamilyMembers();
                
            } catch (error) {
                console.error('❌ 가족 페이지 정보 로드 오류:', error);
            }
        }

        // 가족 구성원 로드
        async function loadFamilyMembers() {
            if (!familyId) return;

            try {
                const familyDoc = await db.collection('families').doc(familyId).get();
                if (!familyDoc.exists) return;

                const familyData = familyDoc.data();
                const memberIds = familyData.members || [];

                const familyMembersContainer = document.getElementById('familyMembers');
                familyMembersContainer.innerHTML = '';

                for (const memberId of memberIds) {
                    const memberDoc = await db.collection('users').doc(memberId).get();
                    if (memberDoc.exists) {
                        const memberData = memberDoc.data();
                        const memberCard = createMemberCard(memberData, memberId);
                        familyMembersContainer.appendChild(memberCard);
                    }
                }
            } catch (error) {
                console.error('❌ 가족 구성원 로드 오류:', error);
            }
        }

        // 가족 구성원 카드 생성
        function createMemberCard(memberData, memberId) {
            const card = document.createElement('div');
            card.className = 'member-card';
            
            const displayName = memberData.displayName || memberData.email.split('@')[0];
            const role = memberData.role === 'parent' ? '부모' : '자녀';
            const isOnline = memberId === currentUser?.uid;
            
            card.innerHTML = `
                <div class="member-header">
                    <div class="member-info">
                        <div class="member-name">${displayName}</div>
                        <div class="member-role">${role}</div>
                    </div>
                    <div class="member-status ${isOnline ? 'online' : 'offline'}">
                        ${isOnline ? 'ONLINE' : 'OFFLINE'}
                    </div>
                </div>
                <div class="routine-progress">
                    <div class="routine-badge completed">운동 완료</div>
                    <div class="routine-badge pending">물마시기 대기</div>
                    <div class="routine-badge completed">수면시간 기록</div>
                </div>
            `;
            
            return card;
        }

        // 가족 코드 복사
        async function copyFamilyCode() {
            const familyCode = window.currentFamilyCode || document.getElementById('familyCodeMain').textContent;
            
            if (!familyCode || familyCode === '-') {
                showNotification('복사할 가족 코드가 없습니다.', 'error');
                return;
            }
            
            try {
                await navigator.clipboard.writeText(familyCode);
                showNotification(`🎉 가족 코드 "${familyCode}"가 클립보드에 복사되었습니다!`);
                
                // 버튼 애니메이션
                const copyBtn = document.querySelector('.copy-btn');
                if (copyBtn) {
                    const originalText = copyBtn.textContent;
                    copyBtn.textContent = '✅ 복사됨!';
                    copyBtn.style.background = 'rgba(16, 185, 129, 0.3)';
                    
                    setTimeout(() => {
                        copyBtn.textContent = originalText;
                        copyBtn.style.background = 'rgba(255, 255, 255, 0.2)';
                    }, 2000);
                }
                
            } catch (error) {
                console.error('클립보드 복사 실패:', error);
                
                // 폴백: 텍스트 선택
                const codeElement = document.getElementById('familyCodeMain');
                if (codeElement) {
                    const range = document.createRange();
                    range.selectNode(codeElement);
                    window.getSelection().removeAllRanges();
                    window.getSelection().addRange(range);
                    showNotification('가족 코드가 선택되었습니다. Ctrl+C로 복사하세요!');
                }
            }
        }

        // 인증 처리 (이메일/비밀번호)
        async function handleAuth(type) {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const familyCode = document.getElementById('familyCode').value;

            if (!email || !password) {
                showNotification('이메일과 비밀번호를 입력해주세요.', 'error');
                return;
            }

            if (userRole === 'child' && type === 'register' && !familyCode) {
                showNotification('가족 코드를 입력해주세요.', 'error');
                return;
            }

            try {
                let userCredential;
                
                if (type === 'login') {
                    userCredential = await auth.signInWithEmailAndPassword(email, password);
                } else {
                    userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    await createUserProfile(userCredential.user, familyCode);
                }

                showNotification('✨ 성공적으로 ' + (type === 'login' ? '로그인' : '회원가입') + '되었습니다!');
                
            } catch (error) {
                console.error('인증 오류:', error);
                showNotification('오류가 발생했습니다: ' + error.message, 'error');
            }
        }

        // 사용자 프로필 생성
        async function createUserProfile(user, familyCode = null) {
            const userData = {
                email: user.email,
                role: userRole,
                authProvider: 'email',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                lastActive: firebase.firestore.FieldValue.serverTimestamp()
            };

            if (userRole === 'parent') {
                const newFamilyId = generateFamilyCode();
                userData.familyId = newFamilyId;
                userData.isParent = true;

                await db.collection('families').doc(newFamilyId).set({
                    parentId: user.uid,
                    parentName: user.email.split('@')[0],
                    members: [user.uid],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    familyCode: newFamilyId
                });

                // 가족 코드 표시
                setTimeout(() => {
                    document.getElementById('generatedFamilyCode').textContent = newFamilyId;
                    document.getElementById('familyCodeDisplay').classList.remove('hidden');
                    showNotification(`🔑 가족 코드가 생성되었습니다: ${newFamilyId}`);
                }, 1000);
                
            } else {
                if (familyCode) {
                    const familyDoc = await db.collection('families').doc(familyCode).get();
                    if (familyDoc.exists) {
                        userData.familyId = familyCode;
                        userData.isParent = false;

                        await db.collection('families').doc(familyCode).update({
                            members: firebase.firestore.FieldValue.arrayUnion(user.uid)
                        });
                    } else {
                        throw new Error('존재하지 않는 가족 코드입니다.');
                    }
                }
            }

            await db.collection('users').doc(user.uid).set(userData);
            await createDefaultRoutines(user.uid, userData.familyId);
        }

        // 기본 루틴 생성
        async function createDefaultRoutines(userId, familyId) {
            const defaultRoutines = [
                { name: '🌙 취침 시간', type: 'time', time: 'evening', frequency: 'daily', order: 1 },
                { name: '🌅 기상 시간', type: 'time', time: 'morning', frequency: 'daily', order: 2 },
                { name: '💪 운동하기', type: 'yesno', time: 'morning', frequency: 'daily', order: 3 },
                { name: '💧 물 마시기 (잔)', type: 'number', time: 'evening', frequency: 'daily', order: 4 }
            ];

            const batch = db.batch();
            defaultRoutines.forEach((routine) => {
                const routineRef = db.collection('routines').doc();
                batch.set(routineRef, {
                    ...routine,
                    userId: userId,
                    familyId: familyId,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            });

            await batch.commit();
        }

        // 루틴 업데이트
        async function updateRoutine(routineId, value) {
            if (!currentUser) return;
            
            const today = new Date().toISOString().split('T')[0];
            const logData = {
                routineId: routineId,
                userId: currentUser.uid,
                familyId: familyId,
                value: value,
                completed: true,
                date: today,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection('routine_logs').doc(`${routineId}_${currentUser.uid}_${today}`).set(logData);
                showNotification('✅ 루틴이 업데이트되었습니다!');
                
                // 성공 애니메이션 효과
                const targetElement = event.target;
                if (targetElement.classList.contains('yes-btn') || targetElement.classList.contains('no-btn')) {
                    triggerAnimation(targetElement, 'bounce');
                }
            } catch (error) {
                console.error('루틴 업데이트 오류:', error);
                showNotification('루틴 업데이트에 실패했습니다.', 'error');
            }
        }

        // 루틴 추가
        async function addRoutine() {
            console.log('🔧 루틴 추가 시작');
            
            if (!currentUser) {
                showNotification('로그인이 필요합니다.', 'error');
                return;
            }
            
            if (!familyId) {
                console.log('🔄 가족 ID가 없어서 프로필 재로드 시도...');
                try {
                    await loadUserProfile();
                } catch (error) {
                    console.error('❌ 프로필 재로드 실패:', error);
                }
            }
            
            const nameInput = document.getElementById('routineName');
            const typeInput = document.getElementById('routineType');
            const timeInput = document.getElementById('routineTime');
            const freqInput = document.getElementById('routineFreq');
            
            if (!nameInput) {
                console.error('❌ 루틴 이름 입력 필드를 찾을 수 없습니다');
                showNotification('입력 필드를 찾을 수 없습니다.', 'error');
                return;
            }
            
            const name = nameInput.value;
            const type = typeInput ? typeInput.value : 'yesno';
            const time = timeInput ? timeInput.value : 'morning';
            const frequency = freqInput ? freqInput.value : 'daily';
            
            if (!name.trim()) {
                showNotification('루틴 이름을 입력해주세요.', 'error');
                return;
            }

            let userFamilyId = familyId;
            if (!userFamilyId) {
                try {
                    const userDoc = await db.collection('users').doc(currentUser.uid).get();
                    if (userDoc.exists) {
                        userFamilyId = userDoc.data().familyId;
                        familyId = userFamilyId;
                        console.log('✅ familyId 재조회 성공:', userFamilyId);
                    }
                } catch (error) {
                    console.error('❌ familyId 조회 실패:', error);
                    if (error.code === 'permission-denied') {
                        showNotification('⚠️ Firebase 권한 설정을 확인해주세요. Firestore 보안 규칙을 업데이트하세요.', 'error');
                        return;
                    }
                }
            }

            if (!userFamilyId) {
                showNotification('가족 정보를 찾을 수 없습니다. 다시 로그인해주세요.', 'error');
                return;
            }

            try {
                const routineData = {
                    name: name.trim(),
                    type: type,
                    time: time,
                    frequency: frequency,
                    order: Date.now(),
                    userId: currentUser.uid,
                    familyId: userFamilyId,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                console.log('💾 저장할 루틴 데이터:', routineData);
                console.log('🔑 현재 사용자 UID:', currentUser.uid);
                console.log('👨‍👩‍👧‍👦 가족 ID:', userFamilyId);
                console.log('🔐 Auth 상태:', currentUser ? '인증됨' : '인증안됨');
                
                // 테스트용 간단한 데이터 먼저 시도
                console.log('🧪 테스트 데이터 저장 시도...');
                const testDoc = await db.collection('test').add({
                    message: 'Hello World',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    userId: currentUser.uid
                });
                console.log('✅ 테스트 데이터 저장 성공:', testDoc.id);
                
                // 실제 루틴 데이터 저장
                console.log('💾 실제 루틴 데이터 저장 시도...');
                const docRef = await db.collection('routines').add(routineData);
                console.log('✅ Firestore에 저장 완료! 문서 ID:', docRef.id);
                
                showNotification(`✨ 새 루틴 "${name}"이 추가되었습니다!`);
                closeModal();
                nameInput.value = '';
                
                // 관리 페이지 새로고침
                setTimeout(() => {
                    loadUserRoutines();
                }, 500);
                
            } catch (error) {
                console.error('❌ 루틴 추가 오류:', error);
                if (error.code === 'permission-denied') {
                    showNotification('⚠️ Firebase 권한 설정을 확인해주세요. Firestore 보안 규칙을 업데이트하세요.', 'error');
                } else {
                    showNotification('루틴 추가에 실패했습니다: ' + error.message, 'error');
                }
            }
        }

        // 사용자 루틴 로드 (관리 페이지용)
        async function loadUserRoutines() {
            if (!currentUser || !familyId) {
                console.log('❌ 루틴 로드 조건 불충족');
                return;
            }
            
            try {
                console.log('📋 루틴 목록 로드 시작...');
                
                const routinesSnapshot = await db.collection('routines')
                    .where('userId', '==', currentUser.uid)
                    .where('familyId', '==', familyId)
                    .get();

                console.log('📊 조회된 루틴 수:', routinesSnapshot.size);

                const manageList = document.getElementById('manageRoutineList');
                if (!manageList) {
                    console.error('❌ 관리 목록 DOM 요소를 찾을 수 없습니다');
                    return;
                }
                
                manageList.innerHTML = '';

                if (routinesSnapshot.empty) {
                    manageList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">📝</div>
                            <div class="empty-state-title">아직 추가된 루틴이 없습니다</div>
                            <div class="empty-state-description">위의 버튼을 눌러 첫 번째 루틴을 추가해보세요!</div>
                        </div>
                    `;
                    return;
                }

                // 시간 순으로 정렬
                const routines = [];
                routinesSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    routines.push({
                        id: doc.id,
                        ...data,
                        createdAt: data.createdAt?.toDate() || new Date()
                    });
                });

                routines.sort((a, b) => b.createdAt.getTime() - a.createdAt.getTime());

                routines.forEach((routine, index) => {
                    const routineEl = document.createElement('div');
                    routineEl.className = 'routine-item';
                    routineEl.style.animationDelay = `${index * 0.1}s`;
                    
                    const typeMap = {
                        'yesno': '예/아니오',
                        'number': '숫자 입력',
                        'time': '시간 입력'
                    };
                    
                    const timeMap = {
                        'morning': '🌅 아침',
                        'afternoon': '🌞 점심',
                        'evening': '🌙 저녁'
                    };
                    
                    const freqMap = {
                        'daily': '매일',
                        'weekday': '평일',
                        'weekend': '주말'
                    };
                    
                    routineEl.innerHTML = `
                        <div class="routine-title">${routine.name}</div>
                        <div style="font-size: 0.875rem; color: var(--text-secondary); margin: 0.75rem 0;">
                            <span style="background: rgba(99, 102, 241, 0.1); color: var(--primary); padding: 0.25rem 0.5rem; border-radius: 0.5rem; margin-right: 0.5rem; font-weight: 600;">${typeMap[routine.type]}</span>
                            <span style="background: rgba(236, 72, 153, 0.1); color: var(--secondary); padding: 0.25rem 0.5rem; border-radius: 0.5rem; margin-right: 0.5rem; font-weight: 600;">${timeMap[routine.time]}</span>
                            <span style="background: rgba(16, 185, 129, 0.1); color: var(--success); padding: 0.25rem 0.5rem; border-radius: 0.5rem; font-weight: 600;">${freqMap[routine.frequency]}</span>
                        </div>
                        <div style="font-size: 0.75rem; color: var(--gray-400);">
                            생성일: ${routine.createdAt.toLocaleDateString('ko-KR')}
                        </div>
                    `;
                    manageList.appendChild(routineEl);
                });

                console.log('✅ 루틴 목록 렌더링 완료');
                
            } catch (error) {
                console.error('❌ 루틴 로드 오류:', error);
                
                const manageList = document.getElementById('manageRoutineList');
                if (manageList) {
                    manageList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">⚠️</div>
                            <div class="empty-state-title">루틴 목록을 불러오는데 실패했습니다</div>
                        </div>
                    `;
                }
            }
        }

        // 모달 관련
        function openAddRoutineModal() {
            const modal = document.getElementById('addRoutineModal');
            modal.style.display = 'block';
            
            // 모달 애니메이션
            setTimeout(() => {
                const modalContent = modal.querySelector('.modal-content');
                if (modalContent) {
                    modalContent.style.animation = 'fadeInUp 0.3s ease-out';
                }
            }, 10);
        }

        function closeModal() {
            const modal = document.getElementById('addRoutineModal');
            const modalContent = modal.querySelector('.modal-content');
            
            if (modalContent) {
                modalContent.style.animation = 'fadeInUp 0.3s ease-out reverse';
            }
            
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }

        // 모달 외부 클릭 시 닫기
        window.onclick = function(event) {
            const modal = document.getElementById('addRoutineModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // 로그아웃
        async function logout() {
            try {
                await auth.signOut();
                showNotification('👋 로그아웃되었습니다.');
            } catch (error) {
                console.error('로그아웃 오류:', error);
                showNotification('로그아웃에 실패했습니다.', 'error');
            }
        }

        // Google 프로필 생성
        async function createUserProfileFromGoogle(user, familyCode) {
            console.log('🆕 Google 프로필 생성 시작:', user.email);
            
            try {
                const userData = {
                    email: user.email,
                    displayName: user.displayName,
                    photoURL: user.photoURL,
                    role: userRole,
                    authProvider: 'google',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastActive: firebase.firestore.FieldValue.serverTimestamp()
                };

                if (userRole === 'parent') {
                    const newFamilyId = generateFamilyCode();
                    userData.familyId = newFamilyId;
                    userData.isParent = true;

                    console.log('👨‍👩‍👧‍👦 부모 계정 - 가족 생성:', newFamilyId);

                    // 가족 문서 생성
                    await db.collection('families').doc(newFamilyId).set({
                        parentId: user.uid,
                        parentName: user.displayName || user.email.split('@')[0],
                        members: [user.uid],
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        familyCode: newFamilyId
                    });

                    // 가족 코드 표시
                    setTimeout(() => {
                        const codeElement = document.getElementById('generatedFamilyCode');
                        const displayElement = document.getElementById('familyCodeDisplay');
                        if (codeElement && displayElement) {
                            codeElement.textContent = newFamilyId;
                            displayElement.classList.remove('hidden');
                            displayElement.style.display = 'block';
                            console.log('✅ 가족 코드 UI 업데이트 완료');
                        }
                        showNotification(`🔑 가족 코드: ${newFamilyId}`);
                    }, 1000);
                    
                } else if (familyCode) {
                    console.log('👶 자녀 계정 - 가족 참여 시도:', familyCode);
                    
                    try {
                        // 가족 코드로 가족 문서 조회
                        console.log('🔍 가족 문서 조회 중...');
                        const familyDoc = await db.collection('families').doc(familyCode).get();
                        
                        if (familyDoc.exists) {
                            const familyData = familyDoc.data();
                            console.log('✅ 가족 문서 발견:', familyData);
                            
                            userData.familyId = familyCode;
                            userData.isParent = false;

                            // 가족에 구성원 추가
                            console.log('👨‍👩‍👧‍👦 가족에 구성원 추가 중...');
                            await db.collection('families').doc(familyCode).update({
                                members: firebase.firestore.FieldValue.arrayUnion(user.uid)
                            });
                            
                            console.log('✅ 가족 참여 완료!');
                            showNotification(`👨‍👩‍👧‍👦 가족에 참여했습니다! 코드: ${familyCode}`);
                        } else {
                            console.log('❌ 가족 문서가 존재하지 않음');
                            throw new Error('존재하지 않는 가족 코드입니다. 부모님께 정확한 코드를 확인해주세요.');
                        }
                    } catch (familyError) {
                        console.error('❌ 가족 참여 오류:', familyError);
                        
                        if (familyError.code === 'permission-denied') {
                            showNotification('⚠️ 가족 참여 권한이 없습니다. Firebase Firestore 보안 규칙을 다음과 같이 수정해주세요:\n\nmatch /families/{familyId} {\n  allow read: if request.auth != null;\n  allow write: if request.auth != null;\n}', 'error');
                        } else if (familyError.message.includes('존재하지 않는')) {
                            showNotification(familyError.message, 'error');
                        } else {
                            showNotification('가족 참여에 실패했습니다: ' + familyError.message, 'error');
                        }
                        throw familyError;
                    }
                } else {
                    console.log('❌ 자녀 계정인데 가족 코드가 없음');
                    throw new Error('자녀 계정은 가족 코드가 필요합니다.');
                }

                // 사용자 문서 생성
                await db.collection('users').doc(user.uid).set(userData);
                console.log('✅ 사용자 문서 생성 완료');
                
                // 기본 루틴 생성
                await createDefaultRoutines(user.uid, userData.familyId);
                console.log('✅ 기본 루틴 생성 완료');
                
            } catch (error) {
                console.error('❌ Google 프로필 생성 오류:', error);
                if (error.code === 'permission-denied') {
                    showNotification('⚠️ Firebase 권한 설정을 확인해주세요. Firestore 보안 규칙을 업데이트하세요.', 'error');
                }
                throw error;
            }
        }

        async function loadUserProfile() {
            console.log('👤 사용자 프로필 로드 시작');
            
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    userRole = userData.role;
                    familyId = userData.familyId;
                    
                    console.log('👤 사용자 데이터:', userData);
                    console.log('🔑 가족 ID:', familyId);
                    console.log('👥 사용자 역할:', userRole);
                    
                    const displayName = userData.displayName || currentUser.displayName || currentUser.email.split('@')[0];
                    const userEmailEl = document.getElementById('userEmail');
                    const userRoleEl = document.getElementById('userRole');
                    
                    if (userEmailEl) userEmailEl.textContent = displayName;
                    if (userRoleEl) userRoleEl.textContent = userRole === 'parent' ? '부모' : '자녀';
                    
                    // 부모인 경우 가족 코드 확인
                    if (userRole === 'parent' && familyId) {
                        console.log('👨‍👩‍👧‍👦 부모 계정 - 가족 코드 찾는 중...');
                        
                        try {
                            const familyDoc = await db.collection('families').doc(familyId).get();
                            if (familyDoc.exists) {
                                const familyData = familyDoc.data();
                                const familyCode = familyData.familyCode || familyId;
                                
                                console.log('🔑 가족 코드 발견:', familyCode);
                                
                                const codeElement = document.getElementById('generatedFamilyCode');
                                const displayElement = document.getElementById('familyCodeDisplay');
                                
                                if (codeElement && displayElement) {
                                    codeElement.textContent = familyCode;
                                    displayElement.classList.remove('hidden');
                                    displayElement.style.display = 'block';
                                    console.log('✅ 가족 코드 표시 완료!');
                                    
                                    showNotification(`🔑 가족 코드: ${familyCode} (자녀에게 공유하세요!)`);
                                }
                            }
                        } catch (familyError) {
                            console.error('❌ 가족 정보 로드 오류:', familyError);
                        }
                    }
                    
                    if (familyId) {
                        console.log('✅ familyId 설정 완료:', familyId);
                    } else {
                        console.error('❌ familyId가 여전히 null입니다!');
                    }
                    
                    showNotification(`안녕하세요, ${displayName}님! 👋`);
                } else {
                    console.log('❌ 사용자 문서가 존재하지 않습니다 - 새 사용자일 수 있습니다');
                    // 새 사용자라면 로그아웃하여 다시 가입 프로세스 진행
                    showNotification('사용자 정보가 없습니다. 다시 가입해주세요.', 'warning');
                    setTimeout(() => {
                        auth.signOut();
                    }, 2000);
                }
            } catch (error) {
                console.error('❌ 프로필 로드 오류:', error);
                if (error.code === 'permission-denied') {
                    showNotification('⚠️ Firebase 권한 설정을 확인해주세요. Firestore 보안 규칙을 업데이트하세요.', 'error');
                } else {
                    showNotification('프로필 로드에 실패했습니다: ' + error.message, 'error');
                }
            }
        }

        function startRealtimeListeners() {
            console.log('🔄 실시간 리스너 시작');
        }

        // 버튼 클릭 이벤트에 리플 효과 추가
        document.addEventListener('DOMContentLoaded', function() {
            document.addEventListener('click', function(e) {
                if (e.target.matches('.btn') || e.target.matches('.yes-btn') || e.target.matches('.no-btn')) {
                    addRippleEffect(e.target, e);
                }
            });
        });

        // DOM 로드 완료 후 초기화
        document.addEventListener('DOMContentLoaded', function() {
            console.log('📄 DOM 로드 완료');
            updateCurrentDate();
            updateDailyQuote();
            
            // Firebase 초기화 시도
            setTimeout(() => {
                if (typeof firebase !== 'undefined') {
                    initializeFirebase();
                } else {
                    console.error('❌ Firebase SDK가 로드되지 않았습니다.');
                    setTimeout(initializeFirebase, 1000);
                }
            }, 100);
        });
    </script>
</body>
</html>